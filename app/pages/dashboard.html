<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="css/theme.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VNStock Analytics - Main Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1/dist/chartjs-chart-financial.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f8fafc;
            color: #333333;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        /* Sticky Navigation */
        .top-nav {
            position: sticky;
            top: 0;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            z-index: 1000;
            
        }

        .nav-container {
            max-width: 1360px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 72px;
            gap: 16px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-text {
            font-size: 1.3em;
            font-weight: 700;
            color: #c41c16;
            text-decoration: none;
        }

        .page-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #64748b;
            border-left: 2px solid #e5e7eb;
            padding-left: 16px;
        }

        .nav-menu {
            position: relative;
        }

        .menu-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #c41c16;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
        }

        .menu-btn:hover {
            background: #991b1b;
            transform: translateY(-1px);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            
            min-width: 280px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s;
            z-index: 1001;
        }

        .dropdown-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .menu-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 700;
            color: #1e293b;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .menu-category {
            padding: 12px 20px 8px;
            font-weight: 700;
            color: #64748b;
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            border-top: 1px solid #e5e7eb;
        }

        .menu-category:first-child {
            border-top: none;
        }


        .menu-items {
            padding: 0 0 8px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: #475569;
            text-decoration: none;
            transition: all 0.2s;
            font-weight: 500;
        }

        .menu-item:hover {
            background: #fef2f2;
            color: #c41c16;
        }

        .menu-item-icon {
            font-size: 1.2em;
            width: 24px;
            text-align: center;
        }

        .container {
            max-width: 1360px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        .header {
            background: white;
            padding: 32px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            margin-bottom: 24px;
        }

        .header h1 {
            color: #1e293b;
            font-size: 2.2em;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f0fdf4;
            color: #16a34a;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.9em;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #16a34a;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            background: white;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            margin-bottom: 24px;
        }

        .stock-picker {
            margin-bottom: 20px;
        }

        .picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .picker-header h3 {
            color: #1e3c72;
            font-size: 1.4em;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-box input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #1e3c72;
            
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 10px 20px;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            color: #64748b;
            font-size: 0.95em;
        }

        .filter-tab:hover {
            background: #fee2e2;
            border-color: #fecaca;
            color: #991b1b;
        }

        .filter-tab.active {
            background: #c41c16;
            color: white;
            border-color: #c41c16;
        }

        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
        }

        .stock-item {
            padding: 12px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-weight: 600;
        }

        .stock-item:hover {
            transform: translateY(-2px);
            
        }

        .stock-item.selected {
            background: #1e3c72;
            color: white;
            border-color: #1e3c72;
        }

        .watchlist-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f0f9ff;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 5px solid #1e3c72;
        }

        .btn {
            padding: 12px 30px;
            background: #1e3c72;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #2a5298;
            transform: translateY(-2px);
            
        }

        .btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Tablet breakpoint */
        @media (max-width: 1200px) and (min-width: 769px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .card {
                padding: 20px;
            }
        }

        /* Mobile breakpoint */
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #1e3c72;
            margin-bottom: 20px;
            font-size: 1.6em;
            border-bottom: 3px solid #1e3c72;
            padding-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 350px;
            margin-top: 20px;
        }

        .chart-container.large {
            height: 500px;
        }

        .market-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            
            transition: all 0.3s;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            
        }

        .summary-number {
            font-size: 2.8em;
            font-weight: bold;
            margin: 10px 0;
        }

        .summary-label {
            color: #64748b;
            font-size: 0.95em;
            font-weight: 600;
        }

        .stock-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .stock-table th {
            background: #f1f5f9;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 2px solid #cbd5e1;
        }

        .stock-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .stock-table tr:hover {
            background: #f8fafc;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .badge.buy {
            background: #d1fae5;
            color: #065f46;
        }

        .badge.sell {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge.hold {
            background: #f3f4f6;
            color: #374151;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #64748b;
        }

        .heatmap-container {
            margin-top: 20px;
        }

        .heatmap-category {
            margin-bottom: 25px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
        }

        .heatmap-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            cursor: pointer;
            user-select: none;
            transition: all 0.3s;
        }

        .heatmap-category-header:hover {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
        }

        .heatmap-category-header.commodities {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-bottom: 3px solid #f59e0b;
        }

        .heatmap-category-header.commodities:hover {
            background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
        }

        .heatmap-category-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 1.1em;
            color: #1e293b;
        }

        .heatmap-category-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
            color: #64748b;
        }

        .heatmap-category-stats span {
            font-weight: 600;
        }

        .heatmap-category-body {
            padding: 15px;
            background: white;
            display: none;
        }

        .heatmap-category-body.expanded {
            display: block;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 8px;
        }

        @media (max-width: 1400px) {
            .heatmap-grid {
                grid-template-columns: repeat(8, 1fr);
            }
        }

        @media (max-width: 1024px) {
            .heatmap-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        @media (max-width: 768px) {
            .heatmap-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .heatmap-cell {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.85em;
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid rgba(0,0,0,0.1);
        }

        .heatmap-cell:hover {
            transform: scale(1.05);
            z-index: 10;
            
            border-color: #1e3c72;
        }

        .heatmap-cell .symbol {
            font-size: 0.95em;
            margin-bottom: 3px;
            font-weight: 700;
        }

        .heatmap-cell .change {
            font-size: 0.85em;
            font-weight: 600;
        }

        .category-toggle {
            font-size: 1.2em;
            display: inline-block;
            min-width: 20px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }

            .stock-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }

        /* Footer Styles */
        .footer {
            background: #1e293b;
            color: #cbd5e1;
            padding: 40px 24px 24px;
            margin-top: 60px;
        }

        .footer-container {
            max-width: 1360px;
            margin: 0 auto;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .footer-section h3 {
            color: white;
            font-size: 1.1em;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .footer-links {
            list-style: none;
        }

        .footer-links li {
            margin-bottom: 8px;
        }

        .footer-links a {
            color: #cbd5e1;
            text-decoration: none;
            transition: color 0.2s;
            font-size: 0.9em;
        }

        .footer-links a:hover {
            color: #f59e0b;
        }

        .footer-bottom {
            border-top: 1px solid #334155;
            padding-top: 20px;
            text-align: center;
            color: #94a3b8;
            font-size: 0.85em;
        }

    </style>
    <script src="js/collapsible.js"></script>
    <script src="js/logo.js"></script>
    <script src="js/api-config.js"></script>
    <script src="js/stock-categories.js"></script>
    <script src="js/data-api.js"></script>
    <script src="js/custom-dialogs.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/currency.js"></script>
</head>
<body>
    <!-- Sticky Navigation -->
    <nav class="top-nav">
        <div class="nav-container">
            <div class="logo-section">
                <span class="logo-icon">üìä</span>
                <a href="index.html" class="logo-text" data-i18n="home.title">VNStock Analytics</a>
                <span class="page-title" data-i18n="nav.dashboard">Main Dashboard</span>
            </div>
            <div class="nav-menu">
                    <button class="menu-btn" onclick="toggleMenu()">
                        üìä Dashboards
                        <span id="menuArrow">‚ñº</span>
                    </button>
                    <div class="dropdown-menu" id="dropdownMenu">
                    <div class="menu-header" data-i18n="menu.all_dashboards">All Dashboards</div>

                    <div class="menu-category" data-i18n="menu.market_analysis">üìä Market Analysis</div>
                    <div class="menu-items">
                        <a href="dashboard.html" class="menu-item">
                            <span class="menu-item-icon">üìä</span>
                            <span data-i18n="nav.dashboard">Main Dashboard</span>
                        </a>
                        <a href="dashboard_history.html" class="menu-item">
                            <span class="menu-item-icon">üìä</span>
                            <span data-i18n="nav.history">Historical Analysis</span>
                        </a>
                        <a href="advanced_charts.html" class="menu-item">
                            <span class="menu-item-icon">üìâ</span>
                            <span data-i18n="nav.charts">Advanced Charts</span>
                        </a>
                    </div>

                    <div class="menu-category" data-i18n="menu.investment_tools">üíº Investment Tools</div>
                    <div class="menu-items">
                        <a href="price_forecast.html" class="menu-item">
                            <span class="menu-item-icon">üîÆ</span>
                            <span data-i18n="nav.forecast">Price Forecasting</span>
                        </a>
                        <a href="dashboard_advanced.html" class="menu-item">
                            <span class="menu-item-icon">üìä</span>
                            <span data-i18n="nav.portfolio_analytics">Portfolio Analytics</span>
                        </a>
                        <a href="macro_analysis.html" class="menu-item">
                            <span class="menu-item-icon">üåç</span>
                            <span data-i18n="nav.macro">Macro Analysis</span>
                        </a>
                    </div>

                    <div class="menu-category" data-i18n="menu.automation_alerts">üîî Automation & Alerts</div>
                    <div class="menu-items">
                        <a href="alerts_system.html" class="menu-item">
                            <span class="menu-item-icon">üîî</span>
                            <span data-i18n="nav.alerts">Price Alerts</span>
                        </a>
                        <a href="trading_automation.html" class="menu-item">
                            <span class="menu-item-icon">ü§ñ</span>
                            <span data-i18n="nav.automation">Trading Automation</span>
                        </a>
                    <a href="settings.html" class="menu-item">
                            <span class="menu-item-icon">‚öôÔ∏è</span>
                            <span data-i18n="nav.settings">Settings</span>
                        </a>

                    </div>
                </div>
            </div>
        </nav>

    <script>
        function toggleMenu() {
            const menu = document.getElementById('dropdownMenu');
            const arrow = document.getElementById('menuArrow');
            menu.classList.toggle('active');
            arrow.textContent = menu.classList.contains('active') ? '‚ñ≤' : '‚ñº';
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('dropdownMenu');
            const menuBtn = event.target.closest('.menu-btn');
            if (!menuBtn && !event.target.closest('.dropdown-menu')) {
                menu.classList.remove('active');
                const arrow = document.getElementById('menuArrow');
                if (arrow) arrow.textContent = '‚ñº';
            }
        });
    </script>

    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h1 style="margin-bottom: 0;" data-i18n="page.main_dashboard">üìä Main Dashboard - Real-Time Market Overview</h1>
                <div class="status" id="statusBadge">
                    <span class="status-dot"></span>
                    <span data-i18n="dashboard.live">LIVE</span>
                </div>
            </div>
            <p style="color: #64748b; font-size: 1.1em;" data-i18n="dashboard.monitoring_desc">Real-time monitoring of {count} Vietnamese stocks with performance tracking</p>
            <div style="margin-top: 12px; padding: 10px 16px; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); border-radius: 8px; display: inline-block;">
                <span style="color: white; font-weight: 600;">üìÖ <span data-i18n="common.last_updated">Last Updated</span>:</span>
                <span id="lastUpdated" style="color: white; font-weight: 500; margin-left: 8px;">Loading...</span>
            </div>
        </div>

        <!-- Stock Picker -->
        <div class="controls">
            <div class="stock-picker">
                <div class="picker-header">
                    <h3 data-i18n="dashboard.select_stocks_monitor">üéØ Select Stocks to Monitor</h3>
                    <button class="btn" id="applyBtn" onclick="applyWatchlist()" data-i18n="dashboard.apply_watchlist">Apply Watchlist</button>
                </div>

                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search stocks by symbol or name..." data-i18n-placeholder="dashboard.search_placeholder"
                           onkeyup="filterStocks()">
                    <button class="btn" onclick="selectAll()" data-i18n="common.select_all">Select All</button>
                    <button class="btn" onclick="clearAll()" data-i18n="common.clear_all">Clear All</button>
                </div>

                <div class="filter-tabs">
                    <div class="filter-tab" data-category="commodities" onclick="filterCategory('commodities')" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-weight: 700;" data-i18n="category.commodities">
                        üíé Commodities
                    </div>
                    <div class="filter-tab active" data-category="all" onclick="filterCategory('all')" data-i18n="category.all">
                        All Stocks
                    </div>
                    <div class="filter-tab" data-category="blue_chips" onclick="filterCategory('blue_chips')" data-i18n="category.blue_chips">
                        Blue Chips
                    </div>
                    <div class="filter-tab" data-category="banks" onclick="filterCategory('banks')" data-i18n="category.banks">
                        Banks
                    </div>
                    <div class="filter-tab" data-category="real_estate" onclick="filterCategory('real_estate')" data-i18n="category.real_estate">
                        Real Estate
                    </div>
                    <div class="filter-tab" data-category="tech" onclick="filterCategory('tech')" data-i18n="category.tech">
                        Technology
                    </div>
                    <div class="filter-tab" data-category="consumer" onclick="filterCategory('consumer')" data-i18n="category.consumer">
                        Consumer
                    </div>
                    <div class="filter-tab" data-category="oil_gas" onclick="filterCategory('oil_gas')" data-i18n="category.oil_gas">
                        Oil & Gas
                    </div>
                    <div class="filter-tab" data-category="affordable" onclick="filterCategory('affordable')" data-i18n="category.affordable">
                        Affordable
                    </div>
                </div>

                <div class="stock-grid" id="stockGrid">
                    <!-- Will be populated by JavaScript -->
                </div>

                <div class="watchlist-summary">
                    <div>
                        <strong>Selected Assets:</strong>
                        <span id="selectedCount">0</span> items
                    </div>
                    <div style="color: #64748b; font-size: 0.9em;" data-i18n="dashboard.customize_watchlist">
                        Customize your watchlist with stocks and commodities
                    </div>
                </div>
            </div>
        </div>

        <!-- Market Summary -->
        <div class="market-summary">
            <div class="summary-card">
                <div class="summary-label" data-i18n="dashboard.monitoring">Monitoring</div>
                <div class="summary-number" style="color: #1e3c72;" id="totalStocks">-</div>
            </div>
            <div class="summary-card">
                <div class="summary-label" data-i18n="dashboard.strong_buy">Strong Buy</div>
                <div class="summary-number" style="color: #10b981;" id="strongBuyCount">-</div>
            </div>
            <div class="summary-card">
                <div class="summary-label" data-i18n="dashboard.buy">Buy</div>
                <div class="summary-number" style="color: #34d399;" id="buyCount">-</div>
            </div>
            <div class="summary-card">
                <div class="summary-label" data-i18n="dashboard.hold">Hold</div>
                <div class="summary-number" style="color: #6b7280;" id="holdCount">-</div>
            </div>
            <div class="summary-card">
                <div class="summary-label" data-i18n="dashboard.sell">Sell</div>
                <div class="summary-number" style="color: #ef4444;" id="sellCount">-</div>
            </div>
            <div class="summary-card">
                <div class="summary-label" data-i18n="dashboard.avg_score">Avg Score</div>
                <div class="summary-number" style="color: #c41c16;" id="avgScore">-</div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid">
            <div class="card collapsible" style="grid-column: span 2;">
                <h2 data-i18n="dashboard.performance_heatmap">üìà Performance Heatmap</h2>
                <div class="card-content">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button onclick="expandAllCategories()" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;" data-i18n="common.expand_all">
                            Expand All
                        </button>
                        <button onclick="collapseAllCategories()" style="padding: 8px 16px; background: #64748b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;" data-i18n="common.collapse_all">
                            Collapse All
                        </button>
                    </div>
                    <div class="heatmap-container" id="heatmapContainer">
                        <div class="loading" data-i18n="common.loading_heatmap">Loading heatmap...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card collapsible" style="grid-column: span 2;">
                <h2 data-i18n="dashboard.score_distribution">üìä Score Distribution</h2>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="scoreChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card collapsible" style="grid-column: span 2;">
                <h2 data-i18n="dashboard.price_volume_analysis">üïØÔ∏è Price & Volume Analysis</h2>
            <div class="card-content">                <div class="chart-container large">
                    <canvas id="priceVolumeChart"></canvas>
            </div>                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card collapsible">
                <h2 data-i18n="dashboard.rsi_distribution">üìâ RSI Distribution</h2>
            <div class="card-content">                <div class="chart-container">
                    <canvas id="rsiChart"></canvas>
                </div>
            </div>
            </div>
            <div class="card collapsible">
                <h2 data-i18n="dashboard.sector_performance">üéØ Sector Performance</h2>
            <div class="card-content">                <div class="chart-container">
                    <canvas id="sectorChart"></canvas>
                </div>
            </div>
            </div>        </div>

        <div class="card collapsible">
            <h2 data-i18n="dashboard.detailed_analysis">üìã Detailed Stock Analysis</h2>
            <div class="card-content">
                <!-- Filter Controls -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <div>
                        <label style="display: block; font-size: 0.85em; font-weight: 600; color: #64748b; margin-bottom: 5px;">üîç Filter Symbol</label>
                        <input type="text" id="filterSymbol" placeholder="e.g., VPB, FPT..."
                               oninput="filterStockTable()"
                               style="width: 100%; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.9em;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.85em; font-weight: 600; color: #64748b; margin-bottom: 5px;">üìä Filter Recommendation</label>
                        <select id="filterRecommendation" onchange="filterStockTable()"
                                style="width: 100%; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.9em;">
                            <option value="" data-i18n="option.all">All</option>
                            <option value="STRONG BUY" data-i18n="option.strong_buy">STRONG BUY</option>
                            <option value="BUY" data-i18n="option.buy">BUY</option>
                            <option value="HOLD" data-i18n="option.hold">HOLD</option>
                            <option value="SELL" data-i18n="option.sell">SELL</option>
                            <option value="STRONG SELL" data-i18n="option.strong_sell">STRONG SELL</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.85em; font-weight: 600; color: #64748b; margin-bottom: 5px;">üìà Filter Change</label>
                        <select id="filterChange" onchange="filterStockTable()"
                                style="width: 100%; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.9em;">
                            <option value="">All</option>
                            <option value="positive">Positive</option>
                            <option value="negative">Negative</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button onclick="clearTableFilters()"
                                style="width: 100%; padding: 8px 12px; background: #e5e7eb; color: #475569; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9em;">
                            Clear Filters
                        </button>
                    </div>
                </div>

                <div style="overflow-x: auto; width: 100%;">
                    <table class="stock-table" id="stockTable" style="width: 100%;">
                        <thead>
                            <tr>
                                <th data-i18n="table.symbol">Symbol</th>
                                <th data-i18n="table.price">Price</th>
                                <th data-i18n="table.change">Change</th>
                                <th data-i18n="table.volume">Volume</th>
                                <th data-i18n="table.t_plus">T+2 Valid</th>
                                <th data-i18n="table.score">Score</th>
                                <th data-i18n="table.rsi">RSI</th>
                                <th data-i18n="table.recommendation">Recommendation</th>
                                <th data-i18n="table.signals">Signals</th>
                                <th data-i18n="table.last_update">Last Update</th>
                                <th data-i18n="table.chart">Chart</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody">
                            <tr><td colspan="11" class="loading" data-i18n="common.waiting_data">Waiting for data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>    <script>
        // Using shared STOCK_CATEGORIES from stock-categories.js (dynamically loaded from API)

        let selectedStocks = new Set(['VPB', 'STB', 'HDB', 'SHB', 'MBB', 'ACB', 'FPT', 'POW', 'DGC', 'GEX']);
        let currentCategory = 'all';
        let latestData = null;
        let charts = {};
        let lastDataHash = null;
        let lastTableDataHash = null; // Track last table render to prevent unnecessary rerenders
        let lastAnalysisHash = null; // Track if analysis changed significantly
        let stockNames = {}; // Stock symbol to name mapping

        // Initialize
        async function init() {
            try {
                await loadStockNames();

                // Wait for categories to load and update count dynamically
                const checkCategories = setInterval(() => {
                    if (window.categoriesLoaded && window.TOTAL_STOCKS_COUNT > 0) {
                        // Update the monitoring description with actual stock count
                        const descEl = document.querySelector('[data-i18n="dashboard.monitoring_desc"]');
                        if (descEl && descEl.textContent.includes('{count}')) {
                            descEl.innerHTML = descEl.textContent.replace('{count}', `<span style="font-weight: 700; color: #c41c16;">${window.TOTAL_STOCKS_COUNT}</span>`);
                        }
                        clearInterval(checkCategories);
                    }
                }, 100);

                // Listen for categories update from API (in case it loads later than fallback)
                window.addEventListener('categoriesUpdated', () => {
                    console.log(`üìä Stock categories updated from API: ${window.TOTAL_STOCKS_COUNT} total stocks`);
                    // Refresh the grid to show new data
                    renderStockGrid();
                    // Update the monitoring description with new count
                    const descEl = document.querySelector('[data-i18n="dashboard.monitoring_desc"]');
                    if (descEl) {
                        const countSpan = descEl.querySelector('span');
                        if (countSpan) {
                            countSpan.textContent = window.TOTAL_STOCKS_COUNT;
                        }
                    }
                });

                renderStockGrid();
                updateSelectedCount();
                startPolling();
            } catch (error) {
                console.error('Initialization error:', error);
                // Show user-friendly error message
                const grid = document.getElementById('stockGrid');
                if (grid) {
                    grid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                            <p style="color: #dc2626; font-size: 1.1em; margin-bottom: 10px;">‚ö†Ô∏è Failed to load dashboard</p>
                            <p style="color: #64748b;">Please check your connection and <a href="javascript:location.reload()" style="color: #c41c16; text-decoration: underline;">reload the page</a></p>
                        </div>
                    `;
                }
            }
        }

        // Load stock names from API
        async function loadStockNames() {
            try {
                const response = await fetch(`${window.API_BASE_URL || ''}/api/stock-names`);
                stockNames = await response.json();
                console.log(`Loaded ${Object.keys(stockNames).length} stock names`);
            } catch (error) {
                console.error('Error loading stock names:', error);
                stockNames = {}; // Fallback to empty object
            }
        }

        // Get display name for a stock symbol
        function getStockDisplayName(symbol) {
            const name = stockNames[symbol];
            if (name) {
                return `${symbol} - ${name}`;
            }
            return symbol;
        }

        function renderStockGrid() {
            const grid = document.getElementById('stockGrid');
            const stocks = STOCK_CATEGORIES[currentCategory];
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            const filtered = stocks.filter(symbol => {
                const displayName = getStockDisplayName(symbol).toLowerCase();
                return displayName.includes(searchTerm);
            });

            // Check if this is commodities category
            const isCommodity = (symbol) => STOCK_CATEGORIES.commodities.includes(symbol);

            grid.innerHTML = filtered.map(symbol => {
                const commodity = isCommodity(symbol);
                const borderColor = commodity ? '#f59e0b' : '#1e3c72';
                const icon = commodity ? 'üíé' : '';

                return `
                    <div class="stock-item ${selectedStocks.has(symbol) ? 'selected' : ''}"
                         onclick="toggleStock('${symbol}')"
                         title="${getStockDisplayName(symbol)}"
                         style="border-left-color: ${borderColor};">
                        <div style="font-weight: 700; font-size: 1.1em;">
                            ${icon} ${symbol}
                        </div>
                        <div style="font-size: 0.85em; color: #64748b; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${stockNames[symbol] || ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleStock(symbol) {
            if (selectedStocks.has(symbol)) {
                selectedStocks.delete(symbol);
            } else {
                selectedStocks.add(symbol);
            }
            renderStockGrid();
            updateSelectedCount();
        }

        function filterCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('active');
            renderStockGrid();
        }

        function filterStocks() {
            renderStockGrid();
        }

        function selectAll() {
            const stocks = STOCK_CATEGORIES[currentCategory];
            stocks.forEach(symbol => selectedStocks.add(symbol));
            renderStockGrid();
            updateSelectedCount();
        }

        function clearAll() {
            selectedStocks.clear();
            renderStockGrid();
            updateSelectedCount();
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedStocks.size;
        }

        async function applyWatchlist() {
            if (selectedStocks.size === 0) {
                showWarning('Please select at least one stock to monitor');
                return;
            }

            const watchlistArray = [...selectedStocks];

            // Save to server
            try {
                const response = await fetch(`${window.API_BASE_URL || ''}/api/watchlist`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(watchlistArray)
                });

                const result = await response.json();

                if (result.success) {
                    // Save to localStorage
                    localStorage.setItem('watchlist', JSON.stringify(watchlistArray));

                    // Show confirmation
                    document.getElementById('applyBtn').textContent = `‚úì Applied! (${result.count} stocks)`;
                    setTimeout(() => {
                        document.getElementById('applyBtn').textContent = 'Apply Watchlist';
                    }, 3000);

                    // Refresh data
                    await fetchLatestData();

                    // Show message
                    showSuccess(`Watchlist saved successfully! ${result.count} stocks will be monitored.`);
                } else {
                    showError('Error saving watchlist: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving watchlist:', error);
                showError('Error saving watchlist. Check console for details.');
            }
        }

        async function startPolling() {
            await fetchLatestData();
            setInterval(fetchLatestData, 5000); // Poll every 5 seconds for real-time updates
        }

        async function fetchLatestData() {
            try {
                const response = await fetch(`${window.API_BASE_URL || ''}/api/latest`);
                const data = await response.json();

                if (data.error) {
                    console.log('No data yet');
                    return;
                }

                // Check if data actually changed
                const dataHash = JSON.stringify(data.timestamp);
                if (dataHash === lastDataHash) {
                    return; // No changes, skip update
                }
                lastDataHash = dataHash;

                latestData = data;
                await displayData(data);
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function calculateTechnicalAnalysis(stock) {
            // Calculate a simple technical score based on price change
            const changePercent = stock.change_percent || 0;

            // Score ranges from -100 to +100
            // Based on price change: -10% = -100, +10% = +100
            let score = Math.max(-100, Math.min(100, changePercent * 10));

            // Determine recommendation based on score
            let recommendation = 'HOLD';
            if (score > 50) recommendation = 'STRONG BUY';
            else if (score > 20) recommendation = 'BUY';
            else if (score < -50) recommendation = 'STRONG SELL';
            else if (score < -20) recommendation = 'SELL';

            // Calculate RSI (simplified - normally requires 14 periods)
            // For demo, use change_percent to estimate: positive = bullish, negative = bearish
            const rsi = 50 + (changePercent * 2); // Ranges from ~30-70 for typical moves
            const rsiValue = Math.max(0, Math.min(100, rsi));

            return {
                score: Math.round(score),
                recommendation: recommendation,
                indicators: {
                    rsi: Math.round(rsiValue),
                    momentum: changePercent > 0 ? 'Bullish' : changePercent < 0 ? 'Bearish' : 'Neutral'
                }
            };
        }

        async function displayData(data) {
            // Update timestamp
            const timestamp = new Date(data.timestamp);
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            document.getElementById('lastUpdated').textContent = timestamp.toLocaleString('en-US', options);

            // Filter by watchlist
            const watchlist = [...selectedStocks];
            const filteredResults = {};

            // Support both 'all_results' and 'stocks' property names
            const allData = data.all_results || data.stocks || {};

            console.log(`üì• displayData: API has ${Object.keys(allData).length} stocks, watchlist: ${watchlist.join(', ')}`);

            // First pass: populate basic data
            Object.entries(allData).forEach(([symbol, result]) => {
                if (watchlist.includes(symbol)) {
                    // Use fallback analysis for now
                    if (!result.analysis || !result.analysis.score) {
                        result.analysis = calculateTechnicalAnalysis(result);
                    }
                    filteredResults[symbol] = result;
                }
            });

            // Update displays immediately with basic data
            updateDashboardDisplays(Object.values(filteredResults), false);

            // Fetch detailed analysis for each stock asynchronously
            Promise.all(watchlist.map(symbol =>
                fetch(`${window.API_BASE_URL || ''}/api/stock-analysis/${symbol}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.success && filteredResults[symbol]) {
                            filteredResults[symbol].analysis = data.analysis;
                        }
                    })
                    .catch(err => console.warn(`Error fetching analysis for ${symbol}:`, err))
            )).then(() => {
                // After all analysis data is loaded, update displays with full data
                updateDashboardDisplays(Object.values(filteredResults), true);
            });
        }

        function updateDashboardDisplays(allStocks, updateCharts = true) {
            if (!allStocks || allStocks.length === 0) {
                console.warn('‚ö†Ô∏è updateDashboardDisplays called with empty stocks array. Selected stocks:', [...selectedStocks]);
                return;
            }

            console.log(`üìä Updating dashboard displays with ${allStocks.length} stocks${updateCharts ? ' (full update)' : ' (table only)'}`);

            // Always update summary counts - these are fast
            document.getElementById('totalStocks').textContent = allStocks.length;

            const counts = {
                strongBuy: allStocks.filter(s => {
                    const rec = s.analysis?.recommendation || s.analysis?.emoji;
                    return rec === 'STRONG BUY' || rec === 'üü¢';
                }).length,
                buy: allStocks.filter(s => s.analysis?.recommendation === 'BUY').length,
                hold: allStocks.filter(s => {
                    const rec = s.analysis?.recommendation;
                    return rec === 'HOLD' || rec === undefined;
                }).length,
                sell: allStocks.filter(s => {
                    const rec = s.analysis?.recommendation;
                    return rec === 'SELL' || rec === 'STRONG SELL';
                }).length
            };

            document.getElementById('strongBuyCount').textContent = counts.strongBuy;
            document.getElementById('buyCount').textContent = counts.buy;
            document.getElementById('holdCount').textContent = counts.hold;
            document.getElementById('sellCount').textContent = counts.sell;

            const avgScore = allStocks.length > 0 ?
                (allStocks.reduce((sum, s) => sum + (s.analysis?.score || 0), 0) / allStocks.length).toFixed(1) : 0;
            document.getElementById('avgScore').textContent = avgScore;

            // Only update charts on full updates to reduce flickering
            if (updateCharts) {
                renderHeatmap(allStocks);
                renderScoreChart(allStocks);
                renderRSIChart(allStocks);
                renderSectorChart(allStocks);
                renderPriceVolumeChart(allStocks);
            }

            // Always update table with latest data
            const timestamp = new Date(); // Pass Date object, not string
            renderStockTable(allStocks, timestamp);
        }

        function renderHeatmap(stocks) {
            const container = document.getElementById('heatmapContainer');

            // Save current expanded state before rebuilding
            const expandedCategories = new Set();
            document.querySelectorAll('.heatmap-category-body.expanded').forEach(body => {
                expandedCategories.add(body.id);
            });

            // Category definitions with display names
            const categories = [
                { key: 'commodities', name: 'üíé Commodities', stocks: STOCK_CATEGORIES.commodities, special: true },
                { key: 'blue_chips', name: '‚≠ê Blue Chips', stocks: STOCK_CATEGORIES.blue_chips },
                { key: 'banks', name: 'üè¶ Banks', stocks: STOCK_CATEGORIES.banks },
                { key: 'real_estate', name: 'üè¢ Real Estate', stocks: STOCK_CATEGORIES.real_estate },
                { key: 'tech', name: 'üíª Technology', stocks: STOCK_CATEGORIES.tech },
                { key: 'consumer', name: 'üõí Consumer', stocks: STOCK_CATEGORIES.consumer },
                { key: 'oil_gas', name: '‚õΩ Oil & Gas', stocks: STOCK_CATEGORIES.oil_gas },
                { key: 'affordable', name: 'üí∞ Affordable', stocks: STOCK_CATEGORIES.affordable }
            ];

            let html = '';
            let firstCategorySet = false;

            categories.forEach(category => {
                // Filter stocks that belong to this category
                const categoryStocks = stocks.filter(s => category.stocks.includes(s.symbol));

                if (categoryStocks.length === 0) return;

                // Sort by change percent (descending)
                categoryStocks.sort((a, b) => (b.change_percent || 0) - (a.change_percent || 0));

                // Calculate category statistics
                const avgChange = categoryStocks.reduce((sum, s) => sum + (s.change_percent || 0), 0) / categoryStocks.length;
                const gainers = categoryStocks.filter(s => (s.change_percent || 0) > 0).length;
                const losers = categoryStocks.filter(s => (s.change_percent || 0) < 0).length;

                // Create category section
                const categoryId = `category-${category.key}`;
                const headerClass = category.special ? 'commodities' : '';

                // Determine if this category should be expanded
                const shouldExpand = expandedCategories.has(categoryId) ||
                                   (expandedCategories.size === 0 && !firstCategorySet);
                if (shouldExpand) firstCategorySet = true;

                const expandedClass = shouldExpand ? 'expanded' : '';
                const toggleIcon = shouldExpand ? '‚ñº' : '‚ñ∂';

                html += `
                    <div class="heatmap-category">
                        <div class="heatmap-category-header ${headerClass}" onclick="toggleCategory('${categoryId}')">
                            <div class="heatmap-category-title">
                                <span class="category-toggle ${expandedClass}" id="${categoryId}-toggle">${toggleIcon}</span>
                                <span>${category.name}</span>
                                <span style="color: #64748b; font-weight: 400; font-size: 0.9em;">(${categoryStocks.length})</span>
                            </div>
                            <div class="heatmap-category-stats">
                                <span>Avg: ${avgChange > 0 ? '+' : ''}${avgChange.toFixed(2)}%</span>
                                <span style="color: #10b981;">‚Üë${gainers}</span>
                                <span style="color: #ef4444;">‚Üì${losers}</span>
                            </div>
                        </div>
                        <div class="heatmap-category-body ${expandedClass}" id="${categoryId}">
                            <div class="heatmap-grid">
                                ${categoryStocks.map(stock => {
                                    const change = stock.change_percent || 0;
                                    const intensity = Math.min(Math.abs(change) * 20, 100);
                                    const color = change > 0 ?
                                        `rgb(${255 - intensity * 2}, 255, ${255 - intensity * 2})` :
                                        `rgb(255, ${255 - intensity * 2}, ${255 - intensity * 2})`;

                                    const borderColor = category.special ? '#f59e0b' : 'rgba(0,0,0,0.1)';

                                    return `
                                        <div class="heatmap-cell" style="background: ${color}; border-color: ${borderColor}; cursor: pointer;"
                                             title="${stock.symbol}: ${change.toFixed(2)}% | Price: ${stock.price?.toLocaleString() || 'N/A'} VND | Click to view advanced charts"
                                             onclick="navigateToChart('${stock.symbol}')">
                                            <div class="symbol">${category.special ? 'üíé ' : ''}${stock.symbol}</div>
                                            <div class="change">${change > 0 ? '+' : ''}${change.toFixed(1)}%</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function toggleCategory(categoryId) {
            const body = document.getElementById(categoryId);
            const toggle = document.getElementById(`${categoryId}-toggle`);

            if (body && toggle) {
                const isExpanded = body.classList.toggle('expanded');
                toggle.classList.toggle('expanded');
                // Update toggle icon
                toggle.textContent = isExpanded ? '‚ñº' : '‚ñ∂';
            }
        }

        function expandAllCategories() {
            document.querySelectorAll('.heatmap-category-body').forEach(body => {
                body.classList.add('expanded');
            });
            document.querySelectorAll('.category-toggle').forEach(toggle => {
                toggle.classList.add('expanded');
                toggle.textContent = '‚ñº';
            });
        }

        function collapseAllCategories() {
            document.querySelectorAll('.heatmap-category-body').forEach(body => {
                body.classList.remove('expanded');
            });
            document.querySelectorAll('.category-toggle').forEach(toggle => {
                toggle.classList.remove('expanded');
                toggle.textContent = '‚ñ∂';
            });
        }

        function navigateToChart(symbol) {
            // Navigate to advanced charts page with the stock symbol
            window.location.href = `advanced_charts.html?symbol=${symbol}`;
        }

        function renderScoreChart(stocks) {
            const ctx = document.getElementById('scoreChart');

            const labels = stocks.map(s => s.symbol);
            const scores = stocks.map(s => s.analysis?.score || 0);
            const colors = scores.map(score =>
                score > 20 ? 'rgba(16, 185, 129, 0.8)' :
                score < -20 ? 'rgba(239, 68, 68, 0.8)' :
                'rgba(107, 114, 128, 0.8)'
            );

            if (charts.scoreChart) {
                // Update existing chart
                charts.scoreChart.data.labels = labels;
                charts.scoreChart.data.datasets[0].data = scores;
                charts.scoreChart.data.datasets[0].backgroundColor = colors;
                charts.scoreChart.data.datasets[0].borderColor = colors.map(c => c.replace('0.8', '1'));
                charts.scoreChart.update('none'); // No animation
            } else {
                // Create new chart
                charts.scoreChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Technical Score',
                            data: scores,
                            backgroundColor: colors,
                            borderColor: colors.map(c => c.replace('0.8', '1')),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        },
                        animation: {
                            duration: 0 // Disable animation
                        }
                    }
                });
            }
        }

        function renderRSIChart(stocks) {
            const ctx = document.getElementById('rsiChart');

            const labels = stocks.map(s => s.symbol);
            const rsiValues = stocks.map(s => s.analysis?.indicators?.rsi || 50);

            if (charts.rsiChart) {
                // Update existing chart
                charts.rsiChart.data.labels = labels;
                charts.rsiChart.data.datasets[0].data = rsiValues;
                charts.rsiChart.update('none'); // No animation
            } else {
                // Create new chart
                charts.rsiChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'RSI',
                            data: rsiValues,
                            borderColor: 'rgba(30, 60, 114, 1)',
                            backgroundColor: 'rgba(30, 60, 114, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                min: 0,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        if (value === 30 || value === 70) {
                                            return value + ' (Signal)';
                                        }
                                        return value;
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: 0 // Disable animation
                        }
                    }
                });
            }
        }

        function renderSectorChart(stocks) {
            const ctx = document.getElementById('sectorChart');

            // Categorize stocks
            const sectors = {
                'Banks': 0,
                'Real Estate': 0,
                'Technology': 0,
                'Consumer': 0,
                'Other': 0
            };

            stocks.forEach(stock => {
                const symbol = stock.symbol;
                if (STOCK_CATEGORIES.banks.includes(symbol)) sectors['Banks']++;
                else if (STOCK_CATEGORIES.real_estate.includes(symbol)) sectors['Real Estate']++;
                else if (STOCK_CATEGORIES.tech.includes(symbol)) sectors['Technology']++;
                else if (STOCK_CATEGORIES.consumer.includes(symbol)) sectors['Consumer']++;
                else sectors['Other']++;
            });

            if (charts.sectorChart) {
                // Update existing chart
                charts.sectorChart.data.labels = Object.keys(sectors);
                charts.sectorChart.data.datasets[0].data = Object.values(sectors);
                charts.sectorChart.update('none'); // No animation
            } else {
                // Create new chart
                charts.sectorChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(sectors),
                        datasets: [{
                            data: Object.values(sectors),
                            backgroundColor: [
                                'rgba(30, 60, 114, 0.8)',
                                'rgba(42, 82, 152, 0.8)',
                                'rgba(139, 92, 246, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(107, 114, 128, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        },
                        animation: {
                            duration: 0 // Disable animation
                        }
                    }
                });
            }
        }

        function renderPriceVolumeChart(stocks) {
            const ctx = document.getElementById('priceVolumeChart');

            const labels = stocks.map(s => s.symbol);
            const prices = stocks.map(s => s.price || 0);
            const volumes = stocks.map(s => (s.volume || 0) / 1000); // Scale down

            if (charts.priceVolumeChart) {
                // Update existing chart
                charts.priceVolumeChart.data.labels = labels;
                charts.priceVolumeChart.data.datasets[0].data = prices;
                charts.priceVolumeChart.data.datasets[1].data = volumes;
                charts.priceVolumeChart.update('none'); // No animation
            } else {
                // Create new chart
                charts.priceVolumeChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Price (VND)',
                                data: prices,
                                backgroundColor: 'rgba(30, 60, 114, 0.7)',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Volume (K)',
                                data: volumes,
                                backgroundColor: 'rgba(16, 185, 129, 0.5)',
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                type: 'linear',
                                position: 'left',
                                title: { display: true, text: 'Price (VND)' }
                            },
                            y1: {
                                type: 'linear',
                                position: 'right',
                                title: { display: true, text: 'Volume (K)' },
                                grid: { drawOnChartArea: false }
                            }
                        },
                        animation: {
                            duration: 0 // Disable animation
                        }
                    }
                });
            }
        }

        // Calculate T+2 settlement date (skip weekends)
        function calculateT2Date() {
            const today = new Date();
            let tradingDaysAdded = 0;
            let currentDate = new Date(today);

            while (tradingDaysAdded < 2) {
                currentDate.setDate(currentDate.getDate() + 1);
                const dayOfWeek = currentDate.getDay();
                // Skip weekends (0 = Sunday, 6 = Saturday)
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    tradingDaysAdded++;
                }
            }

            return currentDate.toLocaleDateString('en-US', {
                month: '2-digit',
                day: '2-digit',
                year: 'numeric'
            });
        }

        function filterStockTable() {
            const symbolFilter = document.getElementById('filterSymbol')?.value.toLowerCase() || '';
            const recommendationFilter = document.getElementById('filterRecommendation')?.value || '';
            const changeFilter = document.getElementById('filterChange')?.value || '';

            const rows = document.querySelectorAll('#stockTableBody tr');

            // If no filters applied, show all rows
            if (!symbolFilter && !recommendationFilter && !changeFilter) {
                rows.forEach(row => {
                    const cells = row.cells;
                    if (cells && cells.length > 2) { // Only show data rows, not loading row
                        row.style.display = '';
                    }
                });
                return;
            }

            rows.forEach(row => {
                const cells = row.cells;
                if (!cells || cells.length < 8) return; // Skip loading/empty rows

                const symbol = cells[0].textContent.toLowerCase();
                const changeText = cells[2].textContent;
                const recommendation = cells[7].textContent.trim();

                let show = true;

                // Filter by symbol
                if (symbolFilter && !symbol.includes(symbolFilter)) {
                    show = false;
                }

                // Filter by recommendation
                if (recommendationFilter && recommendation !== recommendationFilter) {
                    show = false;
                }

                // Filter by change (positive/negative)
                if (changeFilter === 'positive' && !changeText.includes('+')) {
                    show = false;
                }
                if (changeFilter === 'negative' && changeText.includes('+')) {
                    show = false;
                }

                row.style.display = show ? '' : 'none';
            });
        }

        function clearTableFilters() {
            document.getElementById('filterSymbol').value = '';
            document.getElementById('filterRecommendation').value = '';
            document.getElementById('filterChange').value = '';
            filterStockTable();
        }

        function renderStockTable(stocks, dataTimestamp) {
            const tbody = document.getElementById('stockTableBody');

            // Check if stocks array is empty or invalid
            if (!stocks || stocks.length === 0) {
                console.warn('‚ö†Ô∏è No stocks to display in detailed analysis table');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px; color: #64748b; font-size: 0.95em;">
                            üìä Select stocks from the watchlist above and click "Apply Watchlist" to see detailed analysis
                        </td>
                    </tr>
                `;
                return;
            }

            // Create hashes to detect changes
            // Sort before hashing to ensure consistent order
            const sortedForHash = [...stocks].sort((a, b) => (b.analysis?.score || 0) - (a.analysis?.score || 0));

            // Hash of basic market data (price, volume, change)
            const basicDataHash = JSON.stringify(sortedForHash.map(s => ({
                symbol: s.symbol,
                price: s.price,
                change_percent: s.change_percent,
                volume: s.volume
            })));

            // Hash of analysis data
            const analysisDataHash = JSON.stringify(sortedForHash.map(s => ({
                symbol: s.symbol,
                score: s.analysis?.score,
                recommendation: s.analysis?.recommendation,
                rsi: s.analysis?.indicators?.rsi
            })));

            // Check if ANYTHING changed
            const basicChanged = basicDataHash !== lastTableDataHash;
            const analysisChanged = analysisDataHash !== lastAnalysisHash;

            if (!basicChanged && !analysisChanged) {
                console.log(`‚è≠Ô∏è  All data unchanged (${stocks.length} stocks), skipping rerender`);
                return;
            }

            // Update hashes
            lastTableDataHash = basicDataHash;
            lastAnalysisHash = analysisDataHash;

            if (basicChanged) {
                console.log(`üîÑ Market data changed, rerendering table (${stocks.length} stocks)`);
            } else if (analysisChanged) {
                console.log(`üîÑ Analysis data changed, rerendering table (${stocks.length} stocks)`);
            }

            const sorted = stocks.sort((a, b) => (b.analysis?.score || 0) - (a.analysis?.score || 0));

            // Format timestamp once for all rows
            // Handle both Date objects and strings
            const timestamp = dataTimestamp instanceof Date ? dataTimestamp : new Date(dataTimestamp);
            const timeString = timestamp.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });

            // Calculate T+2 date once for all rows
            const t2Date = calculateT2Date();

            const html = sorted.map(stock => {
                const analysis = stock.analysis || {};
                const indicators = analysis.indicators || {};

                // Generate trading signals based on available data
                const generatedSignals = [];
                const rsi = indicators.rsi || 0;
                const changePercent = stock.change_percent || 0;

                // RSI Signals
                if (rsi > 70) generatedSignals.push('üìà Overbought');
                else if (rsi < 30) generatedSignals.push('üìâ Oversold');

                // Price Movement Signals
                if (changePercent > 5) generatedSignals.push('üöÄ Strong Up');
                else if (changePercent < -5) generatedSignals.push('‚ö†Ô∏è Sharp Drop');
                else if (changePercent > 2) generatedSignals.push('‚úÖ Rising');
                else if (changePercent < -2) generatedSignals.push('üîª Falling');

                const signals = (analysis.signals && analysis.signals.length > 0)
                    ? analysis.signals.slice(0, 2).join(', ')
                    : generatedSignals.slice(0, 2).join(', ') || '‚Äî';

                const recClass = analysis.score > 20 ? 'buy' : analysis.score < -20 ? 'sell' : 'hold';
                const recText = analysis.recommendation || 'HOLD';

                return `
                    <tr>
                        <td><strong>${stock.symbol}</strong></td>
                        <td>${formatPrice(stock.price || 0)} VND</td>
                        <td style="color: ${stock.change_percent > 0 ? '#10b981' : '#ef4444'};">
                            ${stock.change_percent > 0 ? '+' : ''}${(stock.change_percent || 0).toFixed(2)}%
                        </td>
                        <td>${formatVolume(stock.volume || 0)}</td>
                        <td style="font-size: 0.85em; color: #3b82f6; font-weight: 500;">${t2Date}</td>
                        <td><strong>${analysis.score || 0}</strong></td>
                        <td>${(indicators.rsi || 0).toFixed(1)}</td>
                        <td><span class="badge ${recClass}">${recText}</span></td>
                        <td style="font-size: 0.85em;">${signals}</td>
                        <td style="font-size: 0.85em; color: #64748b;">${timeString}</td>
                        <td style="text-align: center;">
                            <a href="advanced_charts.html?symbol=${stock.symbol}"
                               title="View Advanced Charts for ${stock.symbol}"
                               style="color: #3b82f6; text-decoration: none; font-size: 1.2em;">
                                üìà
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = html;

            // Reapply filters after table update
            filterStockTable();
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN').format(Math.round(price));
        }

        function formatVolume(volume) {
            if (volume >= 1000000) {
                return (volume / 1000000).toFixed(1) + 'M';
            } else if (volume >= 1000) {
                return (volume / 1000).toFixed(1) + 'K';
            }
            return volume.toString();
        }

        // Load saved watchlist
        const saved = localStorage.getItem('watchlist');
        if (saved) {
            selectedStocks = new Set(JSON.parse(saved));
        }

        // Start
        init();
    </script>

    <footer class="footer">
        <div class="footer-container">
            <div class="footer-grid">
                <div class="footer-section">
                    <h3 data-i18n="menu.dashboards">Dashboards</h3>
                    <ul class="footer-links">
                        <li><a href="index.html" data-i18n="nav.home">Home</a></li>
                        <li><a href="dashboard.html" data-i18n="nav.dashboard">Main Dashboard</a></li>
                        <li><a href="dashboard_history.html" data-i18n="nav.history">Historical Analysis</a></li>
                        <li><a href="advanced_charts.html">Advanced Charts</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h3 data-i18n="menu.tools">Tools</h3>
                    <ul class="footer-links">
                        <li><a href="price_forecast.html" data-i18n="nav.forecast">Price Forecasting</a></li>
                        <li><a href="dashboard_advanced.html" data-i18n="portfolio.title">Portfolio Analytics</a></li>
                        <li><a href="macro_analysis.html" data-i18n="home.macro_analysis">Macro Analysis</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h3 data-i18n="menu.automation">Automation</h3>
                    <ul class="footer-links">
                        <li><a href="alerts_system.html" data-i18n="home.price_alerts">Price Alerts</a></li>
                        <li><a href="trading_automation.html" data-i18n="nav.automation">Trading Automation</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h3 data-i18n="menu.platform">Platform</h3>
                    <ul class="footer-links">
                        <li><a href="../docs/api/API_SERVER_SETUP.html">API Documentation</a></li>
                        <li><a href="../docs/api/README_API.html">Quick Start</a></li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <p>¬© 2024 VNStock Analytics</p>
                <p style="margin-top: 8px;" data-i18n="footer.disclaimer">For educational purposes only. Not financial advice. Trade at your own risk.</p>
            </div>
        </div>
    </footer>

</body>
</html>
