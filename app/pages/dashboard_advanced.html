<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="css/theme.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Analytics - VNStock Analytics</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <!-- Professional Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Excel Export Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f8fafc;
            color: #333333;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .top-nav {
            position: sticky;
            top: 0;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            z-index: 1000;
            
        }

        .nav-container {
            max-width: 1360px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 72px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-text {
            font-size: 1.3em;
            font-weight: 700;
            color: #c41c16;
            text-decoration: none;
        }

        .page-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #64748b;
            border-left: 2px solid #e5e7eb;
            padding-left: 16px;
        }

        .nav-menu {
            position: relative;
        }

        .menu-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #c41c16;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
        }

        .menu-btn:hover {
            background: #991b1b;
            transform: translateY(-1px);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            
            min-width: 280px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s;
            z-index: 1001;
        }

        .dropdown-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .menu-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 700;
            color: #1e293b;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .menu-category {
            padding: 12px 20px 8px;
            font-weight: 700;
            color: #64748b;
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            border-top: 1px solid #e5e7eb;
        }

        .menu-category:first-child {
            border-top: none;
        }


        .menu-items {
            padding: 0 0 8px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: #475569;
            text-decoration: none;
            transition: all 0.2s;
            font-weight: 500;
        }

        .menu-item:hover {
            background: #fef2f2;
            color: #c41c16;
        }

        .menu-item-icon {
            font-size: 1.2em;
            width: 24px;
            text-align: center;
        }


        .container {
            max-width: 1360px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        .header {
            background: white;
            padding: 32px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            margin-bottom: 24px;
        }

        .header h1 {
            color: #1e293b;
            font-size: 2.2em;
            margin-bottom: 8px;
            font-weight: 800;
            letter-spacing: -0.5px;
            font-family: 'Plus Jakarta Sans', 'Inter', sans-serif;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #e5e7eb;
            margin-bottom: 24px;
        }

        .card h2 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 1.6em;
            font-weight: 700;
            border-bottom: 2px solid #e5e7eb !important;
            padding-bottom: 12px;
            letter-spacing: -0.3px;
            font-family: 'Plus Jakarta Sans', 'Inter', sans-serif;
        }

        .card h3 {
            font-family: 'Plus Jakarta Sans', 'Inter', sans-serif;
            font-weight: 700;
        }

        .card h4 {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            letter-spacing: -0.2px;
        }

        /* Prevent white background and unwanted effects on h3 hover */
        h3 {
            background: transparent !important;
            transition: none !important;
        }

        h3:hover {
            background: transparent !important;
        }

        /* Override theme.css card h2/h3 border styles for this page */
        .card h3 {
            border-bottom: none !important;
        }

        /* Override theme.css table thead red gradient */
        table thead {
            background: #f8fafc !important;
            color: #1e293b !important;
        }

        table thead th {
            background: #f8fafc !important;
            color: #1e293b !important;
        }

        /* Override theme.css metric-card border-left */
        .metric-card {
            border-left: none !important;
        }

        /* Override theme.css tab hover */
        .tab:hover:not(.active) {
            background: #fee2e2 !important;
            border-color: #fecaca !important;
            color: #991b1b !important;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .feature-box {
            background: linear-gradient(135deg, #c41c16 0%, #7f1d1d 100%);
            padding: 25px;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .feature-box:hover {
            transform: translateY(-2px);
            
        }

        .feature-box h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            background: transparent !important;
            border: none !important;
            border-bottom: none !important;
        }

        .feature-box h3::after,
        .feature-box h3::before {
            content: none !important;
            display: none !important;
        }

        .feature-box:hover h3 {
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            background: transparent !important;
            border: none !important;
            border-bottom: none !important;
        }

        .feature-box p {
            font-size: 0.95em;
            opacity: 0.9;
            color: white;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 28px;
        }

        .chart-container.large {
            height: 500px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 28px;
            flex-wrap: wrap;
            max-width: 1360px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 24px;
        }

        .tab {
            padding: 12px 24px;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            color: #64748b;
        }

        .tab:hover {
            background: #fee2e2;
            border-color: #fecaca;
            color: #991b1b;
        }

        .tab.active {
            background: #c41c16;
            color: white;
            border-color: #c41c16;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            max-width: 1360px;
            margin: 0 auto;
            padding: 0 24px;
        }

        /* Prevent content overflow in cards */
        .card-content {
            overflow-x: auto;
            max-width: 100%;
        }

        /* Make tables responsive */
        .card-content table {
            min-width: 100%;
            overflow-x: auto;
            display: block;
            max-width: 100%;
        }

        .card-content table thead,
        .card-content table tbody {
            display: table;
            width: 100%;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 24px 0;
        }

        .metric-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .metric-label {
            color: #64748b;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 2em;
            font-weight: 700;
            color: #1e293b;
        }

        .btn {
            padding: 12px 30px;
            background: #c41c16;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 20px;
            font-family: 'Inter', 'Plus Jakarta Sans', sans-serif;
            letter-spacing: 0.3px;
        }

        .btn:hover {
            background: #991b1b;
            transform: translateY(-2px);

        }

        /* Portfolio Type Card Styles */
        .portfolio-type-card {
            position: relative;
            display: block;
            cursor: pointer;
            background: white;
            border: 3px solid #e5e7eb;
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            
        }

        .portfolio-type-card:hover {
            border-color: #3b82f6;
            
            transform: translateY(-4px);
        }

        .portfolio-type-card.active {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
            
        }

        .portfolio-card-content {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            position: relative;
        }

        .portfolio-icon {
            font-size: 3em;
            line-height: 1;
            flex-shrink: 0;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .portfolio-info {
            flex: 1;
        }

        .portfolio-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .portfolio-desc {
            font-size: 0.9em;
            color: #64748b;
            line-height: 1.5;
        }

        .portfolio-check {
            position: absolute;
            right: 0;
            top: 0;
            width: 32px;
            height: 32px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: 700;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.3s ease;
        }

        .portfolio-type-card.active .portfolio-check {
            opacity: 1;
            transform: scale(1);
        }

        .portfolio-type-card.active .portfolio-title {
            color: #1e40af;
        }

        .portfolio-type-card.active .portfolio-icon {
            transform: scale(1.1);
            transition: transform 0.3s ease;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 20px;
            font-family: 'Inter', sans-serif;
            font-weight: 400;
            letter-spacing: 0.2px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-family: 'Inter', 'Plus Jakarta Sans', sans-serif;
            font-weight: 500;
            letter-spacing: 0.1px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 24px;
            font-weight: 600;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        .alert-success {
            background: #dcfce7;
            color: #166534;
            border-left: 4px solid #10b981;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: #f8fafc;
            font-weight: 700;
            color: #1e293b;
        }

        tr:hover {
            background: #f8fafc;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
            max-height: 450px;
            overflow-y: auto;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
        }

        .checkbox-item:hover {
            background: #ede9fe;
            border-color: #7c3aed;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            margin: 0;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-size: 0.9em;
            color: #4c1d95;
            font-weight: 500;
        }

        .checkbox-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 5px 12px;
            background: #64748b;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-small:hover {
            background: #475569;
        }

        .selection-count {
            display: inline-block;
            padding: 5px 12px;
            background: #ede9fe;
            color: #6b21a8;
            border-radius: 5px;
            font-weight: 600;
            font-size: 0.8em;
        }

        .search-box-small {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9em;
            margin-bottom: 12px;
            transition: all 0.3s;
        }

        .search-box-small:focus {
            outline: none;
            border-color: #7c3aed;
            
        }

        .checkbox-item.hidden {
            display: none;
        }

        /* Footer Styles */
        .footer {
            background: #1e293b;
            color: #cbd5e1;
            padding: 40px 24px 24px;
            margin-top: 60px;
        }

        .footer-container {
            max-width: 1360px;
            margin: 0 auto;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .footer-section h3 {
            color: white;
            font-size: 1.1em;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .footer-links {
            list-style: none;
        }

        .footer-links li {
            margin-bottom: 8px;
        }

        .footer-links a {
            color: #cbd5e1;
            text-decoration: none;
            transition: color 0.2s;
            font-size: 0.9em;
        }

        .footer-links a:hover {
            color: #f59e0b;
        }

        .footer-bottom {
            border-top: 1px solid #334155;
            padding-top: 20px;
            text-align: center;
            color: #94a3b8;
            font-size: 0.85em;
        }

        /* Download Format Dialog */
        .download-dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        .download-dialog-overlay.active {
            display: flex;
        }

        .download-dialog {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .download-dialog h3 {
            margin: 0 0 10px 0;
            color: #1e40af;
            font-size: 1.5em;
        }

        .download-dialog p {
            margin: 0 0 24px 0;
            color: #64748b;
            font-size: 0.95em;
        }

        .download-format-options {
            display: grid;
            gap: 12px;
            margin-bottom: 24px;
        }

        .download-format-option {
            padding: 16px 20px;
            border: 3px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .download-format-option:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }

        .download-format-option.selected {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        }

        .download-format-icon {
            font-size: 2em;
            flex-shrink: 0;
        }

        .download-format-info {
            flex: 1;
        }

        .download-format-name {
            font-weight: 700;
            color: #1e40af;
            font-size: 1.1em;
            margin-bottom: 4px;
        }

        .download-format-desc {
            font-size: 0.85em;
            color: #64748b;
        }

        .download-dialog-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .download-dialog-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .download-dialog-btn-cancel {
            background: #f1f5f9;
            color: #475569;
        }

        .download-dialog-btn-cancel:hover {
            background: #e2e8f0;
        }

        .download-dialog-btn-download {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            
        }

        .download-dialog-btn-download:hover {
            transform: translateY(-2px);
            
        }

        .download-dialog-btn-download:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Strategy Checkbox Styles */
        .strategy-checkbox-label {
            position: relative;
            display: block;
            padding: 16px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            opacity: 0.7;
            
        }

        .strategy-checkbox-label:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            
        }

        .strategy-checkbox-label input[type="checkbox"] {
            display: none;
        }

        .strategy-checkbox-label input[type="checkbox"]:checked ~ .strategy-checkmark {
            opacity: 1;
        }

        .strategy-checkbox-label:has(input:checked) {
            opacity: 1;
            border: 3px solid rgba(255, 255, 255, 0.5);
        }

        .strategy-content {
            color: white;
            text-align: center;
        }

        .strategy-title {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 5px;
            font-family: 'Plus Jakarta Sans', 'Inter', sans-serif;
            letter-spacing: -0.2px;
        }

        .strategy-desc {
            font-size: 0.85em;
            opacity: 0.9;
            font-family: 'Inter', sans-serif;
            font-weight: 400;
            letter-spacing: 0.2px;
        }

        .strategy-checkmark {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            opacity: 0;
            transition: opacity 0.3s;
        }

        /* Mobile Responsive Design */
        @media (max-width: 1024px) {
            .container {
                padding: 20px 16px;
            }

            .nav-container {
                padding: 0 16px;
            }

            .header {
                padding: 24px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .card {
                padding: 16px;
                margin-bottom: 16px;
            }

            .card h2 {
                font-size: 1.3em;
            }

            .feature-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }

            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 12px;
            }

            .metric-card {
                padding: 15px;
            }

            .metric-value {
                font-size: 1.5em;
            }

            .metric-label {
                font-size: 0.85em;
            }

            .chart-container {
                height: 300px;
            }

            .chart-container.large {
                height: 350px;
            }

            .tabs {
                padding: 0 16px;
            }

            .tab {
                padding: 10px 16px;
                font-size: 0.9em;
            }
        }

        /* Tablet - Medium devices (768px - 1024px) */
        @media (max-width: 768px) {
            .nav-container {
                height: 60px;
                padding: 0 12px;
            }

            .logo-text {
                font-size: 1.1em;
            }

            .page-title {
                font-size: 0.9em;
                padding-left: 12px;
            }

            .menu-btn {
                padding: 8px 16px;
                font-size: 0.85em;
            }

            .container {
                padding: 16px 12px;
            }

            .header {
                padding: 16px;
                margin-bottom: 16px;
            }

            .header h1 {
                font-size: 1.5em;
                margin-bottom: 8px;
            }

            .header p {
                font-size: 0.9em;
            }

            .card {
                padding: 12px;
                margin-bottom: 12px;
            }

            .card h2 {
                font-size: 1.1em;
                padding-bottom: 8px;
                margin-bottom: 15px;
            }

            .card h3 {
                font-size: 1em;
            }

            .feature-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .feature-box {
                padding: 18px;
            }

            .feature-box h3 {
                font-size: 1.1em;
            }

            .feature-box p {
                font-size: 0.9em;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin: 16px 0;
            }

            .metric-card {
                padding: 12px;
            }

            .metric-value {
                font-size: 1.3em;
            }

            .metric-label {
                font-size: 0.8em;
            }

            .btn {
                padding: 10px 20px;
                font-size: 0.9em;
                margin-top: 16px;
            }

            .chart-container {
                height: 250px;
                margin-top: 20px;
            }

            .chart-container.large {
                height: 280px;
            }

            .tabs {
                padding: 0 12px;
                gap: 8px;
            }

            .tab {
                padding: 8px 12px;
                font-size: 0.8em;
                border-radius: 6px;
            }

            .tab-content {
                padding: 0 12px;
            }

            /* Strategy cards layout */
            #smartStrategyOptions {
                margin-top: 16px;
                padding: 16px;
            }

            #smartStrategyOptions > div {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            .strategy-checkbox-label {
                padding: 12px 14px;
                font-size: 0.9em;
            }

            .strategy-title {
                font-size: 0.95em;
            }

            .strategy-desc {
                font-size: 0.8em;
            }

            /* Portfolio type cards */
            .portfolio-type-card {
                padding: 16px;
            }

            .portfolio-icon {
                font-size: 2.2em;
            }

            .portfolio-title {
                font-size: 1em;
            }

            .portfolio-desc {
                font-size: 0.85em;
            }

            /* Risk config */
            #riskyStrategyConfig {
                margin-top: 16px;
                padding: 16px;
            }

            #riskyStrategyConfig > div {
                grid-template-columns: 1fr !important;
            }

            /* Input and form elements */
            input, select, textarea {
                font-size: 16px;
                padding: 10px;
            }

            label {
                font-size: 0.9em;
                margin-bottom: 6px;
            }

            table {
                font-size: 0.85em;
            }

            table thead th,
            table tbody td {
                padding: 8px;
            }
        }

        /* Mobile - Small devices (480px - 767px) */
        @media (max-width: 480px) {
            * {
                -webkit-tap-highlight-color: transparent;
            }

            body {
                font-size: 14px;
            }

            .top-nav {
                border-bottom: 1px solid #e5e7eb;
            }

            .nav-container {
                height: 56px;
                padding: 0 8px;
                flex-wrap: wrap;
            }

            .logo-section {
                gap: 8px;
            }

            .logo-text {
                font-size: 0.95em;
            }

            .page-title {
                display: none;
            }

            .menu-btn {
                padding: 8px 12px;
                font-size: 0.75em;
                gap: 4px;
            }

            .container {
                padding: 12px 8px;
                max-width: 100%;
            }

            .header {
                padding: 12px;
                margin-bottom: 12px;
                border-radius: 8px;
            }

            .header h1 {
                font-size: 1.2em;
                margin-bottom: 6px;
            }

            .header p {
                font-size: 0.8em;
                line-height: 1.4;
            }

            .card {
                padding: 10px;
                margin-bottom: 10px;
                border-radius: 8px;
            }

            .card h2 {
                font-size: 1em;
                margin-bottom: 10px;
                padding-bottom: 6px;
            }

            .card h3 {
                font-size: 0.95em;
            }

            .card h4 {
                font-size: 0.9em;
            }

            .feature-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .feature-box {
                padding: 14px;
                border-radius: 10px;
            }

            .feature-box h3 {
                font-size: 1em;
                margin-bottom: 8px;
            }

            .feature-box p {
                font-size: 0.85em;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 8px;
                margin: 12px 0;
            }

            .metric-card {
                padding: 10px;
                text-align: center;
            }

            .metric-value {
                font-size: 1.2em;
                font-weight: 700;
            }

            .metric-label {
                font-size: 0.75em;
                margin-bottom: 4px;
            }

            .btn {
                width: 100%;
                padding: 12px 16px;
                font-size: 0.9em;
                margin-top: 12px;
                margin-bottom: 8px;
            }

            .chart-container {
                height: 200px;
                margin-top: 16px;
            }

            .chart-container.large {
                height: 230px;
            }

            .tabs {
                padding: 0 8px;
                gap: 6px;
                margin-bottom: 16px;
                flex-wrap: wrap;
            }

            .tab {
                padding: 6px 10px;
                font-size: 0.75em;
                border-radius: 4px;
                flex: 1;
                min-width: 70px;
            }

            .tab-content {
                padding: 0 8px;
            }

            /* Strategy cards - single column on mobile */
            #smartStrategyOptions {
                margin-top: 12px;
                padding: 12px;
            }

            #smartStrategyOptions > div {
                grid-template-columns: 1fr !important;
            }

            .strategy-checkbox-label {
                padding: 12px;
                border-radius: 8px;
                font-size: 0.85em;
            }

            .strategy-content {
                gap: 8px;
            }

            .strategy-title {
                font-size: 0.9em;
            }

            .strategy-desc {
                font-size: 0.75em;
            }

            .strategy-checkmark {
                width: 24px;
                height: 24px;
                font-size: 1em;
            }

            /* Portfolio type cards */
            .portfolio-type-card {
                padding: 12px;
                border-radius: 8px;
            }

            .portfolio-icon {
                font-size: 2em;
            }

            .portfolio-title {
                font-size: 0.95em;
            }

            .portfolio-desc {
                font-size: 0.8em;
            }

            /* Risky config */
            #riskyStrategyConfig {
                margin-top: 12px;
                padding: 12px;
                border-radius: 8px;
            }

            #riskyStrategyConfig > h4 {
                font-size: 0.9em;
                margin-bottom: 12px;
            }

            #riskyStrategyConfig > div {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }

            #riskyStrategyConfig label {
                font-size: 0.85em;
            }

            #riskyStrategyConfig input {
                padding: 10px;
                font-size: 14px;
            }

            /* Form inputs - important for mobile UX */
            input,
            select,
            textarea {
                width: 100%;
                padding: 12px;
                font-size: 16px;
                border-radius: 6px;
                border: 2px solid #e5e7eb;
                font-family: inherit;
                -webkit-appearance: none;
                appearance: none;
            }

            input:focus,
            select:focus,
            textarea:focus {
                border-color: #c41c16;
                outline: none;
                box-shadow: 0 0 0 3px rgba(196, 28, 22, 0.1);
            }

            label {
                font-size: 0.85em;
                display: block;
                margin-bottom: 6px;
                font-weight: 500;
            }

            /* Table responsiveness */
            table {
                font-size: 0.8em;
                overflow-x: auto;
                display: block;
            }

            table thead,
            table tbody {
                display: block;
                width: 100%;
            }

            table thead th,
            table tbody td {
                padding: 6px;
                text-align: left;
            }

            table tr {
                display: block;
                margin-bottom: 12px;
                border: 1px solid #e5e7eb;
                border-radius: 4px;
            }

            table td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #64748b;
                min-width: 100px;
                display: inline-block;
            }

            /* Scrollable containers */
            .card-content {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Adjust warning/status boxes */
            #marginCallWarning,
            #marginStatusGood {
                padding: 12px;
                margin-bottom: 12px;
                border-radius: 8px;
            }

            #marginCallWarning > div,
            #marginStatusGood > div {
                gap: 10px;
            }

            #marginCallWarning > div > div:first-child,
            #marginStatusGood > div > div:first-child {
                font-size: 2em;
                min-width: 50px;
            }

            #marginCallWarning h3,
            #marginStatusGood h3 {
                font-size: 0.95em;
                margin-bottom: 6px;
            }

            #marginCallWarning p,
            #marginStatusGood p {
                font-size: 0.8em;
            }
        }

        /* Extra small devices (under 480px) */
        @media (max-width: 380px) {
            .logo-text {
                font-size: 0.85em;
            }

            .header h1 {
                font-size: 1em;
            }

            .card h2 {
                font-size: 0.95em;
            }

            .strategy-checkbox-label {
                padding: 10px;
                font-size: 0.8em;
            }

            .btn {
                font-size: 0.85em;
                padding: 10px 12px;
            }

            .metric-value {
                font-size: 1em;
            }

            input,
            select {
                font-size: 14px;
            }
        }

    </style>
    <script src="js/collapsible.js"></script>
    <script src="js/logo.js"></script>
    <script src="js/api-config.js"></script>
    <script src="js/stock-categories.js"></script>
    <script src="js/data-api.js"></script>
    <script src="js/custom-dialogs.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/currency.js"></script>
    <script src="js/exchange-utils.js"></script>
</head>
<body>
    <nav class="top-nav">
        <div class="nav-container">
            <div class="logo-section">
                <span class="logo-icon">ğŸ“Š</span>
                <a href="index.html" class="logo-text">VNStock Analytics</a>
                <span class="page-title" data-i18n="portfolio.title">Portfolio Analytics</span>
            </div>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div class="nav-menu">
                    <button class="menu-btn" onclick="toggleMenu()">
                        ğŸ“Š Dashboards
                        <span id="menuArrow">â–¼</span>
                    </button>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <div class="menu-header" data-i18n="menu.all_dashboards">All Dashboards</div>

                        <div class="menu-category" data-i18n="menu.market_analysis">ğŸ“Š Market Analysis</div>
                        <div class="menu-items">
                            <a href="dashboard.html" class="menu-item">
                                <span class="menu-item-icon">ğŸ“Š</span>
                                <span data-i18n="nav.dashboard">Main Dashboard</span>
                            </a>
                            <a href="dashboard_history.html" class="menu-item">
                                <span class="menu-item-icon">ğŸ“Š</span>
                                <span data-i18n="nav.history">Historical Analysis</span>
                            </a>
                            <a href="advanced_charts.html" class="menu-item">
                                <span class="menu-item-icon">ğŸ“‰</span>
                                <span data-i18n="nav.charts">Advanced Charts</span>
                            </a>
                        </div>

                        <div class="menu-category" data-i18n="menu.investment_tools">ğŸ’¼ Investment Tools</div>
                        <div class="menu-items">
                            <a href="price_forecast.html" class="menu-item">
                                <span class="menu-item-icon">ğŸ”®</span>
                                <span>Price Forecasting</span>
                            </a>
                            <a href="dashboard_advanced.html" class="menu-item">
                                <span class="menu-item-icon">ğŸ“Š</span>
                                <span data-i18n="nav.portfolio_analytics">Portfolio Analytics</span>
                            </a>
                            <a href="macro_analysis.html" class="menu-item">
                                <span class="menu-item-icon">ğŸŒ</span>
                                <span data-i18n="nav.macro">Macro Analysis</span>
                            </a>
                        </div>

                        <div class="menu-category" data-i18n="menu.automation_alerts">ğŸ”” Automation & Alerts</div>
                        <div class="menu-items">
                            <a href="alerts_system.html" class="menu-item">
                                <span class="menu-item-icon">ğŸ””</span>
                                <span data-i18n="nav.alerts">Price Alerts</span>
                            </a>
                            <a href="trading_automation.html" class="menu-item">
                                <span class="menu-item-icon">ğŸ¤–</span>
                                <span data-i18n="nav.automation">Trading Automation</span>
                            </a>
                        </div>
                    <a href="settings.html" class="menu-item">
                            <span class="menu-item-icon">âš™ï¸</span>
                            <span data-i18n="nav.settings">Settings</span>
                        </a>

                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1 data-i18n="page.advanced_analytics">ğŸš€ Advanced Analytics Dashboard</h1>
            <p style="color: #666; font-size: 1.1em; margin-bottom: 8px;">Professional-Grade Stock Analysis Tools</p>
            <div style="margin-top: 16px; padding: 10px 16px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 8px; display: inline-block;">
                <span style="color: white; font-weight: 600;">ğŸ“… <span data-i18n="common.analysis_date">Analysis Date</span>:</span>
                <span id="analysisTimestamp" style="color: white; font-weight: 500; margin-left: 8px;">Loading...</span>
            </div>
        </div>

        <!-- Feature Overview -->
        <div class="card">
            <h2 data-i18n="advanced.title">ğŸ¯ Advanced Features</h2>
            <div class="feature-grid">
                <div class="feature-box" onclick="switchTab('portfolio')">
                    <h3 data-i18n="portfolio.title">ğŸ“Š Portfolio Analytics</h3>
                    <p data-i18n="advanced.portfolio_desc">Risk metrics, diversification, asset allocation, Sharpe ratio, max drawdown</p>
                </div>
                <div class="feature-box" onclick="switchTab('backtesting')">
                    <h3 data-i18n="advanced.strategy_backtesting">â®ï¸ Strategy Backtesting</h3>
                    <p data-i18n="advanced.backtesting_desc">Test trading strategies, simulate trades, performance analysis</p>
                </div>
                <div class="feature-box" onclick="switchTab('risk')">
                    <h3 data-i18n="advanced.risk_management">âš ï¸ Risk Management</h3>
                    <p data-i18n="advanced.risk_desc">VaR, CVaR, Beta, correlation matrix, volatility analysis</p>
                </div>
                <div class="feature-box" onclick="switchTab('patterns')">
                    <h3 data-i18n="advanced.pattern_recognition">ğŸ” Pattern Recognition</h3>
                    <p data-i18n="advanced.patterns_desc">Chart patterns, candlestick patterns, support/resistance</p>
                </div>
                <div class="feature-box" onclick="switchTab('ml')">
                    <h3 data-i18n="advanced.machine_learning">ğŸ§  Machine Learning</h3>
                    <p data-i18n="advanced.ml_desc">LSTM forecasting, ensemble models, feature importance</p>
                </div>
                <div class="feature-box" onclick="switchTab('correlation')">
                    <h3 data-i18n="advanced.correlation_analysis">ğŸ”— Correlation Analysis</h3>
                    <p data-i18n="advanced.correlation_desc">Stock correlations, sector analysis, pair trading opportunities</p>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs">
            <div class="tab active" data-tab="portfolio" onclick="switchTab('portfolio')" data-i18n="portfolio.title">Portfolio Analytics</div>
            <div class="tab" data-tab="savedplans" onclick="switchTab('savedplans')" data-i18n="portfolio.saved_plans">ğŸ“Š My Saved Plans</div>
            <div class="tab" data-tab="backtesting" onclick="switchTab('backtesting')" data-i18n="tag.backtesting">Backtesting</div>
            <div class="tab" data-tab="risk" onclick="switchTab('risk')" data-i18n="automation.risk_management">Risk Management</div>
            <div class="tab" data-tab="margin" onclick="switchTab('margin')"><span data-i18n="advanced.tab.margin">ğŸ’³ Margin Management</span></div>
            <div class="tab" data-tab="patterns" onclick="switchTab('patterns')" data-i18n="advanced.tab.patterns">Pattern Recognition</div>
            <div class="tab" data-tab="ml" onclick="switchTab('ml')"><span data-i18n="advanced.tab.ml">ğŸ§  Machine Learning</span></div>
            <div class="tab" data-tab="correlation" onclick="switchTab('correlation')" data-i18n="advanced.tab.correlation">Correlation Analysis</div>
        </div>

        <!-- Portfolio Analytics Tab -->
        <div class="tab-content active" id="portfolio">
            <h2 style="margin-bottom: 20px;" data-i18n="portfolio.plan_generator">ğŸ“Š Investment Plan Generator</h2>
            <div class="alert alert-info" style="margin-bottom: 30px;">
                Build your personalized investment portfolio in 5 simple steps
            </div>

            <!-- PART 1: OPTION FILTERS -->
            <div id="optionFiltersSection">

                    <!-- Step 1: Strategy Selection -->
                    <div class="card collapsible" style="margin-bottom: 30px; padding: 25px; background: white; border-radius: 12px; border: 2px solid #dc2626; ">
                        <h3 style="color: #1f2937; margin-bottom: 20px; font-size: 1.3em;">
                            <span style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); color: white; border-radius: 50%; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 10px;">1</span>
                            Choose Investment Strategy
                        </h3>

                        <div class="card-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div id="smartStrategyCard" onclick="selectStrategy('smart')" style="cursor: pointer; padding: 20px; background: white; border: 3px solid #e2e8f0; border-radius: 12px; transition: all 0.3s;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="font-size: 3.5em; margin-bottom: 10px;">ğŸ¤–</div>
                                    <h4 style="color: #1e40af; margin: 0 0 10px 0; font-size: 1.2em;" data-i18n="dashboard.smart_strategies">Smart Strategies</h4>
                                    <p style="color: #64748b; font-size: 0.9em; margin: 0;">AI-powered selection</p>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #f1f5f9; border-radius: 6px; font-size: 0.85em; color: #475569;">
                                    âœ“ Automated<br>âœ“ Optimized<br>âœ“ 4 Strategies
                                </div>
                            </div>

                            <div id="manualStrategyCard" onclick="selectStrategy('manual')" style="cursor: pointer; padding: 20px; background: white; border: 3px solid #e2e8f0; border-radius: 12px; transition: all 0.3s;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="font-size: 3.5em; margin-bottom: 10px;">ğŸ‘¤</div>
                                    <h4 style="color: #1e40af; margin: 0 0 10px 0; font-size: 1.2em;" data-i18n="dashboard.manual_selection">Manual Selection</h4>
                                    <p style="color: #64748b; font-size: 0.9em; margin: 0;">Pick stocks yourself</p>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #f1f5f9; border-radius: 6px; font-size: 0.85em; color: #475569;">
                                    âœ“ Full Control<br>âœ“ Any Stocks<br>âœ“ Custom Mix
                                </div>
                            </div>
                        </div>

                        <div id="smartStrategyOptions" style="display: none; margin-top: 20px; padding: 20px; background: white; border-radius: 10px;">
                            <h4 style="color: #5b21b6; margin-bottom: 15px;">Select one strategy:</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <label class="strategy-checkbox-label" data-strategy="balanced" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                                    <input type="checkbox" class="strategy-checkbox" name="strategyChoice" value="balanced" onchange="selectSmartStrategy(this)">
                                    <div class="strategy-content">
                                        <div class="strategy-title">âš–ï¸ Balanced</div>
                                        <div class="strategy-desc">Risk-adjusted returns</div>
                                    </div>
                                    <div class="strategy-checkmark">âœ“</div>
                                </label>
                                <label class="strategy-checkbox-label" data-strategy="growth" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                    <input type="checkbox" class="strategy-checkbox" name="strategyChoice" value="growth" onchange="selectSmartStrategy(this)">
                                    <div class="strategy-content">
                                        <div class="strategy-title">ğŸ“ˆ High Growth</div>
                                        <div class="strategy-desc">Maximum returns</div>
                                    </div>
                                    <div class="strategy-checkmark">âœ“</div>
                                </label>
                                <label class="strategy-checkbox-label" data-strategy="conservative" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                                    <input type="checkbox" class="strategy-checkbox" name="strategyChoice" value="conservative" onchange="selectSmartStrategy(this)">
                                    <div class="strategy-content">
                                        <div class="strategy-title">ğŸ›¡ï¸ Conservative</div>
                                        <div class="strategy-desc">Lowest risk</div>
                                    </div>
                                    <div class="strategy-checkmark">âœ“</div>
                                </label>
                                <label class="strategy-checkbox-label" data-strategy="bluechip" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                    <input type="checkbox" class="strategy-checkbox" name="strategyChoice" value="bluechip" onchange="selectSmartStrategy(this)">
                                    <div class="strategy-content">
                                        <div class="strategy-title">â­ Blue Chip</div>
                                        <div class="strategy-desc">Market leaders</div>
                                    </div>
                                    <div class="strategy-checkmark">âœ“</div>
                                </label>
                                <label class="strategy-checkbox-label" data-strategy="risky" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                                    <input type="checkbox" class="strategy-checkbox" name="strategyChoice" value="risky" onchange="selectSmartStrategy(this)">
                                    <div class="strategy-content">
                                        <div class="strategy-title">ğŸš€ Risky</div>
                                        <div class="strategy-desc">Highest potential</div>
                                    </div>
                                    <div class="strategy-checkmark">âœ“</div>
                                </label>
                            </div>

                            <!-- Risky Strategy Configuration -->
                            <div id="riskyStrategyConfig" style="display: none; margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border-radius: 10px; border: 2px solid #ef4444;">
                                <h4 style="color: #7f1d1d; margin-bottom: 15px; margin-top: 0;">âš™ï¸ Risky Strategy Configuration</h4>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="display: block; color: #1f2937; font-weight: 600; margin-bottom: 8px; font-size: 0.95em;">
                                            ğŸ“Š Maximum Stock Price (VND)
                                        </label>
                                        <input type="number" id="riskyMaxPrice" placeholder="e.g., 500000" style="width: 100%; padding: 12px; border: 2px solid #fca5a5; border-radius: 6px; font-size: 1em;" min="0" step="1000">
                                        <p style="margin: 8px 0 0 0; color: #64748b; font-size: 0.85em;">Only include stocks below this price</p>
                                    </div>

                                    <div>
                                        <label style="display: block; color: #1f2937; font-weight: 600; margin-bottom: 8px; font-size: 0.95em;">
                                            ğŸ¯ Target Return Potential (%)
                                        </label>
                                        <input type="number" id="riskyTargetReturn" placeholder="e.g., 50" style="width: 100%; padding: 12px; border: 2px solid #fca5a5; border-radius: 6px; font-size: 1em;" min="0" max="500" step="5">
                                        <p style="margin: 8px 0 0 0; color: #64748b; font-size: 0.85em;">Expected return potential (higher risk for higher returns)</p>
                                    </div>
                                </div>

                                <div style="margin-top: 15px; padding: 12px; background: #fee2e2; border-radius: 6px; border-left: 4px solid #ef4444;">
                                    <p style="margin: 0; color: #7f1d1d; font-size: 0.9em;">
                                        <strong>âš ï¸ Risk Warning:</strong> The risky strategy focuses on high-growth small-cap stocks. This is suitable for aggressive investors with high risk tolerance. Potential for high returns comes with higher volatility.
                                    </p>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- Step 2: Portfolio Type -->
                    <div class="card collapsible" style="margin-bottom: 30px; padding: 25px; background: white; border-radius: 12px; border: 2px solid #dc2626; ">
                        <h3 style="color: #1f2937; margin-bottom: 20px; font-size: 1.3em;">
                            <span style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); color: white; border-radius: 50%; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 10px;">2</span>
                            Choose Portfolio Type
                        </h3>

                        <div class="card-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div id="existingPortfolioCard" onclick="console.log('existingPortfolioCard clicked'); selectPortfolioType('existing')" style="cursor: pointer; padding: 20px; background: white; border: 3px solid #e2e8f0; border-radius: 12px; transition: all 0.3s;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="font-size: 3.5em; margin-bottom: 10px;">ğŸ“‚</div>
                                    <h4 style="color: #1e40af; margin: 0 0 10px 0; font-size: 1.2em;" data-i18n="dashboard.existing_portfolio">Existing Portfolio</h4>
                                    <p style="color: #64748b; font-size: 0.9em; margin: 0;">I already own stocks</p>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #f1f5f9; border-radius: 6px; font-size: 0.85em; color: #475569;">
                                    âœ“ Analyze holdings<br>âœ“ Get advice<br>âœ“ Optimize
                                </div>
                            </div>

                            <div id="newPortfolioCard" onclick="selectPortfolioType('new')" style="cursor: pointer; padding: 20px; background: white; border: 3px solid #e2e8f0; border-radius: 12px; transition: all 0.3s;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="font-size: 3.5em; margin-bottom: 10px;">âœ¨</div>
                                    <h4 style="color: #1e40af; margin: 0 0 10px 0; font-size: 1.2em;" data-i18n="dashboard.new_portfolio">New Portfolio</h4>
                                    <p style="color: #64748b; font-size: 0.9em; margin: 0;">Starting fresh</p>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #f1f5f9; border-radius: 6px; font-size: 0.85em; color: #475569;">
                                    âœ“ Build new<br>âœ“ Fresh start<br>âœ“ No holdings
                                </div>
                            </div>
                        </div>

                        <div id="existingHoldingsInput" style="display: none; margin-top: 20px; padding: 20px; background: #f9fafb; border-radius: 10px; border: 2px solid #dc2626;">
                            <h4 style="color: #1f2937; margin-bottom: 15px;">ğŸ“Š Enter Your Current Holdings</h4>

                            <!-- Load from saved plan -->
                            <div style="margin-bottom: 15px; padding: 14px; background: #eff6ff; border-radius: 8px; border: 1px solid #bfdbfe;">
                                <label style="display: block; font-weight: 600; color: #1e40af; margin-bottom: 8px; font-size: 0.95em;">ğŸ“‚ Load from Saved Plan (optional)</label>
                                <div style="display: flex; gap: 10px;">
                                    <select id="savedPlanSelect" onchange="loadHoldingsFromSavedPlan()" style="flex: 1; height: 38px; padding: 0 12px; border: 1px solid #93c5fd; border-radius: 6px; font-size: 0.95em; background: white;">
                                        <option value="">-- Select a saved plan --</option>
                                    </select>
                                    <button onclick="loadHoldingsFromSavedPlan()" style="height: 38px; padding: 0 16px; background: linear-gradient(135deg, #1d4ed8 0%, #2563eb 100%); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; white-space: nowrap;">Load</button>
                                </div>
                            </div>

                            <p style="color: #64748b; font-size: 0.9em; margin-bottom: 15px;">
                                Or enter manually â€” list all stocks you currently own.
                            </p>
                            <div id="holdingsListContainer" style="display: grid; gap: 12px; margin-bottom: 15px;"></div>
                            <button onclick="console.log('Add Stock button clicked'); addHoldingRow()" style="padding: 10px 20px; background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                â• Add Stock
                            </button>
                            <div style="margin-top: 15px; padding: 12px; background: #fee2e2; border-radius: 6px; border-left: 4px solid #dc2626; font-size: 0.9em; color: #1f2937;">
                                <strong>ğŸ’¡ <span data-i18n="tip.add_all_stocks">Tip: Add all stocks you own. We'll suggest HOLD, BUY MORE, or SELL.</span></strong>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- Step 3: Preferred Stocks -->
                    <div class="card collapsible" style="margin-bottom: 30px; padding: 25px; background: white; border-radius: 12px; border: 2px solid #dc2626; ">
                        <h3 style="color: #1f2937; margin-bottom: 20px; font-size: 1.3em; display: flex; align-items: center;">
                            <span style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); color: white; border-radius: 50%; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 10px;">3</span>
                            Select Preferred Stocks
                            <span style="font-size: 0.7em; color: #6b7280; font-weight: 500; margin-left: 10px;">(Optional)</span>
                        </h3>

                        <div class="card-content">
                        <div style="padding: 20px; background: white; border-radius: 10px;">
                            <p style="color: #64748b; font-size: 0.9em; margin-bottom: 15px;">
                                Choose stocks you want to prioritize. The system will include these first.
                            </p>
                            <div style="display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap;">
                                <input type="text" class="search-box-small" id="portfolioSearchBox" placeholder="ğŸ” Search stocks..." oninput="filterPortfolioStocks()" style="flex: 1; min-width: 150px; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px;">
                                <select id="portfolioExchangeFilter" style="padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.95em; cursor: pointer;" onchange="filterPortfolioStocks()">
                                    <option value="">All Exchanges</option>
                                    <option value="HOSE">ğŸ›ï¸ HOSE</option>
                                    <option value="HNX">ğŸ“ HNX</option>
                                    <option value="UPCOM">â­ UPCOM</option>
                                </select>
                            </div>
                            <div class="checkbox-controls">
                                <button class="btn-small" onclick="clearAllPortfolio()">âœ— Clear All</button>
                                <span class="selection-count" id="portfolioCount" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); color: white;">0 selected</span>
                            </div>
                            <div class="checkbox-grid" id="portfolioStocks" style="max-height: 250px; background: #f9fafb;">
                                <div style="grid-column: 1/-1; text-align: center; color: #64748b;">Loading...</div>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- Step 4: Budget & Generate -->
                    <div style="margin-bottom: 30px; padding: 25px; background: white; border-radius: 12px; border: 2px solid #dc2626; ">
                        <h3 style="color: #1f2937; margin-bottom: 20px; font-size: 1.3em;">
                            <span style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); color: white; border-radius: 50%; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 10px;">4</span>
                            Enter Budget & Generate Plan
                        </h3>

                        <div style="background: white; padding: 20px; border-radius: 10px;">
                            <label style="display: block; margin-bottom: 10px; color: #075985; font-weight: 600; font-size: 1.1em;">
                                ğŸ’° Investment Budget (VND)
                            </label>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <input type="text" id="investmentBudget" placeholder="100,000,000" style="flex: 1; padding: 16px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1.2em; font-weight: 600;" oninput="formatBudgetInput(this)" onblur="formatBudgetInput(this)">
                                <span style="color: #64748b; font-weight: 600; font-size: 1.1em;">VND</span>
                            </div>
                            <p style="margin: 0 0 20px 0; color: #64748b; font-size: 0.9em;">
                                ğŸ’¡ The total amount you want to invest
                            </p>

                            <button onclick="generateInvestmentPlan()" style="width: 100%; padding: 20px; background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); color: white; border: none; border-radius: 10px; font-size: 1.3em; font-weight: 700; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
                                ğŸš€ Generate Investment Plan
                            </button>
                        </div>
                    </div>

                </div>

                <!-- Investment Plan Results -->
                <div id="investmentPlanResultsWrapper" class="card collapsible" style="display: none; margin-bottom: 30px; padding: 25px; background: white; border-radius: 12px; border: 2px solid #dc2626; ">
                    <h3 style="color: #1f2937; margin-bottom: 20px; font-size: 1.3em; display: flex; justify-content: space-between; align-items: center; gap: 24px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center;">
                            <span style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 50%; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 10px;">âœ“</span>
                            <span data-i18n="portfolio.investment_plan_results">Investment Plan Results</span>
                        </div>
                        <div style="display: flex; gap: 12px;" onclick="event.stopPropagation();">
                            <button onclick="savePlanModal(); event.stopPropagation();" style="padding: 12px 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
                                ğŸ’¾ Save Plan
                            </button>
                            <button onclick="exportPlanReport(); event.stopPropagation();" style="padding: 12px 20px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
                                ğŸ“„ Export Report
                            </button>
                        </div>
                    </h3>

                    <div class="card-content">
                        <div style="margin-bottom: 20px; padding: 20px; background: #f0fdf4; border-radius: 10px; border-left: 4px solid #10b981;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span style="font-size: 1.5em;">âœ…</span>
                                <strong style="color: #065f46; font-size: 1.1em;" data-i18n="portfolio.plan_ready">Investment Plan Ready!</strong>
                            </div>
                            <div id="planStrategyName" style="font-size: 1em; color: #047857; font-weight: 600; margin-bottom: 4px;"></div>
                            <div id="planPortfolioType" style="font-size: 0.9em; color: #059669;"></div>
                        </div>

                        <div class="metrics-grid" style="margin-bottom: 30px;">
                            <div class="metric-card"><div class="metric-label" data-i18n="portfolio.total_value">Total Value</div><div class="metric-value" id="portfolioValue">0</div></div>
                            <div class="metric-card"><div class="metric-label" data-i18n="portfolio.expected_return">Expected Return</div><div class="metric-value" id="expectedReturn">0%</div></div>
                            <div class="metric-card"><div class="metric-label" data-i18n="portfolio.portfolio_risk">Portfolio Risk (Ïƒ)</div><div class="metric-value" id="portfolioRisk">0%</div></div>
                            <div class="metric-card"><div class="metric-label" data-i18n="portfolio.sharpe_ratio">Sharpe Ratio</div><div class="metric-value" id="sharpeRatio">0</div></div>
                            <div class="metric-card"><div class="metric-label" data-i18n="portfolio.max_drawdown">Max Drawdown</div><div class="metric-value" id="maxDrawdown">0%</div></div>
                            <div class="metric-card"><div class="metric-label" data-i18n="portfolio.diversification">Diversification</div><div class="metric-value" id="diversification">0%</div></div>
                        </div>

                        <div class="chart-container" style="margin-bottom: 30px;"><canvas id="allocationChart"></canvas></div>
                        <div class="chart-container" style="margin-bottom: 30px;"><canvas id="efficientFrontierChart"></canvas></div>

                        <div id="existingHoldingsSummary"></div>

                        <div class="card collapsible" style="background: #f9fafb; padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e5e7eb;">
                            <h3 style="color: #1e40af; margin-bottom: 20px; font-size: 1.2em; font-weight: 700; cursor: pointer;">ğŸ“Š <span data-i18n="portfolio.recommended_holdings">Recommended Holdings</span></h3>
                            <div class="card-content">
                                <div id="holdingsTableContainer">LOADING...</div>
                            </div>
                        </div>

                    <div class="card collapsible" style="background: #f9fafb; padding: 25px; border-radius: 12px; border: 1px solid #e5e7eb;">
                        <h3 style="color: #1e40af; margin-bottom: 20px; font-size: 1.2em; font-weight: 700; cursor: pointer;">ğŸ“‹ <span data-i18n="portfolio.investment_summary">Investment Summary</span></h3>
                        <div class="card-content">
                            <div id="investmentSummaryContainer">LOADING...</div>
                        </div>
                    </div>
                    </div>
                </div>

        </div>

        <!-- Saved Plans Tab -->
        <div class="tab-content" id="savedplans">
            <div class="card">
                <h2>ğŸ“Š <span data-i18n="portfolio.my_saved_plans">My Saved Investment Plans</span></h2>
                <div class="card-content">
                    <p style="color: #64748b; margin-bottom: 20px;" data-i18n="portfolio.saved_plans_desc">
                        Track and compare your saved investment plans. See how they perform over time with current market prices.
                    </p>

                    <div id="savedPlansList" style="display: grid; gap: 20px;">
                        <!-- Saved plans will be loaded here -->
                        <div style="text-align: center; padding: 40px; color: #94a3b8;">
                            <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“Š</div>
                            <p data-i18n="portfolio.no_saved_plans">No saved plans yet. Create and save an investment plan to track its performance!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backtesting Tab -->
        <div class="tab-content" id="backtesting">
            <div class="card collapsible">
                <h2 data-i18n="advanced.strategy_backtesting">â®ï¸ Strategy Backtesting</h2>
                <div class="card-content">
                <div class="alert alert-info" data-i18n="advanced.backtesting_info">
                    Test your trading strategies on historical data. See how your strategy would have performed.
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label><strong data-i18n="form.select_stock">Select Stock:</strong></label>
                        <select id="backtestStock">
                            <option value="" data-i18n="form.loading">-- Loading --</option>
                        </select>
                    </div>
                    <div>
                        <label><strong data-i18n="strategy.select">Strategy:</strong></label>
                        <select id="strategySelect">
                            <option value="sma_crossover" data-i18n="backtest.sma_crossover">SMA Crossover (20/50)</option>
                            <option value="rsi_oversold" data-i18n="backtest.rsi_strategy">RSI Oversold/Overbought</option>
                            <option value="macd" data-i18n="backtest.macd_signal">MACD Signal</option>
                            <option value="bollinger" data-i18n="backtest.bollinger_breakout">Bollinger Breakout</option>
                        </select>
                    </div>
                </div>

                <button class="btn" onclick="runBacktest()">ğŸš€ <span data-i18n="backtest.run_button">Run Backtest</span></button>

                <div id="backtestResults" style="display: none;">
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label" data-i18n="metric.total_return">Total Return</div>
                            <div class="metric-value" id="totalReturn">0%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label" data-i18n="metric.win_rate">Win Rate</div>
                            <div class="metric-value" id="winRate">0%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label" data-i18n="metric.total_trades">Total Trades</div>
                            <div class="metric-value" id="totalTrades">0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label" data-i18n="metric.avg_trade">Avg Trade P/L</div>
                            <div class="metric-value" id="avgTrade">0%</div>
                        </div>
                    </div>

                    <div class="chart-container large">
                        <canvas id="backtestChart"></canvas>
                    </div>

                    <h3 style="margin: 20px 0;" data-i18n="section.trade_history">Trade History</h3>
                    <div id="tradeHistory"></div>
                </div>
                </div>
            </div>
        </div>

        <!-- Risk Management Tab -->
        <div class="tab-content" id="risk">
            <div class="card collapsible">
                <h2 data-i18n="advanced.risk_management">âš ï¸ Risk Management</h2>
                <div class="card-content">
                <div class="alert alert-warning" data-i18n="advanced.risk_info">
                    Advanced risk metrics to help you understand and manage investment risk.
                </div>

                <div>
                    <label><strong data-i18n="risk.select_stocks">Select Stocks:</strong></label>
                    <input type="text"
                           class="search-box-small"
                           id="riskSearchBox"
                           data-i18n-placeholder="common.search_stocks"
                           placeholder="ğŸ” Search stocks..."
                           oninput="filterRiskStocks()">
                    <div class="checkbox-controls">
                        <button class="btn-small" onclick="selectAllRisk()">âœ“ <span data-i18n="common.all">All</span></button>
                        <button class="btn-small" onclick="clearAllRisk()">âœ— <span data-i18n="common.clear">Clear</span></button>
                        <button class="btn-small" onclick="selectVisibleRisk()">âœ“ <span data-i18n="common.visible">Visible</span></button>
                        <span class="selection-count" id="riskCount">0 <span data-i18n="common.selected">selected</span></span>
                    </div>
                    <div class="checkbox-grid" id="riskStocks">
                        <div style="grid-column: 1/-1; text-align: center; color: #64748b; font-size: 0.9em;" data-i18n="common.loading">Loading...</div>
                    </div>
                    <button class="btn" onclick="calculateRisk()" style="margin-top: 24px; width: 100%;">ğŸ“Š <span data-i18n="risk.calculate_button">Calculate Risk Metrics</span></button>
                </div>

                <div id="riskResults" style="display: none;">
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label" data-i18n="risk.var_95">Value at Risk (95%)</div>
                            <div class="metric-value" id="var95">0%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label" data-i18n="risk.cvar_95">CVaR (95%)</div>
                            <div class="metric-value" id="cvar95">0%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label" data-i18n="risk.avg_beta">Average Beta</div>
                            <div class="metric-value" id="avgBeta">0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label" data-i18n="risk.volatility">Volatility</div>
                            <div class="metric-value" id="volatility">0%</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="riskChart"></canvas>
                    </div>

                    <h3 style="margin: 20px 0;" data-i18n="risk.breakdown">Risk Breakdown by Stock</h3>
                    <div id="riskTable"></div>
                </div>
                </div>
            </div>
        </div>

        <!-- Margin Management Tab -->
        <div class="tab-content" id="margin">
            <div class="card collapsible">
                <h2 data-i18n="margin.title">ğŸ’³ Margin Management</h2>
                <div class="card-content">                <div class="alert alert-info" data-i18n="margin.intro">
                    Track and manage your margin account, monitor buying power, calculate margin requirements, and receive margin call warnings.
                </div>

                <!-- Margin Account Setup -->
                <div class="card collapsible" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #0ea5e9; margin-bottom: 25px;">
                    <h3 style="color: #0c4a6e; font-size: 1.2em;" data-i18n="margin.account_setup">ğŸ“‹ Margin Account Setup</h3>
                    <div class="card-content">

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #0c4a6e;" data-i18n="margin.cash_equity">
                                ğŸ’µ Total Cash Equity (â‚«)
                            </label>
                            <input type="number"
                                   id="cashEquity"
                                   placeholder="100,000,000"
                                   style="width: 100%; padding: 12px; border: 2px solid #0ea5e9; border-radius: 8px; font-size: 1em;"
                                   oninput="calculateMargin()">
                            <div style="font-size: 0.85em; color: #64748b; margin-top: 5px;" data-i18n="margin.cash_equity_hint">Your own cash invested</div>
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #0c4a6e;" data-i18n="margin.borrowed_amount">
                                ğŸ’° Borrowed Amount (â‚«)
                            </label>
                            <input type="number"
                                   id="borrowedAmount"
                                   placeholder="50,000,000"
                                   style="width: 100%; padding: 12px; border: 2px solid #0ea5e9; border-radius: 8px; font-size: 1em;"
                                   oninput="calculateMargin()">
                            <div style="font-size: 0.85em; color: #64748b; margin-top: 5px;" data-i18n="margin.borrowed_amount_hint">Funds borrowed from broker</div>
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #0c4a6e;" data-i18n="margin.margin_ratio">
                                ğŸ“Š Margin Ratio (%)
                            </label>
                            <input type="number"
                                   id="marginRatio"
                                   value="50"
                                   min="30"
                                   max="70"
                                   style="width: 100%; padding: 12px; border: 2px solid #0ea5e9; border-radius: 8px; font-size: 1em;"
                                   oninput="calculateMargin()">
                            <div style="font-size: 0.85em; color: #64748b; margin-top: 5px;" data-i18n="margin.margin_ratio_hint">Required equity percentage (typically 50%)</div>
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #0c4a6e;" data-i18n="margin.interest_rate">
                                ğŸ“ˆ Annual Interest Rate (%)
                            </label>
                            <input type="number"
                                   id="interestRate"
                                   value="10"
                                   step="0.1"
                                   style="width: 100%; padding: 12px; border: 2px solid #0ea5e9; border-radius: 8px; font-size: 1em;"
                                   oninput="calculateMargin()">
                            <div style="font-size: 0.85em; color: #64748b; margin-top: 5px;" data-i18n="margin.interest_hint">Annual borrowing cost</div>
                        </div>
                    </div>

                    <button class="btn" onclick="calculateMargin()" style="margin-top: 20px; width: 100%; background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); font-size: 1.05em;">
                        ğŸ”¢ <span data-i18n="margin.calculate_button">Calculate Margin Metrics</span>
                    </button>
                    </div>
                </div>

                <!-- Margin Overview Metrics -->
                <div id="marginOverview" style="display: none;">
                    <div class="card collapsible" style="margin-bottom: 25px;">
                        <h3 style="color: #1e293b;" data-i18n="margin.overview_heading">ğŸ“Š Margin Account Overview</h3>
                        <div class="card-content">
                            <div class="metrics-grid" style="margin-bottom: 25px;">
                        <div class="metric-card" style="background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%); border-left: 4px solid #3b82f6;">
                            <div class="metric-label" data-i18n="margin.total_value">Total Portfolio Value</div>
                            <div class="metric-value" id="totalPortfolioValue" style="color: #1e40af;">â‚«0</div>
                            <div style="font-size: 0.8em; color: #64748b; margin-top: 5px;" data-i18n="margin.total_value_hint">Cash + Borrowed</div>
                        </div>
                        <div class="metric-card" style="background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%); border-left: 4px solid #10b981;">
                            <div class="metric-label" data-i18n="margin.buying_power">Available Buying Power</div>
                            <div class="metric-value" id="buyingPower" style="color: #065f46;">â‚«0</div>
                            <div style="font-size: 0.8em; color: #64748b; margin-top: 5px;" data-i18n="margin.buying_power_hint">Can invest up to</div>
                        </div>
                        <div class="metric-card" style="background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%); border-left: 4px solid #f59e0b;">
                            <div class="metric-label" data-i18n="margin.current_ratio">Current Margin Ratio</div>
                            <div class="metric-value" id="currentMarginRatio" style="color: #92400e;">0%</div>
                            <div style="font-size: 0.8em; color: #64748b; margin-top: 5px;" data-i18n="margin.current_ratio_hint">Equity / Total Value</div>
                        </div>
                        <div class="metric-card" style="background: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%); border-left: 4px solid #ef4444;">
                            <div class="metric-label" data-i18n="margin.daily_interest">Daily Interest Cost</div>
                            <div class="metric-value" id="dailyInterest" style="color: #991b1b;">â‚«0</div>
                            <div style="font-size: 0.8em; color: #64748b; margin-top: 5px;" data-i18n="margin.daily_interest_hint">Per day borrowing cost</div>
                        </div>
                    </div>
                        </div>
                    </div>

                    <!-- Margin Call Warning -->
                    <div id="marginCallWarning" style="display: none; padding: 20px; background: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%); border-radius: 12px; border-left: 6px solid #dc2626; margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 3em;">âš ï¸</div>
                            <div>
                                <h3 style="color: #991b1b; margin: 0 0 8px 0;" data-i18n="margin.warning_title">MARGIN CALL WARNING</h3>
                                <p style="margin: 0; color: #7f1d1d; font-size: 1em; font-weight: 500;" data-i18n="margin.warning_message">
                                    Your margin ratio is below the required level. You may receive a margin call from your broker.
                                </p>
                                <p style="margin: 8px 0 0 0; color: #991b1b; font-size: 0.9em;" id="marginCallDetails"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Margin Status Indicator -->
                    <div id="marginStatusGood" style="display: none; padding: 20px; background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%); border-radius: 12px; border-left: 6px solid #10b981; margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 3em;">âœ…</div>
                            <div>
                                <h3 style="color: #065f46; margin: 0 0 8px 0;" data-i18n="margin.healthy_title">MARGIN ACCOUNT HEALTHY</h3>
                                <p style="margin: 0; color: #047857; font-size: 1em; font-weight: 500;" data-i18n="margin.healthy_message">
                                    Your margin ratio is above the required level. Your account is in good standing.
                                </p>
                                <p style="margin: 8px 0 0 0; color: #059669; font-size: 0.9em;" id="marginStatusDetails"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Interest Cost Breakdown -->
                    <div class="card collapsible" style="border: 2px solid #e2e8f0; margin-bottom: 25px;">
                        <h3 style="color: #1e293b;" data-i18n="margin.interest_analysis">ğŸ’¸ Interest Cost Analysis</h3>
                        <div class="card-content">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                            <div style="padding: 15px; background: #f8fafc; border-radius: 8px;">
                                <div style="font-size: 0.85em; color: #64748b; margin-bottom: 5px;" data-i18n="margin.daily_cost">Daily Cost</div>
                                <div style="font-size: 1.3em; font-weight: 700; color: #ef4444;" id="dailyCost">â‚«0</div>
                            </div>
                            <div style="padding: 15px; background: #f8fafc; border-radius: 8px;">
                                <div style="font-size: 0.85em; color: #64748b; margin-bottom: 5px;" data-i18n="margin.weekly_cost">Weekly Cost</div>
                                <div style="font-size: 1.3em; font-weight: 700; color: #f59e0b;" id="weeklyCost">â‚«0</div>
                            </div>
                            <div style="padding: 15px; background: #f8fafc; border-radius: 8px;">
                                <div style="font-size: 0.85em; color: #64748b; margin-bottom: 5px;" data-i18n="margin.monthly_cost">Monthly Cost</div>
                                <div style="font-size: 1.3em; font-weight: 700; color: #f97316;" id="monthlyCost">â‚«0</div>
                            </div>
                            <div style="padding: 15px; background: #f8fafc; border-radius: 8px;">
                                <div style="font-size: 0.85em; color: #64748b; margin-bottom: 5px;" data-i18n="margin.yearly_cost">Yearly Cost</div>
                                <div style="font-size: 1.3em; font-weight: 700; color: #dc2626;" id="yearlyCost">â‚«0</div>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- Margin Position Tracker -->
                    <div class="card collapsible" style="border: 2px solid #e2e8f0; margin-bottom: 25px;">
                        <h3 style="color: #1e293b;" data-i18n="margin.position_requirements">ğŸ“ Position & Requirements</h3>
                        <div class="card-content">

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div>
                                <div style="font-size: 0.9em; color: #64748b; margin-bottom: 8px;" data-i18n="margin.initial_margin">Initial Margin Required</div>
                                <div style="font-size: 1.5em; font-weight: 700; color: #3b82f6;" id="initialMargin">â‚«0</div>
                                <div style="font-size: 0.8em; color: #94a3b8; margin-top: 3px;" data-i18n="margin.initial_margin_hint">Minimum to open position</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9em; color: #64748b; margin-bottom: 8px;" data-i18n="margin.maintenance_margin">Maintenance Margin</div>
                                <div style="font-size: 1.5em; font-weight: 700; color: #f59e0b;" id="maintenanceMargin">â‚«0</div>
                                <div style="font-size: 0.8em; color: #94a3b8; margin-top: 3px;" data-i18n="margin.maintenance_margin_hint">Must maintain above this</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9em; color: #64748b; margin-bottom: 8px;" data-i18n="margin.excess_margin">Excess Margin</div>
                                <div style="font-size: 1.5em; font-weight: 700; color: #10b981;" id="excessMargin">â‚«0</div>
                                <div style="font-size: 0.8em; color: #94a3b8; margin-top: 3px;" data-i18n="margin.excess_margin_hint">Safety buffer available</div>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- Leverage Analysis -->
                    <div class="card collapsible" style="border: 2px solid #e2e8f0; margin-bottom: 25px;">
                        <h3 style="color: #1e293b;" data-i18n="margin.leverage_analysis">âš¡ Leverage Analysis</h3>
                        <div class="card-content">

                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-weight: 600; color: #475569;" data-i18n="margin.current_leverage">Current Leverage</span>
                                <span style="font-weight: 700; font-size: 1.2em; color: #3b82f6;" id="currentLeverage">0.00x</span>
                            </div>
                            <div style="background: #e2e8f0; height: 12px; border-radius: 6px; overflow: hidden;">
                                <div id="leverageBar" style="height: 100%; background: linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #ef4444 100%); width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.8em; color: #94a3b8;">
                                <span>1.0x (<span data-i18n="margin.leverage_conservative">Conservative</span>)</span>
                                <span>2.0x (<span data-i18n="margin.leverage_moderate">Moderate</span>)</span>
                                <span>3.0x+ (<span data-i18n="margin.leverage_aggressive">Aggressive</span>)</span>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="padding: 15px; background: #f8fafc; border-radius: 8px; border: 2px solid #e2e8f0;">
                                <div style="font-size: 0.85em; color: #64748b; margin-bottom: 5px;" data-i18n="margin.max_leverage">Maximum Leverage</div>
                                <div style="font-size: 1.4em; font-weight: 700; color: #ef4444;" id="maxLeverage">0.00x</div>
                                <div style="font-size: 0.75em; color: #94a3b8; margin-top: 3px;" data-i18n="margin.max_leverage_hint">Based on margin ratio</div>
                            </div>
                            <div style="padding: 15px; background: #f8fafc; border-radius: 8px; border: 2px solid #e2e8f0;">
                                <div style="font-size: 0.85em; color: #64748b; margin-bottom: 5px;" data-i18n="margin.risk_level">Risk Level</div>
                                <div style="font-size: 1.4em; font-weight: 700;" id="riskLevel">-</div>
                                <div style="font-size: 0.75em; color: #94a3b8; margin-top: 3px;" data-i18n="margin.risk_level_hint">Based on current leverage</div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- Educational Info -->
                <div class="card collapsible" style="background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%); border-left: 6px solid #f59e0b; margin-bottom: 25px;">
                    <h3 style="color: #92400e;" data-i18n="margin.education_title">ğŸ’¡ Understanding Margin Trading</h3>
                    <div class="card-content">
                    <div style="color: #78350f; line-height: 1.7;">
                        <p style="margin: 0 0 10px 0;" data-i18n="margin.education_intro"><strong>Margin trading</strong> allows you to borrow money from your broker to purchase more stocks than you could with just your cash.</p>
                        <ul style="margin: 10px 0; padding-left: 25px;">
                            <li data-i18n="margin.education_buying_power"><strong>Buying Power:</strong> Total amount you can invest (your cash + borrowed funds)</li>
                            <li data-i18n="margin.education_margin_ratio"><strong>Margin Ratio:</strong> Percentage of equity required (typically 50% - you can borrow up to 50% of purchase)</li>
                            <li data-i18n="margin.education_margin_call"><strong>Margin Call:</strong> When equity falls below maintenance requirement, broker may force you to add funds or sell positions</li>
                            <li data-i18n="margin.education_interest"><strong>Interest:</strong> You pay daily interest on borrowed amounts</li>
                            <li data-i18n="margin.education_leverage"><strong>Leverage:</strong> Amplifies both gains and losses - use cautiously!</li>
                        </ul>
                        <p style="margin: 10px 0 0 0; font-weight: 600; color: #991b1b;" data-i18n="margin.education_warning">âš ï¸ Warning: Margin trading involves significant risk. You can lose more than your initial investment.</p>
                    </div>
                    </div>
                </div>
            </div>
                </div>        </div>

        <!-- Pattern Recognition Tab -->
        <div class="tab-content" id="patterns">
            <div class="card collapsible">
                <h2 data-i18n="advanced.pattern_recognition">ğŸ” Pattern Recognition</h2>
                <div class="card-content">                <div class="alert alert-info" data-i18n="patterns.info">
                    Automatic detection of chart patterns and candlestick formations.
                </div>

                <div>
                    <label><strong data-i18n="form.select_stock">Select Stock:</strong></label>
                    <select id="patternStock">
                        <option value="" data-i18n="common.loading">-- Loading --</option>
                    </select>
                    <button class="btn" onclick="detectPatterns()">ğŸ” <span data-i18n="patterns.detect_button">Detect Patterns</span></button>
                </div>

                <div id="patternResults" style="display: none;">
                    <div class="alert alert-success" id="patternAlert"></div>

                    <h3 style="margin: 20px 0;" data-i18n="patterns.detected_heading">Detected Patterns</h3>
                    <div id="patternList"></div>
                </div>
            </div>
        </div>
                </div>
        <!-- Machine Learning Tab -->
        <div class="tab-content" id="ml">
            <div class="card collapsible">
                <h2 data-i18n="advanced.machine_learning">ğŸ§  Machine Learning</h2>
                <div class="card-content">                <div class="alert alert-info" data-i18n="ml.info">
                    Advanced LSTM neural network predictions with confidence intervals.
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label><strong data-i18n="form.select_stock">Select Stock:</strong></label>
                        <select id="mlStock">
                            <option value="" data-i18n="common.loading">-- Loading --</option>
                        </select>
                    </div>
                    <div>
                        <label><strong data-i18n="ml.forecast_horizon">Forecast Horizon:</strong></label>
                        <select id="mlHorizon">
                            <option value="7" data-i18n="ml.7_days">7 Days</option>
                            <option value="14" data-i18n="ml.14_days">14 Days</option>
                            <option value="30" selected data-i18n="ml.30_days">30 Days</option>
                            <option value="60" data-i18n="ml.60_days">60 Days</option>
                        </select>
                    </div>
                </div>

                <button class="btn" onclick="runMLForecast()">ğŸš€ <span data-i18n="ml.generate_button">Generate ML Forecast</span></button>

                <div id="mlResults" style="display: none;">
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label" data-i18n="metric.model_accuracy">Model Accuracy</div>
                            <div class="metric-value" id="mlAccuracy">0%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label" data-i18n="metric.predicted_trend">Predicted Trend</div>
                            <div class="metric-value" id="mlTrend">--</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label" data-i18n="metric.confidence">Confidence</div>
                            <div class="metric-value" id="mlConfidence">0%</div>
                        </div>
                    </div>

                    <div class="chart-container large">
                        <canvas id="mlChart"></canvas>
                    </div>

                    <h3 style="margin: 20px 0;" data-i18n="ml.feature_importance">Feature Importance</h3>
                    <div class="chart-container">
                        <canvas id="featureChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

                </div>        <!-- Correlation Analysis Tab -->
        <div class="tab-content" id="correlation">
            <div class="card collapsible">
                <h2 data-i18n="advanced.correlation_analysis">ğŸ”— Correlation Analysis</h2>
                <div class="card-content">                <div class="alert alert-info" data-i18n="correlation.info">
                    Analyze correlations between stocks for diversification and pair trading.
                </div>

                <div>
                    <label><strong data-i18n="correlation.select_min_3">Select Stocks (min 3)</strong></label>
                    <input type="text"
                           class="search-box-small"
                           id="correlationSearchBox"
                           data-i18n-placeholder="form.placeholder_search"
                           placeholder="ğŸ” Search stocks..."
                           oninput="filterCorrelationStocks()">
                    <div class="checkbox-controls">
                        <button class="btn-small" onclick="selectAllCorrelation()">âœ“ <span data-i18n="common.all">All</span></button>
                        <button class="btn-small" onclick="clearAllCorrelation()">âœ— <span data-i18n="common.clear">Clear</span></button>
                        <button class="btn-small" onclick="selectVisibleCorrelation()">âœ“ <span data-i18n="common.visible">Visible</span></button>
                        <span class="selection-count" id="correlationCount"><span>0</span> <span data-i18n="common.selected">selected</span></span>
                    </div>
                    <div class="checkbox-grid" id="correlationStocks" style="max-height: 450px;">
                        <div style="grid-column: 1/-1; text-align: center; color: #64748b; font-size: 0.9em;" data-i18n="common.loading">Loading...</div>
                    </div>
                    <button class="btn" onclick="analyzeCorrelation()" style="margin-top: 24px; width: 100%;">ğŸ“Š <span data-i18n="correlation.analyze_button">Analyze Correlations</span></button>
                </div>

                <div id="correlationResults" style="display: none;">
                    <h3 style="margin: 20px 0;" data-i18n="correlation.matrix_heading">Correlation Matrix</h3>
                    <div id="correlationMatrix"></div>

                    <h3 style="margin: 20px 0;" data-i18n="correlation.heatmap_heading">Correlation Heatmap</h3>
                    <div class="chart-container large">
                        <canvas id="correlationHeatmap"></canvas>
                    </div>

                    <h3 style="margin: 20px 0;" data-i18n="correlation.pair_trading_heading">Pair Trading Opportunities</h3>
                    <div id="pairTrading"></div>
                </div>
            </div>
        </div>

                </div>
    </div>
                </div>

    <!-- ========== Investment Plan Results - MOVED HERE OUTSIDE ALL TABS ========== -->
    <script>
        let allStocks = [];
        let stockData = {};
        let currentPortfolioStocks = [];
        let charts = {};
        let stockNames = {}; // Stock symbol to name mapping
        let isAnalyzingRecommendations = false; // Lock flag to prevent concurrent analyses

        // Portfolio Analysis Results - shared across tabs
        let portfolioAnalysisResults = {
            analyzed: false,
            strategy: null,
            strategyName: null,
            portfolioValue: 0,
            totalReturn: 0,
            riskLevel: 0,
            sharpeRatio: 0,
            maxDrawdown: 0,
            diversification: 0,
            holdings: [],
            sectors: {},
            performance: {
                bestPerformer: null,
                worstPerformer: null,
                mostVolatile: null,
                mostStable: null
            },
            timestamp: null
        };

        // Debug function: Reset stuck analysis flag (call from console if needed)
        window.resetAnalysisLock = function() {
            console.log('ğŸ”§ Force resetting analysis lock');
            isAnalyzingRecommendations = false;
            enableStrategyCheckboxes();
            console.log('âœ… Analysis lock reset complete');
        };

        // Debug function: Check current lock status
        window.checkAnalysisLock = function() {
            console.log('ğŸ” Current isAnalyzingRecommendations:', isAnalyzingRecommendations);
            return isAnalyzingRecommendations;
        };

        // Expose flag to window for debugging
        window.getAnalysisLockStatus = () => isAnalyzingRecommendations;

        // New Portfolio Structure - State Variables
        let currentStrategy = null; // 'smart' or 'manual'
        let currentPortfolioType = null; // 'existing' or 'new'
        let currentSmartStrategy = null; // 'balanced', 'growth', 'conservative', 'bluechip'
        let holdingRowCounter = 0;

        // Step 1: Select Investment Strategy
        function selectStrategy(type) {
            console.log('ğŸ¯ selectStrategy called with type:', type);
            currentStrategy = type;

            // Update card styles
            const smartCard = document.getElementById('smartStrategyCard');
            const manualCard = document.getElementById('manualStrategyCard');

            if (!smartCard || !manualCard) {
                console.error('âŒ Strategy cards not found!');
                return;
            }

            if (type === 'smart') {
                smartCard.style.border = '3px solid #dc2626';
                smartCard.style.background = 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)';
                manualCard.style.border = '3px solid #e5e7eb';
                manualCard.style.background = 'white';

                // Show strategy options
                document.getElementById('smartStrategyOptions').style.display = 'block';

                // Auto-select Balanced on first selection
                if (!currentSmartStrategy) {
                    const balancedCheckbox = document.querySelector('.strategy-checkbox[value="balanced"]');
                    if (balancedCheckbox) {
                        balancedCheckbox.checked = true;
                        currentSmartStrategy = 'balanced';
                        balancedCheckbox.parentElement.style.opacity = '1';
                        balancedCheckbox.parentElement.style.transform = 'scale(1.05)';
                    }
                }
            } else {
                manualCard.style.border = '3px solid #dc2626';
                manualCard.style.background = 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)';
                smartCard.style.border = '3px solid #e5e7eb';
                smartCard.style.background = 'white';

                // Hide strategy options
                document.getElementById('smartStrategyOptions').style.display = 'none';
                currentSmartStrategy = null;
            }
        }

        // Handle strategy checkbox selection (only one can be selected)
        function selectSmartStrategy(checkbox) {
            const allCheckboxes = document.querySelectorAll('.strategy-checkbox');
            const riskyConfig = document.getElementById('riskyStrategyConfig');

            allCheckboxes.forEach(cb => {
                if (cb !== checkbox) {
                    cb.checked = false;
                    cb.parentElement.style.opacity = '0.7';
                    cb.parentElement.style.transform = 'scale(1)';
                }
            });

            if (checkbox.checked) {
                currentSmartStrategy = checkbox.value;
                checkbox.parentElement.style.opacity = '1';
                checkbox.parentElement.style.transform = 'scale(1.05)';

                // Show risky strategy config if risky is selected
                if (currentSmartStrategy === 'risky' && riskyConfig) {
                    riskyConfig.style.display = 'block';
                } else if (riskyConfig) {
                    // Hide config for other strategies
                    riskyConfig.style.display = 'none';
                }
            } else {
                currentSmartStrategy = null;
                checkbox.parentElement.style.opacity = '0.7';
                checkbox.parentElement.style.transform = 'scale(1)';

                // Hide risky strategy config
                if (riskyConfig) {
                    riskyConfig.style.display = 'none';
                }
            }
        }

        // Step 2: Select Portfolio Type
        function selectPortfolioType(type) {
            console.log('selectPortfolioType called:', type);
            currentPortfolioType = type;

            // Update card styles
            const existingCard = document.getElementById('existingPortfolioCard');
            const newCard = document.getElementById('newPortfolioCard');

            if (type === 'existing') {
                existingCard.style.border = '3px solid #dc2626';
                existingCard.style.background = 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)';
                newCard.style.border = '3px solid #e5e7eb';
                newCard.style.background = 'white';

                // Show holdings input
                document.getElementById('existingHoldingsInput').style.display = 'block';

                // Populate saved plan dropdown and auto-load first plan with holdings
                populateSavedPlanDropdown().then(() => {
                    // Auto-select first saved plan if available
                    const select = document.getElementById('savedPlanSelect');
                    if (select && select.options.length > 1) {
                        // Select first saved plan (index 1, skipping the placeholder at index 0)
                        select.selectedIndex = 1;
                        console.log('ğŸ“Š Auto-selected first saved plan:', select.options[1]?.textContent);

                        // Auto-load holdings from selected plan
                        setTimeout(() => {
                            loadHoldingsFromSavedPlan();
                        }, 200);
                    } else {
                        // No saved plans, add empty row
                        if (document.getElementById('holdingsListContainer').children.length === 0) {
                            console.log('ğŸ“ No saved plans, adding empty holding row');
                            addHoldingRow();
                        }
                    }
                }).catch(error => {
                    console.error('Error auto-loading holdings:', error);
                    // Fallback: add empty row
                    if (document.getElementById('holdingsListContainer').children.length === 0) {
                        addHoldingRow();
                    }
                });
            } else {
                newCard.style.border = '3px solid #dc2626';
                newCard.style.background = 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)';
                existingCard.style.border = '3px solid #e5e7eb';
                existingCard.style.background = 'white';

                // Hide holdings input
                document.getElementById('existingHoldingsInput').style.display = 'none';
            }
        }

        // Populate saved plan dropdown in existing holdings section
        async function populateSavedPlanDropdown() {
            const select = document.getElementById('savedPlanSelect');
            if (!select) return;
            select.innerHTML = '<option value="">-- Select a saved plan --</option>';
            try {
                const response = await fetch('/api/investment-plans', { credentials: 'include' });
                const result = await response.json();
                if (result.success && result.data && result.data.length > 0) {
                    result.data.forEach(plan => {
                        const option = document.createElement('option');
                        option.value = plan.id;
                        option.textContent = plan.name + (plan.createdDate ? ' (' + new Date(plan.createdDate).toLocaleDateString() + ')' : '');
                        option.dataset.holdings = JSON.stringify(plan.holdings || []);
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading saved plans for dropdown:', error);
            }
        }

        // Load holdings from selected saved plan into the holdings form
        function loadHoldingsFromSavedPlan() {
            const select = document.getElementById('savedPlanSelect');
            if (!select || !select.value) {
                showAlert('Please select a saved plan first.');
                return;
            }
            const selectedOption = select.options[select.selectedIndex];
            let holdings = [];
            try {
                holdings = JSON.parse(selectedOption.dataset.holdings || '[]');
            } catch (e) {
                showAlert('Error reading plan data.');
                return;
            }
            if (holdings.length === 0) {
                showAlert('The selected plan has no holdings.');
                return;
            }
            // Clear existing rows
            const container = document.getElementById('holdingsListContainer');
            container.innerHTML = '';
            holdingRowCounter = 0;
            // Add a row for each holding
            holdings.forEach(h => {
                holdingRowCounter++;
                const row = document.createElement('div');
                row.id = `holding-row-${holdingRowCounter}`;
                row.style.cssText = 'display: grid; grid-template-columns: 2fr 1.5fr 1.5fr 1fr auto; gap: 10px; align-items: center; margin-bottom: 10px; padding: 12px; background: #f8fafc; border-radius: 6px; border: 1px solid #e5e7eb;';
                const stockOptions = allStocks.map(sym => `<option value="${sym}" ${sym === h.symbol ? 'selected' : ''}>${sym} - ${stockNames[sym] || sym}</option>`).join('');
                row.innerHTML = `
                    <select class="holding-stock-select" style="padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.95em;">
                        <option value="">Select Stock...</option>
                        ${stockOptions}
                    </select>
                    <input type="number" placeholder="Shares owned" class="holding-shares" min="1" value="${h.shares || ''}"
                           style="padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.95em;">
                    <input type="number" placeholder="Buy price (VND)" class="holding-buy-price" min="0" step="1000" value="${h.buyPrice || h.priceAtCreation || ''}"
                           style="padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.95em;">
                    <div class="holding-current-value" style="font-weight: 600; color: #1e293b; font-size: 0.9em; text-align: center;">-</div>
                    <button onclick="removeHoldingRow('holding-row-${holdingRowCounter}')"
                            style="padding: 6px 10px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">âœ•</button>
                `;
                container.appendChild(row);
                const selectEl = row.querySelector('.holding-stock-select');
                const sharesInput = row.querySelector('.holding-shares');
                selectEl.addEventListener('change', () => updateHoldingValue(row));
                sharesInput.addEventListener('input', () => updateHoldingValue(row));
                updateHoldingValue(row);
            });
            showSuccess(`Loaded ${holdings.length} holdings from "${selectedOption.textContent.split(' (')[0]}"`);
        }

        // Add holding row
        // Note: addHoldingRow() and removeHoldingRow() are defined later in the file (line 3045+)
        // They are intentionally placed after the old portfolio code to avoid conflicts

        // Collect existing holdings data
        function collectExistingHoldings() {
            if (currentPortfolioType !== 'existing') {
                return [];
            }

            const holdings = [];
            const container = document.getElementById('holdingsListContainer');
            const rows = container.querySelectorAll('[id^="holding-row-"]');

            rows.forEach(row => {
                const symbolSelect = row.querySelector('.holding-stock-select');
                const symbol = symbolSelect ? symbolSelect.value.trim().toUpperCase() : '';
                const shares = parseFloat(row.querySelector('.holding-shares').value) || 0;
                const price = parseFloat(row.querySelector('.holding-buy-price').value) || 0;

                if (symbol && shares > 0 && price > 0) {
                    holdings.push({ symbol, shares, price });
                }
            });

            return holdings;
        }

        // Format budget input with thousand separators
        function formatBudgetInput(input) {
            // Get the raw value and remove all non-digits
            let value = input.value.replace(/[^\d]/g, '');

            // If empty, clear and return
            if (value === '') {
                input.value = '';
                return;
            }

            // Convert to number and format with commas
            let number = parseInt(value);
            input.value = number.toLocaleString('en-US');
        }

        // Parse formatted budget to number
        function parseBudget(formattedValue) {
            return parseFloat(formattedValue.replace(/[^\d]/g, '')) || 0;
        }

        // Handle approach selection (Smart Strategies vs Manual Selection)
        // DEPRECATED: This function is for the old UI structure
        // The new UI uses selectStrategy() function instead
        function selectApproach(approach) {
            console.log('âš ï¸ selectApproach() is deprecated, redirecting to selectStrategy()');

            // Redirect to new function
            if (typeof selectStrategy === 'function') {
                selectStrategy(approach);
            }
        }

        // Update debug status (console logging only)
        function updateDebugStatus() {
            // Debug info available in console only
            // Use window.checkAnalysisLock() or window.getAnalysisLockStatus() to check status
        }

        // Update analysis timestamp
        function updateAnalysisTimestamp() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            };
            const timestamp = now.toLocaleString('en-US', options);
            document.getElementById('analysisTimestamp').textContent = timestamp;
        }

        async function init() {
            try {
                // Check for stock parameter from macro analysis or other sources
                const urlParams = new URLSearchParams(window.location.search);
                const stockParam = urlParams.get('stock');
                if (stockParam) {
                    console.log('ğŸ“Œ Stock parameter detected from URL:', stockParam);
                    window.stockFromMacroAnalysis = stockParam;
                }

                // CRITICAL: Ensure analysis lock is false on page load
                isAnalyzingRecommendations = false;
                console.log('ğŸš€ Page initialized - isAnalyzingRecommendations:', isAnalyzingRecommendations);

                // CRITICAL: Clear any pre-checked strategy checkboxes (browser state restoration)
                // This prevents the issue where browser restores checkbox state but analysis never runs
                document.querySelectorAll('.strategy-checkbox').forEach(cb => {
                    if (cb.checked) {
                        console.log(`âš ï¸ Clearing pre-checked strategy: ${cb.value} (browser state restoration)`);
                        cb.checked = false;
                    }
                });

                // Clear recommendation status on page load
                const statusDiv = document.getElementById('recommendationStatus');
                const detailsDiv = document.getElementById('recommendationDetails');
                if (statusDiv && detailsDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#f1f5f9';
                    statusDiv.style.borderColor = '#cbd5e1';
                    detailsDiv.innerHTML = 'â„¹ï¸ Select a strategy above or manually choose stocks from the portfolio.';
                }

                // Update debug status
                setTimeout(() => updateDebugStatus(), 500);

                // Update timestamp
                updateAnalysisTimestamp();

                // Check if export libraries are loaded
                console.log('ğŸ“š Checking export libraries...');
                console.log('  - jsPDF:', typeof window.jspdf !== 'undefined' ? 'âœ… loaded' : 'âŒ not loaded');
                console.log('  - html2pdf:', typeof html2pdf !== 'undefined' ? 'âœ… loaded' : 'âŒ not loaded');
                console.log('  - XLSX:', typeof XLSX !== 'undefined' ? 'âœ… loaded' : 'âŒ not loaded');

                // Load stock names first
                try {
                    const namesResponse = await fetch(`${window.API_BASE_URL || ''}/api/stock-names`);
                    stockNames = await namesResponse.json();
                } catch (e) {
                    console.log('Stock names not available');
                    stockNames = {};
                }

                // Wait for stock categories to load (should be immediate with fallback)
                console.log('â³ Waiting for stock categories...', {
                    categoriesLoaded: window.categoriesLoaded,
                    hasSTOCK_CATEGORIES: !!window.STOCK_CATEGORIES,
                    hasAll: window.STOCK_CATEGORIES ? !!window.STOCK_CATEGORIES.all : false
                });

                let waitCount = 0;
                while (!window.categoriesLoaded && waitCount < 30) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    waitCount++;
                    if (waitCount % 5 === 0) {
                        console.log(`â³ Still waiting... (${waitCount * 100}ms)`, window.categoriesLoaded);
                    }
                }

                if (!window.categoriesLoaded) {
                    console.error('Failed to load stock categories after timeout');
                    console.error('Debug info:', {
                        categoriesLoaded: window.categoriesLoaded,
                        STOCK_CATEGORIES: window.STOCK_CATEGORIES,
                        scriptLoaded: !!window.loadStockCategories
                    });
                    if (typeof showError === 'function') {
                        showError('Failed to load stock data. Please refresh the page.');
                    } else {
                        alert('Failed to load stock data. Please refresh the page.');
                    }
                    return;
                }

                if (!window.STOCK_CATEGORIES || !window.STOCK_CATEGORIES.all) {
                    console.error('STOCK_CATEGORIES not properly loaded');
                    console.error('Debug info:', window.STOCK_CATEGORIES);
                    if (typeof showError === 'function') {
                        showError('Stock categories data is invalid. Please refresh the page.');
                    } else {
                        alert('Stock categories data is invalid. Please refresh the page.');
                    }
                    return;
                }

                // Build allStocks from all categories (dynamically loaded)
                allStocks = [...new Set([
                    ...window.STOCK_CATEGORIES.all,
                    ...(window.STOCK_CATEGORIES.commodities || [])
                ])].sort();

                console.log(`âœ“ Loaded ${allStocks.length} stocks for portfolio analytics`);

                // Load stocks with exchange info
                try {
                    const response = await fetch('/api/stocks');
                    const data = await response.json();
                    if (data.success && data.stocks) {
                        window.stocksWithExchange = {};
                        data.stocks.forEach(stock => {
                            window.stocksWithExchange[stock.symbol] = stock;
                        });
                        console.log('âœ“ Loaded exchange data for stocks');
                    }
                } catch (error) {
                    console.log('Exchange data not available, continuing without it');
                }

                // Populate all dropdowns
                populateDropdowns();

                // Default to Smart Strategies with Balanced selected and New Portfolio
                setTimeout(() => {
                    // Call the new selectStrategy function for the redesigned UI
                    if (typeof selectStrategy === 'function') {
                        selectStrategy('smart');
                        console.log('ğŸ¯ Step 1: Initialized with Smart Strategies (Balanced) as default');
                    }
                    // Default to New Portfolio for Step 2
                    if (typeof selectPortfolioType === 'function') {
                        selectPortfolioType('new');
                        console.log('ğŸ¯ Step 2: Initialized with New Portfolio as default');
                    }

                    // Initialize collapsible sections for portfolio steps
                    if (typeof initializeCollapsibleSections === 'function') {
                        initializeCollapsibleSections();
                        console.log('âœ“ Collapsible sections initialized');
                    }

                    // Add click handlers to collapsible headers
                    document.querySelectorAll('#portfolio .card.collapsible h3').forEach(header => {
                        if (!header.onclick) {
                            header.onclick = function() {
                                if (typeof toggleSection === 'function') {
                                    toggleSection(this);
                                }
                            };
                        }
                    });
                }, 500);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function getStockDisplayName(symbol) {
            const name = stockNames[symbol];
            if (name) {
                return `${symbol} - ${name}`;
            }
            return symbol;
        }

        function populateDropdowns() {
            // Regular dropdowns (single select)
            const regularDropdowns = ['backtestStock', 'patternStock', 'mlStock'];
            regularDropdowns.forEach(id => {
                const select = document.getElementById(id);
                if (select && select.tagName === 'SELECT') {
                    select.innerHTML = allStocks.map(symbol =>
                        `<option value="${symbol}">${getStockDisplayName(symbol)}</option>`
                    ).join('');
                }
            });

            // Checkbox containers (multi-select)
            populateCheckboxContainer('portfolioStocks', 'portfolio');
            populateCheckboxContainer('riskStocks', 'risk');
            populateCheckboxContainer('correlationStocks', 'correlation');
            populateCheckboxContainer('preferredStocks', 'preferred');

            // Auto-select stock from macro analysis if provided
            if (window.stockFromMacroAnalysis) {
                const stockSymbol = window.stockFromMacroAnalysis;
                console.log('ğŸ¯ Auto-selecting stock from macro analysis:', stockSymbol);

                // Auto-select in portfolio stocks
                const portfolioCheckbox = document.getElementById(`portfolio_${stockSymbol}`);
                if (portfolioCheckbox) {
                    portfolioCheckbox.checked = true;
                    updatePortfolioCount();
                    console.log('âœ… Stock selected in portfolio stocks');
                }

                // Scroll to portfolio section
                const portfolioSection = document.getElementById('portfolioStocks');
                if (portfolioSection) {
                    setTimeout(() => {
                        portfolioSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                }
            }
        }

        function populateCheckboxContainer(containerId, prefix) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Build HTML with exchange info if available
            container.innerHTML = allStocks.map(symbol => {
                const displayName = getStockDisplayName(symbol);
                let label = displayName;

                // Add exchange info if available from stocksWithExchange
                if (window.stocksWithExchange && window.stocksWithExchange[symbol]) {
                    const exchange = window.stocksWithExchange[symbol].exchange;
                    const exchangeDisplay = getExchangeDisplay(exchange);
                    label = `${displayName} (${exchangeDisplay})`;
                }

                return `
                    <div class="checkbox-item" data-exchange="${window.stocksWithExchange && window.stocksWithExchange[symbol] ? window.stocksWithExchange[symbol].exchange : ''}">
                        <input type="checkbox" id="${prefix}_${symbol}" value="${symbol}" onchange="update${prefix.charAt(0).toUpperCase() + prefix.slice(1)}Count()">
                        <label for="${prefix}_${symbol}" title="${label}">${label}</label>
                    </div>
                `;
            }).join('');

            // Initialize count
            window[`update${prefix.charAt(0).toUpperCase() + prefix.slice(1)}Count`]();
        }

        function updatePortfolioCount() {
            const count = document.querySelectorAll('#portfolioStocks input:checked').length;
            document.getElementById('portfolioCount').textContent = `${count} selected`;
        }

        function updateRiskCount() {
            const count = document.querySelectorAll('#riskStocks input:checked').length;
            document.getElementById('riskCount').textContent = `${count} selected`;
        }

        function updateCorrelationCount() {
            const count = document.querySelectorAll('#correlationStocks input:checked').length;
            document.getElementById('correlationCount').textContent = `${count} selected`;
        }

        function updatePreferredCount() {
            const count = document.querySelectorAll('#preferredStocks input:checked').length;
            document.getElementById('preferredCount').textContent = `${count} preferred`;
        }

        // Portfolio checkbox controls
        function selectAllPortfolio() {
            document.querySelectorAll('#portfolioStocks input[type="checkbox"]').forEach(cb => cb.checked = true);
            updatePortfolioCount();
        }

        function clearAllPortfolio() {
            document.querySelectorAll('#portfolioStocks input[type="checkbox"]').forEach(cb => cb.checked = false);
            updatePortfolioCount();
        }

        function filterPortfolioStocks() {
            const searchTerm = document.getElementById('portfolioSearchBox').value.toLowerCase();
            const exchangeFilter = document.getElementById('portfolioExchangeFilter') ? document.getElementById('portfolioExchangeFilter').value : '';

            document.querySelectorAll('#portfolioStocks .checkbox-item').forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                const exchange = item.getAttribute('data-exchange') || '';

                // Check search term
                const matchesSearch = label.includes(searchTerm);

                // Check exchange filter
                const matchesExchange = !exchangeFilter || exchange === exchangeFilter;

                // Show if both match
                item.classList.toggle('hidden', !(matchesSearch && matchesExchange));
            });
        }

        function selectVisiblePortfolio() {
            document.querySelectorAll('#portfolioStocks .checkbox-item:not(.hidden) input[type="checkbox"]').forEach(cb => cb.checked = true);
            updatePortfolioCount();
        }

        // Preferred stocks controls
        function clearAllPreferred() {
            document.querySelectorAll('#preferredStocks input[type="checkbox"]').forEach(cb => cb.checked = false);
            updatePreferredCount();
        }

        function filterPreferredStocks() {
            const searchTerm = document.getElementById('preferredStocksSearchBox').value.toLowerCase();
            document.querySelectorAll('#preferredStocks .checkbox-item').forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                item.classList.toggle('hidden', !label.includes(searchTerm));
            });
        }

        // Helper functions to disable/enable strategy checkboxes during analysis
        function disableStrategyCheckboxes() {
            document.querySelectorAll('.strategy-checkbox-label').forEach(label => {
                const checkbox = label.querySelector('.strategy-checkbox');
                label.style.pointerEvents = 'none';
                label.style.cursor = 'not-allowed';

                // Only dim unchecked checkboxes
                if (!checkbox.checked) {
                    label.style.opacity = '0.4';
                }
            });
        }

        function enableStrategyCheckboxes() {
            document.querySelectorAll('.strategy-checkbox-label').forEach(label => {
                label.style.pointerEvents = '';
                label.style.opacity = '';
                label.style.cursor = '';
            });
        }

        // Handle strategy checkbox selection (enforce single selection)
        function handleStrategySelection(checkbox) {
            // Update debug status
            updateDebugStatus();

            // Prevent selection if analysis is already in progress
            if (isAnalyzingRecommendations) {
                checkbox.checked = false; // Uncheck the clicked checkbox
                console.warn('âš ï¸ Strategy change blocked - analysis in progress');
                return;
            }

            if (checkbox.checked) {
                // DO NOT clear portfolio results - keep them visible until new results are ready
                // User can still see previous analysis while waiting for strategy recommendations

                // Uncheck all other strategy checkboxes
                document.querySelectorAll('.strategy-checkbox').forEach(cb => {
                    if (cb !== checkbox) {
                        cb.checked = false;
                    }
                });

                // Update debug status after changes
                updateDebugStatus();

                // Trigger recommendation analysis
                const strategy = checkbox.value;
                getSmartRecommendations(strategy);
            } else {
                // If unchecked, clear preferred stocks but keep status visible
                // Force reset the lock flag in case it was stuck
                if (isAnalyzingRecommendations) {
                    console.warn('âš ï¸ Force resetting isAnalyzingRecommendations flag');
                    isAnalyzingRecommendations = false;
                    enableStrategyCheckboxes();
                }

                clearAllPreferred();
                const statusDiv = document.getElementById('recommendationStatus');
                const detailsDiv = document.getElementById('recommendationDetails');
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#f1f5f9';
                    statusDiv.style.borderColor = '#cbd5e1';
                    detailsDiv.innerHTML = 'â„¹ï¸ Strategy cleared. Select a strategy above or manually choose stocks from the portfolio.';
                }

                // Update debug status after changes
                updateDebugStatus();
            }
        }

        // Smart Recommendations Function
        async function getSmartRecommendations(strategy) {
            const statusDiv = document.getElementById('recommendationStatus');
            const detailsDiv = document.getElementById('recommendationDetails');

            console.log(`ğŸ” Starting strategy analysis: ${strategy}`);

            // Set lock to prevent concurrent analyses
            isAnalyzingRecommendations = true;
            disableStrategyCheckboxes();
            updateDebugStatus();

            // Show loading WITHOUT clearing previous content first
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#fef3c7';
            statusDiv.style.borderColor = '#f59e0b';
            detailsDiv.innerHTML = 'â³ Analyzing all stocks... Please wait.';

            // Clear preferred stocks AFTER showing loading status
            clearAllPreferred();

            // Add safety timeout to prevent permanent stuck (2 minutes)
            const timeoutId = setTimeout(() => {
                if (isAnalyzingRecommendations) {
                    console.error('âš ï¸ Strategy analysis timeout!');
                    statusDiv.style.background = '#fee2e2';
                    statusDiv.style.borderColor = '#ef4444';
                    detailsDiv.innerHTML = 'âŒ Analysis timeout. Please refresh and try again.';
                    isAnalyzingRecommendations = false;
                    enableStrategyCheckboxes();
                }
            }, 120000); // 2 minutes timeout

            try {
                // Get all stocks
                let stocksToAnalyze = [...allStocks];

                // Check if we have stocks to analyze
                if (stocksToAnalyze.length === 0) {
                    clearTimeout(timeoutId);
                    console.error('âŒ No stocks available for analysis');
                    statusDiv.style.background = '#fee2e2';
                    statusDiv.style.borderColor = '#ef4444';
                    detailsDiv.innerHTML = 'âŒ No stocks available. Please refresh the page.';
                    isAnalyzingRecommendations = false;
                    enableStrategyCheckboxes();
                    return;
                }

                // Filter stocks by strategy
                if (window.STOCK_CATEGORIES) {
                    switch (strategy) {
                        case 'balanced':
                            // Balanced: Use all stocks (no filter)
                            break;
                        case 'growth':
                            // Growth: Tech, consumer goods, and banking stocks
                            const growthStocks = [
                                ...(window.STOCK_CATEGORIES.tech || []),
                                ...(window.STOCK_CATEGORIES.consumer || []),
                                ...(window.STOCK_CATEGORIES.banks || [])
                            ];
                            stocksToAnalyze = [...new Set(growthStocks)]; // Remove duplicates
                            console.log(`ğŸ“Š Growth strategy: ${stocksToAnalyze.length} stocks`);
                            break;
                        case 'conservative':
                            // Conservative: Blue chips and banks (stable, large-cap)
                            const conservativeStocks = [
                                ...(window.STOCK_CATEGORIES.blue_chips || []),
                                ...(window.STOCK_CATEGORIES.banks || [])
                            ];
                            stocksToAnalyze = [...new Set(conservativeStocks)]; // Remove duplicates
                            console.log(`ğŸ›¡ï¸ Conservative strategy: ${stocksToAnalyze.length} stocks`);
                            break;
                        case 'bluechip':
                            // Blue chip: Only blue chip stocks
                            stocksToAnalyze = window.STOCK_CATEGORIES.blue_chips || [];
                            console.log(`â­ Blue chip strategy: ${stocksToAnalyze.length} stocks`);
                            console.log(`ğŸ“‹ Blue chip stocks being analyzed:`, stocksToAnalyze);
                            console.log(`ğŸ” Is AAV in blue_chips? ${stocksToAnalyze.includes('AAV')}`);
                            console.log(`DEBUG: Checking window.STOCK_CATEGORIES:`, {
                                hasBlueChips: !!window.STOCK_CATEGORIES.blue_chips,
                                blueChipsLength: window.STOCK_CATEGORIES.blue_chips ? window.STOCK_CATEGORIES.blue_chips.length : 0,
                                blueChipsArray: window.STOCK_CATEGORIES.blue_chips
                            });
                            break;
                        case 'risky':
                            // Risky: Exclude blue chips and banks, focus on smaller companies
                            const allStocksSet = new Set(stocksToAnalyze);
                            const blueChipsSet = new Set(window.STOCK_CATEGORIES.blue_chips || []);
                            const banksSet = new Set(window.STOCK_CATEGORIES.banks || []);
                            stocksToAnalyze = [...allStocksSet].filter(s => !blueChipsSet.has(s) && !banksSet.has(s));
                            console.log(`ğŸ² Risky strategy: ${stocksToAnalyze.length} stocks`);
                            break;
                    }
                }

                // Analyze each stock
                const stockAnalysis = [];
                let processedCount = 0;
                const totalStocks = stocksToAnalyze.length;
                console.log(`ğŸ“Š Analyzing ${totalStocks} stocks...`);
                console.log(`ğŸ“‹ Stocks to analyze:`, stocksToAnalyze);

                for (const symbol of stocksToAnalyze) {
                    processedCount++;
                    // Update progress every 10 stocks
                    if (processedCount % 10 === 0) {
                        console.log(`Progress: ${processedCount}/${totalStocks} stocks processed`);
                        detailsDiv.innerHTML = `â³ Analyzing stocks... ${processedCount}/${totalStocks} processed`;
                    }

                    // Log if we're analyzing AAV
                    if (symbol === 'AAV') {
                        console.log(`âš ï¸ ANALYZING AAV! This should not happen in bluechip strategy`);
                    }

                    try {
                        const currentData = await DataAPI.getCurrentPrice(symbol);
                        const historicalData = await DataAPI.getHistoricalData(symbol, 90); // 90 days

                        if (currentData && historicalData && historicalData.length > 20) {
                            const closes = historicalData.map(d => d.close);
                            const returns = [];

                            // Calculate daily returns
                            for (let i = 1; i < closes.length; i++) {
                                const dailyReturn = ((closes[i] - closes[i-1]) / closes[i-1]) * 100;
                                if (isFinite(dailyReturn)) {
                                    returns.push(dailyReturn);
                                }
                            }

                            if (returns.length > 10) {
                                // Calculate metrics
                                const avgDailyReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
                                const expectedReturn = avgDailyReturn * 252; // Annualized

                                const variance = returns.reduce((sum, r) => sum + Math.pow(r - avgDailyReturn, 2), 0) / returns.length;
                                const dailyVolatility = Math.sqrt(Math.max(0, variance));
                                const risk = dailyVolatility * Math.sqrt(252); // Annualized

                                const sharpeRatio = risk > 0 ? expectedReturn / risk : 0;

                                // 3-month performance
                                const threeMonthsAgo = Math.max(0, closes.length - 63);
                                const performance3M = ((closes[closes.length - 1] - closes[threeMonthsAgo]) / closes[threeMonthsAgo]) * 100;

                                // Recent momentum (last 10 days)
                                const recentCloses = closes.slice(-10);
                                const momentum = ((recentCloses[recentCloses.length - 1] - recentCloses[0]) / recentCloses[0]) * 100;

                                stockAnalysis.push({
                                    symbol,
                                    expectedReturn,
                                    risk,
                                    sharpeRatio,
                                    performance3M,
                                    momentum,
                                    currentPrice: currentData.price
                                });
                            }
                        }
                    } catch (error) {
                        // Skip stocks with errors
                    }
                }

                console.log(`âœ“ Analyzed ${stockAnalysis.length} stocks successfully`);
                console.log(`ğŸ“‹ Stocks found with valid data:`, stockAnalysis.map(s => s.symbol));
                console.log(`ğŸ” Is AAV in analyzed results? ${stockAnalysis.some(s => s.symbol === 'AAV')}`);

                if (stockAnalysis.length < 5) {
                    clearTimeout(timeoutId); // Clear timeout
                    console.warn('âš ï¸ Not enough stock data (<5 stocks)');
                    statusDiv.style.background = '#fee2e2';
                    statusDiv.style.borderColor = '#ef4444';
                    detailsDiv.innerHTML = 'âŒ Not enough stock data available. Please try again later.';

                    // Release lock and re-enable checkboxes
                    isAnalyzingRecommendations = false;
                    enableStrategyCheckboxes();
                    return;
                }

                // Sort and select top stocks based on strategy
                let selectedStocks = [];
                let strategyName = '';
                let criteriaDescription = '';

                switch (strategy) {
                    case 'balanced':
                        // Best Sharpe ratio (risk-adjusted returns)
                        stockAnalysis.sort((a, b) => b.sharpeRatio - a.sharpeRatio);
                        selectedStocks = stockAnalysis.slice(0, 8).map(s => s.symbol);
                        strategyName = 'âš–ï¸ Balanced Strategy';
                        criteriaDescription = 'Selected stocks with highest Sharpe ratio (best risk-adjusted returns). These stocks offer optimal balance between returns and risk.';
                        break;

                    case 'growth':
                        // Highest expected returns
                        stockAnalysis.sort((a, b) => b.expectedReturn - a.expectedReturn);
                        selectedStocks = stockAnalysis.slice(0, 8).map(s => s.symbol);
                        strategyName = 'ğŸ“ˆ High Growth Strategy';
                        criteriaDescription = 'Selected stocks with highest expected returns. These are aggressive growth stocks with strong upward momentum.';
                        break;

                    case 'conservative':
                        // Lowest risk with positive returns
                        const positiveReturns = stockAnalysis.filter(s => s.expectedReturn > 0);
                        positiveReturns.sort((a, b) => a.risk - b.risk);
                        selectedStocks = positiveReturns.slice(0, 8).map(s => s.symbol);
                        strategyName = 'ğŸ›¡ï¸ Conservative Strategy';
                        criteriaDescription = 'Selected stocks with lowest risk and stable positive returns. These are defensive stocks for capital preservation.';
                        break;

                    case 'bluechip':
                        // Blue chips with best performance
                        stockAnalysis.sort((a, b) => b.performance3M - a.performance3M);
                        selectedStocks = stockAnalysis.slice(0, 8).map(s => s.symbol);
                        console.log(`ğŸ“Š Analyzed ${stockAnalysis.length} blue chip stocks`);
                        console.log(`âœ… Selected blue chip stocks:`, selectedStocks);
                        console.log(`ğŸ” AAV in selected stocks? ${selectedStocks.includes('AAV')}`);
                        strategyName = 'â­ Blue Chip Strategy';
                        criteriaDescription = 'Selected top blue chip stocks with best recent performance. These are market leaders with strong fundamentals.';
                        break;
                }

                // Clear all preferred stocks first
                clearAllPreferred();

                // Check the recommended stocks in preferred section
                selectedStocks.forEach(symbol => {
                    const checkbox = document.querySelector(`#preferredStocks input[value="${symbol}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });

                // Update counter
                updatePreferredCount();

                // Show results with success styling
                statusDiv.style.background = '#dbeafe';
                statusDiv.style.borderColor = '#3b82f6';
                const topStock = stockAnalysis.find(s => s.symbol === selectedStocks[0]);
                detailsDiv.innerHTML = `
                    <div style="font-weight: 600; color: #1e40af; margin-bottom: 8px;">${strategyName}</div>
                    <div style="margin-bottom: 8px;">${criteriaDescription}</div>
                    <div style="font-weight: 600; margin-top: 10px;">ğŸ“Š Selected ${selectedStocks.length} Stocks:</div>
                    <div style="color: #1e40af; font-weight: 600;">${selectedStocks.join(', ')}</div>
                    <div style="margin-top: 8px; font-size: 0.9em; color: #64748b;">
                        Top pick: <strong>${selectedStocks[0]}</strong> -
                        Expected Return: ${topStock.expectedReturn.toFixed(1)}% |
                        Risk: ${topStock.risk.toFixed(1)}% |
                        Sharpe: ${topStock.sharpeRatio.toFixed(2)}
                    </div>
                `;

                // Scroll to preferred stocks section
                document.getElementById('preferredStocks').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                console.log(`âœ… Strategy analysis complete: ${selectedStocks.length} stocks selected`);
                clearTimeout(timeoutId); // Clear timeout

                // Release lock and re-enable checkboxes
                isAnalyzingRecommendations = false;
                enableStrategyCheckboxes();

            } catch (error) {
                console.error('âŒ Error generating recommendations:', error);
                clearTimeout(timeoutId); // Clear timeout
                statusDiv.style.background = '#fee2e2';
                statusDiv.style.borderColor = '#ef4444';
                detailsDiv.innerHTML = 'âŒ Error analyzing stocks. Please try again.';

                // Release lock and re-enable checkboxes
                isAnalyzingRecommendations = false;
                enableStrategyCheckboxes();
            }
        }

        // Risk checkbox controls
        function selectAllRisk() {
            document.querySelectorAll('#riskStocks input[type="checkbox"]').forEach(cb => cb.checked = true);
            updateRiskCount();
        }

        function clearAllRisk() {
            document.querySelectorAll('#riskStocks input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateRiskCount();
        }

        function filterRiskStocks() {
            const searchTerm = document.getElementById('riskSearchBox').value.toLowerCase();
            document.querySelectorAll('#riskStocks .checkbox-item').forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                item.classList.toggle('hidden', !label.includes(searchTerm));
            });
        }

        function selectVisibleRisk() {
            document.querySelectorAll('#riskStocks .checkbox-item:not(.hidden) input[type="checkbox"]').forEach(cb => cb.checked = true);
            updateRiskCount();
        }

        // Correlation checkbox controls
        function selectAllCorrelation() {
            document.querySelectorAll('#correlationStocks input[type="checkbox"]').forEach(cb => cb.checked = true);
            updateCorrelationCount();
        }

        function clearAllCorrelation() {
            document.querySelectorAll('#correlationStocks input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateCorrelationCount();
        }

        function filterCorrelationStocks() {
            const searchTerm = document.getElementById('correlationSearchBox').value.toLowerCase();
            document.querySelectorAll('#correlationStocks .checkbox-item').forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                item.classList.toggle('hidden', !label.includes(searchTerm));
            });
        }

        function selectVisibleCorrelation() {
            document.querySelectorAll('#correlationStocks .checkbox-item:not(.hidden) input[type="checkbox"]').forEach(cb => cb.checked = true);
            updateCorrelationCount();
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
        }

        async function analyzePortfolio() {
            // Update debug status
            updateDebugStatus();

            // Check if a strategy is selected FIRST
            const selectedStrategy = document.querySelector('.strategy-checkbox:checked');

            console.log('ğŸ” Analyze Portfolio clicked');
            console.log('   - Strategy selected:', selectedStrategy ? selectedStrategy.value : 'none');
            console.log('   - isAnalyzingRecommendations:', isAnalyzingRecommendations);

            let finalSelectedStocks = [];

            if (selectedStrategy) {
                // STRATEGY MODE: Check if analysis is in progress
                if (isAnalyzingRecommendations) {
                    console.warn('âš ï¸ Strategy analysis in progress');
                    showAlert('â³ Please wait for the strategy analysis to complete.');
                    return;
                }

                // Strategy mode: use preferred stocks (auto-selected by strategy)
                const preferredCheckboxes = document.querySelectorAll('#preferredStocks input[type="checkbox"]:checked');
                finalSelectedStocks = Array.from(preferredCheckboxes).map(cb => cb.value);

                if (finalSelectedStocks.length < 2) {
                    showAlert('Please wait for the strategy to load and select stocks');
                    return;
                }

                console.log('   - Using strategy-selected stocks:', finalSelectedStocks);
            } else {
                // DEFAULT MODE: use manually selected portfolio stocks (NO LOCK CHECK!)
                const checkboxes = document.querySelectorAll('#portfolioStocks input[type="checkbox"]:checked');
                finalSelectedStocks = Array.from(checkboxes).map(cb => cb.value);

                if (finalSelectedStocks.length < 2) {
                    showAlert('Please select at least 2 stocks from the portfolio');
                    return;
                }

                console.log('   - Using manually selected stocks:', finalSelectedStocks);
            }

            // Store selected stocks globally
            currentPortfolioStocks = finalSelectedStocks;

            // Capture selected strategy
            const selectedStrategyCheckbox = document.querySelector('.strategy-checkbox:checked');
            const strategyValue = selectedStrategyCheckbox ? selectedStrategyCheckbox.value : null;
            const strategyNames = {
                'balanced': 'âš–ï¸ Balanced Strategy',
                'growth': 'ğŸ“ˆ High Growth Strategy',
                'conservative': 'ğŸ›¡ï¸ Conservative Strategy',
                'bluechip': 'â­ Blue Chip Strategy'
            };
            const strategyName = strategyValue ? strategyNames[strategyValue] : 'Manual Selection';

            console.log('ğŸ“Š Strategy Selected:', strategyValue);
            console.log('ğŸ“Š Strategy Name:', strategyName);

            // Get investment budget (using parseBudget to handle formatted numbers)
            const budgetInput = document.getElementById('investmentBudget');
            const budget = parseBudget(budgetInput.value);

            if (budget <= 0) {
                showAlert('âš ï¸ Please enter your investment budget!\n\nEnter the total amount (in VND) you want to invest in the portfolio.');
                budgetInput.focus();
                return;
            }

            console.log('Investment budget:', budget, 'VND');

            // Simulate portfolio analysis
            document.getElementById('portfolioResults').style.display = 'block';

            // Show strategy indicator
            const strategyIndicatorName = document.getElementById('strategyIndicatorName');
            strategyIndicatorName.textContent = `Strategy: ${strategyName}`;

            // Scroll to results
            document.getElementById('portfolioResults').scrollIntoView({ behavior: 'smooth', block: 'start' });

            // Calculate equal allocation across stocks (can be optimized later)
            const allocationPerStock = budget / finalSelectedStocks.length;

            // Mock calculations (in real implementation, these would be calculated from actual stock data)
            const mockReturn = 10 + Math.random() * 10;
            const mockRisk = 15 + Math.random() * 10;
            const mockSharpe = mockReturn / mockRisk;
            const mockDrawdown = -(5 + Math.random() * 10);
            const mockDiversification = 70 + Math.random() * 20;

            document.getElementById('portfolioValue').textContent = budget.toFixed(0);
            document.getElementById('expectedReturn').textContent = mockReturn.toFixed(1) + '%';
            document.getElementById('portfolioRisk').textContent = mockRisk.toFixed(1) + '%';
            document.getElementById('sharpeRatio').textContent = mockSharpe.toFixed(2);
            document.getElementById('maxDrawdown').textContent = mockDrawdown.toFixed(1) + '%';
            document.getElementById('diversification').textContent = mockDiversification.toFixed(0) + '%';

            // Generate holdings with proper allocation
            const holdings = finalSelectedStocks.map((symbol, idx) => {
                // Mock current price (in real implementation, fetch from API)
                const mockPrice = 30000 + Math.floor(Math.random() * 70000);
                const sharesCanBuy = Math.floor(allocationPerStock / mockPrice);
                const actualValue = sharesCanBuy * mockPrice;

                return {
                    symbol: symbol,
                    shares: sharesCanBuy,
                    price: mockPrice,
                    value: actualValue,
                    weight: 0, // Will be calculated below
                    return: -5 + Math.random() * 30 // Random return between -5% and +25%
                };
            });

            // Calculate actual total value and weights
            const actualTotalValue = holdings.reduce((sum, h) => sum + h.value, 0);
            holdings.forEach(h => {
                h.weight = (h.value / actualTotalValue) * 100;
            });

            // Save results to global object for Portfolio Report tab
            portfolioAnalysisResults = {
                analyzed: true,
                strategy: strategyValue,
                strategyName: strategyName,
                portfolioValue: actualTotalValue,
                budgetAllocated: budget,
                cashRemaining: budget - actualTotalValue,
                totalReturn: mockReturn,
                riskLevel: mockRisk,
                sharpeRatio: mockSharpe,
                maxDrawdown: mockDrawdown,
                diversification: mockDiversification,
                holdings: holdings,
                sectors: calculateSectorAllocation(finalSelectedStocks),
                performance: {
                    bestPerformer: finalSelectedStocks[0],
                    worstPerformer: finalSelectedStocks[finalSelectedStocks.length - 1],
                    mostVolatile: finalSelectedStocks[Math.floor(Math.random() * finalSelectedStocks.length)],
                    mostStable: finalSelectedStocks[Math.floor(Math.random() * finalSelectedStocks.length)]
                },
                timestamp: new Date()
            };

            // Calculate actual values and weights for holdings
            const totalValue = portfolioAnalysisResults.holdings.reduce((sum, h) => {
                h.value = h.shares * h.price;
                return sum + h.value;
            }, 0);

            portfolioAnalysisResults.holdings.forEach(h => {
                h.weight = (h.value / totalValue) * 100;
            });

            portfolioAnalysisResults.portfolioValue = totalValue;

            console.log('Portfolio analysis complete:', portfolioAnalysisResults);
            console.log('âœ… Saved strategy to results:', {
                strategy: portfolioAnalysisResults.strategy,
                strategyName: portfolioAnalysisResults.strategyName
            });

            // Create allocation chart
            renderAllocationChart(finalSelectedStocks);
            renderEfficientFrontier();
        }

        function calculateSectorAllocation(stocks) {
            // Map stocks to sectors (simplified)
            const sectorMap = {
                'VCB': 'Banking', 'TCB': 'Banking', 'BID': 'Banking', 'CTG': 'Banking', 'MBB': 'Banking',
                'FPT': 'Technology', 'CMG': 'Technology', 'SAM': 'Technology',
                'VNM': 'Consumer Goods', 'MSN': 'Consumer Goods', 'SAB': 'Consumer Goods',
                'VHM': 'Real Estate', 'VIC': 'Real Estate', 'NVL': 'Real Estate',
                'HPG': 'Industrial', 'GAS': 'Oil & Gas', 'PLX': 'Oil & Gas'
            };

            const sectors = {};
            stocks.forEach(stock => {
                const sector = sectorMap[stock] || 'Others';
                sectors[sector] = (sectors[sector] || 0) + 1;
            });

            // Convert counts to percentages
            const total = stocks.length;
            Object.keys(sectors).forEach(sector => {
                sectors[sector] = (sectors[sector] / total) * 100;
            });

            return sectors;
        }

        function renderAllocationChart(stocks) {
            const ctx = document.getElementById('allocationChart');
            if (charts.allocation) charts.allocation.destroy();

            const colors = stocks.map((_, i) =>
                `hsl(${(i * 360) / stocks.length}, 70%, 60%)`
            );

            charts.allocation = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: stocks,
                    datasets: [{
                        data: stocks.map(() => 100 / stocks.length), // Equal weight allocation
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Asset Allocation'
                        }
                    }
                }
            });
        }

        function renderAllocationChartWithData(allocations) {
            const ctx = document.getElementById('allocationChart');
            if (charts.allocation) charts.allocation.destroy();

            const labels = allocations.map(a => getStockDisplayName(a.symbol));
            const data = allocations.map(a => parseFloat(a.percentage));
            const colors = allocations.map((_, i) =>
                `hsl(${(i * 360) / allocations.length}, 70%, 60%)`
            );

            charts.allocation = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Portfolio Allocation'
                        },
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toFixed(2) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderEfficientFrontier() {
            const ctx = document.getElementById('efficientFrontierChart');
            if (charts.frontier) charts.frontier.destroy();

            // Generate efficient frontier curve (theoretical optimal portfolios)
            // Note: Real efficient frontier would require correlation matrix and optimization
            const points = [];
            for (let i = 0; i < 50; i++) {
                const risk = 5 + i * 0.5;
                const return_ = 3 + Math.sqrt(risk) * 2; // Simplified efficient frontier curve
                points.push({x: risk, y: return_});
            }

            charts.frontier = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Efficient Frontier',
                        data: points,
                        backgroundColor: 'rgba(196, 28, 22, 0.6)',
                        borderColor: '#c41c16',
                        pointRadius: 4
                    }, {
                        label: 'Current Portfolio',
                        data: [{x: 18.3, y: 12.5}],
                        backgroundColor: 'rgba(239, 68, 68, 1)',
                        pointRadius: 10,
                        pointStyle: 'star'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Efficient Frontier'
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Risk (%)' }
                        },
                        y: {
                            title: { display: true, text: 'Expected Return (%)' }
                        }
                    }
                }
            });
        }

        function formatBudgetInput(input) {
            // Remove non-digit characters
            let value = input.value.replace(/\D/g, '');

            // Format with commas
            if (value) {
                value = parseInt(value).toLocaleString('en-US');
            }

            input.value = value;
        }

        // Portfolio Type Toggle
        // Note: holdingRowCounter is already declared at line 1941

        function togglePortfolioType() {
            const portfolioType = document.querySelector('input[name="portfolioType"]:checked').value;
            const existingSection = document.getElementById('existingPortfolioSection');
            const budgetLabel = document.getElementById('budgetLabel');

            // Update active state on portfolio cards
            document.querySelectorAll('.portfolio-type-card').forEach(card => {
                const input = card.querySelector('input[type="radio"]');
                if (input && input.checked) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });

            if (portfolioType === 'existing') {
                existingSection.style.display = 'block';
                budgetLabel.textContent = 'Additional Cash Flow / New Investment (VND)';
                // Add one initial row
                if (document.getElementById('holdingsListContainer').children.length === 0) {
                    addHoldingRow();
                }
            } else {
                existingSection.style.display = 'none';
                budgetLabel.textContent = 'Enter Your Investment Budget (VND)';
            }
        }

        function addHoldingRow() {
            holdingRowCounter++;
            const container = document.getElementById('holdingsListContainer');
            console.log('addHoldingRow called, counter=', holdingRowCounter, 'container=', container, 'allStocks=', allStocks.length);

            // Build datalist id for this row
            const datalistId = `stock-datalist-${holdingRowCounter}`;
            const stockOptions = (allStocks || []).map(sym => `<option value="${sym}">${sym} - ${stockNames[sym] || sym}</option>`).join('');

            const row = document.createElement('div');
            row.id = `holding-row-${holdingRowCounter}`;
            row.style.cssText = 'display: grid; grid-template-columns: 2fr 1.5fr 1.5fr 1fr auto; gap: 10px; align-items: center; margin-bottom: 10px; padding: 12px; background: #f8fafc; border-radius: 6px; border: 1px solid #e5e7eb;';

            row.innerHTML = `
                <datalist id="${datalistId}">${stockOptions}</datalist>
                <input type="text" list="${datalistId}" placeholder="Type stock symbol..." class="holding-stock-select"
                       style="padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.95em; text-transform: uppercase;">
                <input type="number" placeholder="Shares owned" class="holding-shares" min="1"
                       style="padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.95em;">
                <input type="number" placeholder="Buy price (VND)" class="holding-buy-price" min="0" step="1000"
                       style="padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.95em;">
                <div class="holding-current-value" style="font-weight: 600; color: #1e293b; font-size: 0.9em; text-align: center;">-</div>
                <button onclick="removeHoldingRow('holding-row-${holdingRowCounter}')"
                        style="padding: 6px 10px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
                    âœ•
                </button>
            `;

            container.appendChild(row);

            // Add event listeners to calculate current value when stock/shares change
            const stockInput = row.querySelector('.holding-stock-select');
            const sharesInput = row.querySelector('.holding-shares');

            stockInput.addEventListener('change', () => updateHoldingValue(row));
            stockInput.addEventListener('input', () => { stockInput.value = stockInput.value.toUpperCase(); updateHoldingValue(row); });
            sharesInput.addEventListener('input', () => updateHoldingValue(row));
        }

        async function updateHoldingValue(row) {
            const symbol = row.querySelector('.holding-stock-select').value;
            const shares = parseFloat(row.querySelector('.holding-shares').value);
            const valueDiv = row.querySelector('.holding-current-value');

            if (symbol && shares > 0) {
                try {
                    const currentData = await DataAPI.getCurrentPrice(symbol);
                    if (currentData && currentData.price) {
                        const currentValue = currentData.price * shares;
                        valueDiv.textContent = `${currentValue.toLocaleString()} VND`;
                        valueDiv.style.color = '#15803d';
                    }
                } catch (error) {
                    valueDiv.textContent = 'Error';
                    valueDiv.style.color = '#dc2626';
                }
            } else {
                valueDiv.textContent = '-';
                valueDiv.style.color = '#64748b';
            }
        }

        function removeHoldingRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
            }
        }

        function getExistingHoldings() {
            const rows = document.querySelectorAll('#holdingsListContainer > div');
            const holdings = [];

            rows.forEach(row => {
                const symbol = (row.querySelector('.holding-stock-select').value || '').trim().toUpperCase();
                const shares = parseFloat(row.querySelector('.holding-shares').value);
                const buyPrice = parseFloat(row.querySelector('.holding-buy-price').value);

                if (symbol && shares > 0 && buyPrice > 0) {
                    holdings.push({
                        symbol,
                        shares,
                        buyPrice,
                        currentPrice: buyPrice,
                        currentValue: buyPrice * shares,
                        totalCost: buyPrice * shares,
                        profitLoss: 0,
                        profitLossPercent: 0
                    });
                }
            });

            return holdings;
        }

        async function generateInvestmentPlan() {
            try {
                console.log('ğŸš€ generateInvestmentPlan function called');
                console.log('Debug info:', {
                    currentStrategy,
                    currentSmartStrategy,
                    currentPortfolioType,
                    allStocksLength: allStocks.length
                });

                // Validate Step 1: Strategy selection
                if (!currentStrategy) {
                    console.log('âŒ Validation failed: No strategy selected');
                    showAlert('âš ï¸ Please select an investment strategy (Step 1)');
                    return;
                }

                if (currentStrategy === 'smart' && !currentSmartStrategy) {
                    console.log('âŒ Validation failed: No smart strategy selected');
                    showAlert('âš ï¸ Please select a smart strategy option (Balanced, Growth, etc.)');
                    return;
                }

                // Validate Step 2: Portfolio type selection
                if (!currentPortfolioType) {
                    console.log('âŒ Validation failed: No portfolio type selected');
                    showAlert('âš ï¸ Please select a portfolio type (Step 2)');
                    return;
                }

                // Validate Step 4: Budget
                const budgetInput = document.getElementById('investmentBudget').value;
                const budget = parseFloat(budgetInput.replace(/,/g, ''));

                if (!budget || budget <= 0) {
                    console.log('âŒ Validation failed: Invalid budget');
                    showAlert('âš ï¸ Please enter a valid budget amount (Step 4)');
                    return;
                }

                // Get existing holdings if applicable
                let existingHoldings = [];
                if (currentPortfolioType === 'existing') {
                    const rows = document.querySelectorAll('#holdingsListContainer > div');
                    console.log('ğŸ” Holdings container rows found:', rows.length);
                    rows.forEach((row, i) => {
                        const sym = row.querySelector('.holding-stock-select')?.value;
                        const shr = row.querySelector('.holding-shares')?.value;
                        const bp  = row.querySelector('.holding-buy-price')?.value;
                        console.log(`  Row ${i}: symbol="${sym}" shares="${shr}" buyPrice="${bp}"`);
                    });
                    existingHoldings = getExistingHoldings();
                    console.log('ğŸ“¦ getExistingHoldings() returned:', existingHoldings.length, 'holdings');
                    if (existingHoldings.length === 0) {
                        console.log('âŒ Validation failed: No existing holdings');
                        showAlert('âš ï¸ Please add at least one existing holding (Step 2)');
                        return;
                    }
                }

                console.log('âœ… All validations passed');
                console.log('ğŸ’° Generate Investment Plan clicked');
                console.log('   - Strategy:', currentStrategy);
                console.log('   - Smart Strategy:', currentSmartStrategy);
                console.log('   - Portfolio Type:', currentPortfolioType);
                console.log('   - Budget:', budget);
                console.log('   - Existing Holdings:', existingHoldings);

            let finalSelectedStocks = [];
            let preferredStocks = [];

            // Get preferred stocks (Step 3 - optional)
            const preferredCheckboxes = document.querySelectorAll('#portfolioStocks input[type="checkbox"]:checked');
            preferredStocks = Array.from(preferredCheckboxes).map(cb => cb.value);

            if (currentStrategy === 'smart') {
                // Smart strategy mode: auto-select stocks based on strategy
                if (preferredStocks.length >= 2) {
                    // User selected preferred stocks, use those
                    finalSelectedStocks = preferredStocks;
                    console.log(`ğŸ“Œ Using ${preferredStocks.length} preferred stocks`);
                } else {
                    // Auto-select stocks based on smart strategy type
                    let numStocks = 10;
                    let candidateStocks = allStocks;

                    // Handle risky strategy with price filtering
                    if (currentSmartStrategy === 'risky') {
                        const maxPrice = parseFloat(document.getElementById('riskyMaxPrice').value);
                        if (!maxPrice || maxPrice <= 0) {
                            showAlert('âš ï¸ Please enter a valid maximum stock price for Risky strategy (Step 1)');
                            return;
                        }

                        // Filter stocks by maximum price
                        candidateStocks = allStocks.filter(stock => {
                            // We'll do price filtering after loading current data
                            return stock;
                        });

                        numStocks = 8; // Fewer, focused picks for high-risk strategy
                        console.log(`ğŸš€ Risky strategy: Max price = ${maxPrice} VND, searching from ${candidateStocks.length} stocks`);
                    } else if (currentSmartStrategy === 'conservative') {
                        numStocks = 15; // More diversification for conservative
                    } else if (currentSmartStrategy === 'growth') {
                        numStocks = 8; // Fewer, focused picks for growth
                    } else if (currentSmartStrategy === 'bluechip') {
                        numStocks = 12; // Mix of established companies
                    } else { // balanced
                        numStocks = 10;
                    }

                    const topStocks = candidateStocks.slice(0, Math.min(numStocks, candidateStocks.length));
                    finalSelectedStocks = topStocks;

                    console.log(`ğŸ¯ Auto-selected ${finalSelectedStocks.length} stocks for ${currentSmartStrategy} strategy`);

                    if (finalSelectedStocks.length < 2) {
                        showAlert('âš ï¸ Not enough stocks available. Please ensure stock data is loaded.');
                        return;
                    }
                }
            } else {
                // Manual strategy mode: must have at least 2 preferred stocks
                finalSelectedStocks = preferredStocks;
                if (finalSelectedStocks.length < 2) {
                    showAlert('âš ï¸ Please select at least 2 preferred stocks (Step 3)');
                    return;
                }
            }

            // Load REAL data for each stock
            const stocksData = [];
            const maxRiskyPrice = currentSmartStrategy === 'risky' ? parseFloat(document.getElementById('riskyMaxPrice').value) : null;

            for (const symbol of finalSelectedStocks) {
                try {
                    const currentData = await DataAPI.getCurrentPrice(symbol);
                    const historicalData = await DataAPI.getHistoricalData(symbol);

                    if (currentData && historicalData && historicalData.length > 0) {
                        // For risky strategy, filter by max price
                        if (maxRiskyPrice && currentData.price > maxRiskyPrice) {
                            console.log(`â­ï¸ Skipping ${symbol} (price ${currentData.price} > max ${maxRiskyPrice})`);
                            continue;
                        }
                        // Calculate real metrics from historical data
                        const closes = historicalData.map(d => d.close);
                        const returns = [];

                        // Calculate daily returns
                        for (let i = 1; i < closes.length; i++) {
                            const dailyReturn = ((closes[i] - closes[i-1]) / closes[i-1]) * 100;
                            if (isFinite(dailyReturn)) {
                                returns.push(dailyReturn);
                            }
                        }

                        // Expected return (annualized from average daily return)
                        const avgDailyReturn = returns.length > 0 ? returns.reduce((a, b) => a + b, 0) / returns.length : 0;
                        const expectedReturn = avgDailyReturn * 252; // 252 trading days per year

                        // Risk (annualized volatility)
                        const variance = returns.length > 0 ? returns.reduce((sum, r) => sum + Math.pow(r - avgDailyReturn, 2), 0) / returns.length : 0;
                        const dailyVolatility = Math.sqrt(Math.max(0, variance));
                        const risk = dailyVolatility * Math.sqrt(252);

                        // 3-month performance
                        const threeMonthsAgo = Math.max(0, closes.length - 63); // ~3 months = 63 trading days
                        const performance3M = ((closes[closes.length - 1] - closes[threeMonthsAgo]) / closes[threeMonthsAgo]) * 100;

                        // Simple beta estimate (using price changes as proxy)
                        const beta = Math.abs(avgDailyReturn) * 10; // Simplified beta estimation

                        // P/E ratio placeholder (would need earnings data)
                        const pe = 15; // Default P/E

                        // Market cap based on price range
                        const currentPrice = currentData.price;
                        const marketCap = currentPrice > 50000 ? 'Large' : currentPrice > 20000 ? 'Mid' : 'Small';

                        const safeRisk = Math.max(risk, 1); // Minimum 1% risk
                        const safeExpectedReturn = isFinite(expectedReturn) ? Math.max(expectedReturn, -50) : 0;
                        const safeSharpeRatio = isFinite(expectedReturn / safeRisk) ? expectedReturn / safeRisk : 0;
                        const safePerformance3M = isFinite(performance3M) ? performance3M : 0;
                        const safeBeta = isFinite(beta) ? Math.min(Math.max(beta, 0.5), 2.0) : 1.0;

                        stocksData.push({
                            symbol,
                            expectedReturn: safeExpectedReturn,
                            risk: safeRisk,
                            sharpeRatio: safeSharpeRatio,
                            currentPrice,
                            performance3M: safePerformance3M,
                            beta: safeBeta,
                            pe,
                            marketCap
                        });
                    }
                } catch (error) {
                    console.error(`Error loading data for ${symbol}:`, error);
                }
            }

            if (stocksData.length < 2) {
                showAlert('Not enough data available for selected stocks. Please try different stocks.');
                return;
            }

            // Sort stocks based on strategy
            if (currentStrategy === 'smart' && currentSmartStrategy) {
                if (currentSmartStrategy === 'risky') {
                    // Sort by highest expected return for risky strategy (high risk = high reward)
                    stocksData.sort((a, b) => b.expectedReturn - a.expectedReturn);
                    console.log('ğŸš€ Sorted by expected return (risky strategy)');
                } else if (currentSmartStrategy === 'growth') {
                    // Sort by performance for growth strategy
                    stocksData.sort((a, b) => b.performance3M - a.performance3M);
                    console.log('ğŸ“ˆ Sorted by performance (growth strategy)');
                } else if (currentSmartStrategy === 'conservative') {
                    // Sort by lowest risk for conservative strategy
                    stocksData.sort((a, b) => a.risk - b.risk);
                    console.log('ğŸ›¡ï¸ Sorted by lowest risk (conservative strategy)');
                } else if (currentSmartStrategy === 'bluechip') {
                    // Sort by Sharpe ratio but prefer larger market cap
                    stocksData.sort((a, b) => {
                        const aScore = b.sharpeRatio + (b.marketCap === 'Large' ? 0.5 : 0);
                        const bScore = a.sharpeRatio + (a.marketCap === 'Large' ? 0.5 : 0);
                        return bScore - aScore;
                    });
                    console.log('â­ Sorted by quality (bluechip strategy)');
                } else { // balanced
                    // Sort by Sharpe ratio (risk-adjusted return)
                    stocksData.sort((a, b) => b.sharpeRatio - a.sharpeRatio);
                    console.log('âš–ï¸ Sorted by Sharpe ratio (balanced strategy)');
                }
            } else {
                // Default sort by Sharpe ratio
                stocksData.sort((a, b) => b.sharpeRatio - a.sharpeRatio);
                console.log('ğŸ“Š Sorted by Sharpe ratio (default)');
            }

            // Calculate allocations using multiple strategies
            let recommendedStrategy;

            if (preferredStocks.length > 0) {
                // Preferred stocks strategy: allocate evenly among preferred stocks first
                const minPreferredAllocation = 10; // Minimum 10% per preferred stock
                const totalPreferredAllocation = Math.min(preferredStocks.length * minPreferredAllocation, 80); // Max 80% for preferred
                const perPreferredAllocation = totalPreferredAllocation / preferredStocks.length;

                recommendedStrategy = stocksData.map(stock => {
                    if (preferredStocks.includes(stock.symbol)) {
                        return perPreferredAllocation;
                    } else {
                        // Distribute remaining percentage among non-preferred stocks
                        const remainingPercent = 100 - totalPreferredAllocation;
                        const nonPreferredCount = stocksData.length - preferredStocks.length;
                        return nonPreferredCount > 0 ? remainingPercent / nonPreferredCount : 0;
                    }
                });
            } else {
                // Standard allocation strategies
                const strategies = {
                    'Risk-Adjusted (Recommended)': calculateRiskAdjustedAllocation(stocksData),
                    'Equal Weight': calculateEqualWeightAllocation(stocksData),
                    'Performance-Based': calculatePerformanceBasedAllocation(stocksData),
                    'Low Risk': calculateLowRiskAllocation(stocksData),
                    'Risky (Highest Return)': calculateRiskyAllocation(stocksData)
                };

                // Map smart strategy to allocation method
                let allocationMethod = 'Risk-Adjusted (Recommended)'; // Default

                if (currentStrategy === 'smart' && currentSmartStrategy) {
                    const strategyMapping = {
                        'balanced': 'Risk-Adjusted (Recommended)',
                        'growth': 'Performance-Based',
                        'conservative': 'Low Risk',
                        'bluechip': 'Equal Weight',
                        'risky': 'Risky (Highest Return)'
                    };
                    allocationMethod = strategyMapping[currentSmartStrategy] || 'Risk-Adjusted (Recommended)';
                    console.log(`ğŸ“Š Using ${allocationMethod} allocation for ${currentSmartStrategy} strategy`);
                }

                recommendedStrategy = strategies[allocationMethod];
            }

            // Calculate actual amounts
            const allocations = stocksData.map((stock, index) => {
                const percentage = isFinite(recommendedStrategy[index]) ? recommendedStrategy[index] : 0;
                const amount = budget * (percentage / 100);
                const shares = isFinite(amount / stock.currentPrice) ? Math.floor(amount / stock.currentPrice) : 0;
                const actualAmount = shares * stock.currentPrice;

                return {
                    ...stock,
                    percentage: isFinite(percentage) ? percentage.toFixed(2) : '0.00',
                    amount: isFinite(actualAmount) ? actualAmount : 0,
                    shares: isFinite(shares) ? shares : 0
                };
            });

            // Distribute remaining budget to use 100% of money
            let totalAllocated = allocations.reduce((sum, a) => sum + a.amount, 0);
            let remaining = budget - totalAllocated;

            // Sort by allocation amount (highest first) to distribute remaining
            const sortedByAmount = [...allocations].sort((a, b) => b.amount - a.amount);

            // Add one share at a time to stocks until budget is exhausted
            let stockIndex = 0;
            while (remaining > 0 && stockIndex < sortedByAmount.length) {
                const stock = sortedByAmount[stockIndex];

                // Check if we can afford one more share
                if (stock.currentPrice <= remaining) {
                    // Find this stock in original allocations array
                    const originalIndex = allocations.findIndex(a => a.symbol === stock.symbol);
                    if (originalIndex !== -1) {
                        allocations[originalIndex].shares += 1;
                        allocations[originalIndex].amount += stock.currentPrice;
                        remaining -= stock.currentPrice;
                    }
                } else {
                    // Can't afford this stock, try next one
                    stockIndex++;
                }
            }

            // Recalculate percentages based on actual amounts to show true allocation
            totalAllocated = allocations.reduce((sum, a) => sum + a.amount, 0);
            allocations.forEach(stock => {
                const actualPercentage = (stock.amount / totalAllocated) * 100;
                stock.percentage = isFinite(actualPercentage) ? actualPercentage.toFixed(2) : '0.00';
            });

            console.log('âœ… Investment plan calculated successfully');
            console.log('ğŸ“Š Allocations:', allocations);

            // Display results
            displayInvestmentPlan(allocations, budget, null, currentPortfolioType, existingHoldings, preferredStocks);

            console.log('âœ… Investment plan displayed');

            } catch (error) {
                console.error('âŒ Error in generateInvestmentPlan:', error);
                console.error('Stack trace:', error.stack);
                if (typeof showError === 'function') {
                    showError('Error generating investment plan: ' + error.message);
                } else {
                    alert('Error generating investment plan: ' + error.message);
                }
            }
        }

        function calculateRiskAdjustedAllocation(stocks) {
            // Allocate based on Sharpe ratio (risk-adjusted return)
            const totalSharpe = stocks.reduce((sum, s) => sum + Math.max(s.sharpeRatio, 0), 0);
            if (totalSharpe === 0) {
                // Fallback to equal weight if no positive Sharpe ratios
                return calculateEqualWeightAllocation(stocks);
            }
            return stocks.map(s => (Math.max(s.sharpeRatio, 0) / totalSharpe) * 100);
        }

        function calculateEqualWeightAllocation(stocks) {
            const equalWeight = 100 / stocks.length;
            return stocks.map(() => equalWeight);
        }

        function calculatePerformanceBasedAllocation(stocks) {
            // Allocate based on recent performance
            const performanceScores = stocks.map(s => Math.max(0, s.performance3M + 20)); // Shift to positive
            const totalScore = performanceScores.reduce((sum, s) => sum + s, 0);
            if (totalScore === 0) {
                return calculateEqualWeightAllocation(stocks);
            }
            return performanceScores.map(s => (s / totalScore) * 100);
        }

        function calculateLowRiskAllocation(stocks) {
            // Allocate more to lower risk stocks
            const riskScores = stocks.map(s => 1 / Math.max(s.risk, 0.1)); // Inverse of risk, avoid division by zero
            const totalScore = riskScores.reduce((sum, s) => sum + s, 0);
            if (totalScore === 0) {
                return calculateEqualWeightAllocation(stocks);
            }
            return riskScores.map(s => (s / totalScore) * 100);
        }

        function calculateRiskyAllocation(stocks) {
            // Allocate based on expected return (highest return first)
            // Normalize expected returns to positive scale for allocation
            const minReturn = Math.min(...stocks.map(s => s.expectedReturn));
            const maxReturn = Math.max(...stocks.map(s => s.expectedReturn));
            const returnRange = maxReturn - minReturn || 1;

            const returnScores = stocks.map(s => (s.expectedReturn - minReturn) / returnRange + 0.1); // Add 0.1 minimum
            const totalScore = returnScores.reduce((sum, s) => sum + s, 0);

            if (totalScore === 0) {
                return calculateEqualWeightAllocation(stocks);
            }
            return returnScores.map(s => (s / totalScore) * 100);
        }

        function displayInvestmentPlan(allocations, budget, strategies, portfolioType = 'new', existingHoldings = [], preferredStocks = []) {
            // Show results section
            const resultsWrapper = document.getElementById('investmentPlanResultsWrapper');
            if (!resultsWrapper) return;

            resultsWrapper.style.display = 'block';

            // Ensure card-content is visible
            const cardContent = resultsWrapper.querySelector('.card-content');
            if (cardContent) {
                cardContent.style.display = 'block';
            }

            // Update results header with strategy and portfolio type info
            const strategyNames = {
                'balanced': 'âš–ï¸ Balanced Strategy',
                'growth': 'ğŸ“ˆ High Growth Strategy',
                'conservative': 'ğŸ›¡ï¸ Conservative Strategy',
                'bluechip': 'â­ Blue Chip Strategy',
                'risky': 'ğŸš€ Risky Strategy (Highest Potential)'
            };

            const strategyText = currentStrategy === 'smart'
                ? strategyNames[currentSmartStrategy] || 'Smart Strategy'
                : 'ğŸ‘¤ Manual Selection';

            const portfolioTypeText = currentPortfolioType === 'existing'
                ? 'ğŸ“‚ Optimizing Existing Portfolio'
                : 'âœ¨ Building New Portfolio';

            document.getElementById('planStrategyName').textContent = `Strategy: ${strategyText}`;
            document.getElementById('planPortfolioType').textContent = `Portfolio Type: ${portfolioTypeText}`;

            // Scroll to results
            setTimeout(() => {
                resultsWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);

            // Calculate existing portfolio value
            const existingValue = existingHoldings.reduce((sum, h) => sum + h.currentValue, 0);
            const existingCost = existingHoldings.reduce((sum, h) => sum + h.totalCost, 0);
            const existingProfitLoss = existingValue - existingCost;

            // Summary metrics
            const totalAllocated = allocations.reduce((sum, a) => sum + (isFinite(a.amount) ? a.amount : 0), 0);
            const remainingBudget = budget - totalAllocated;
            const weightedReturn = allocations.reduce((sum, a) => {
                const contrib = (a.expectedReturn * parseFloat(a.percentage)) / 100;
                return sum + (isFinite(contrib) ? contrib : 0);
            }, 0);
            const weightedRisk = Math.sqrt(allocations.reduce((sum, a) => {
                const contrib = Math.pow(a.risk * parseFloat(a.percentage) / 100, 2);
                return sum + (isFinite(contrib) ? contrib : 0);
            }, 0));
            const portfolioSharpe = weightedRisk > 0 && isFinite(weightedReturn / weightedRisk) ? weightedReturn / weightedRisk : 0;

            // Calculate max drawdown and diversification score (needed later)
            const estimatedMaxDrawdown = weightedRisk * 1.5;
            const diversificationScore = Math.min(100, (allocations.length / 20) * 100);

            // Update metric cards in results section
            try {
                console.log('ğŸ“Š Updating metric cards...');
                const portfolioValueEl = document.getElementById('portfolioValue');
                const expectedReturnEl = document.getElementById('expectedReturn');
                const portfolioRiskEl = document.getElementById('portfolioRisk');
                const sharpeRatioEl = document.getElementById('sharpeRatio');

                if (!portfolioValueEl) console.error('âŒ portfolioValue element not found');
                if (!expectedReturnEl) console.error('âŒ expectedReturn element not found');
                if (!portfolioRiskEl) console.error('âŒ portfolioRisk element not found');
                if (!sharpeRatioEl) console.error('âŒ sharpeRatio element not found');

                if (portfolioValueEl) portfolioValueEl.textContent = totalAllocated.toLocaleString() + ' VND';
                if (expectedReturnEl) expectedReturnEl.textContent = weightedReturn.toFixed(2) + '%';
                if (portfolioRiskEl) portfolioRiskEl.textContent = weightedRisk.toFixed(2) + '%';
                if (sharpeRatioEl) sharpeRatioEl.textContent = portfolioSharpe.toFixed(2);

                const maxDrawdownEl = document.getElementById('maxDrawdown');
                if (maxDrawdownEl) maxDrawdownEl.textContent = estimatedMaxDrawdown.toFixed(1) + '%';

                const diversificationEl = document.getElementById('diversification');
                if (diversificationEl) diversificationEl.textContent = diversificationScore.toFixed(0) + '%';

                console.log('âœ… Metric cards updated');
            } catch (error) {
                console.error('âŒ Error updating metrics:', error);
            }

            // Update portfolioAnalysisResults for download functionality
            portfolioAnalysisResults = {
                analyzed: true,
                strategy: currentStrategy,
                strategyName: strategyText,
                portfolioValue: totalAllocated,
                totalReturn: weightedReturn,
                riskLevel: weightedRisk,
                sharpeRatio: portfolioSharpe,
                maxDrawdown: estimatedMaxDrawdown,
                diversification: diversificationScore,
                holdings: allocations,
                sectors: {},
                performance: {
                    bestPerformer: allocations[0] || null,
                    worstPerformer: allocations[allocations.length - 1] || null,
                    mostVolatile: allocations.reduce((max, a) => a.risk > (max?.risk || 0) ? a : max, null),
                    mostStable: allocations.reduce((min, a) => a.risk < (min?.risk || Infinity) ? a : min, null)
                },
                timestamp: new Date().toISOString()
            };

            let summaryHTML = '';

            // Show preferred stocks info if applicable
            if (preferredStocks.length > 0) {
                summaryHTML += `
                    <div style="background: #d1fae5; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981; grid-column: 1/-1; margin-bottom: 15px;">
                        <div style="font-weight: 700; color: #065f46; font-size: 1.1em; margin-bottom: 8px;">â­ PREFERRED STOCKS STRATEGY</div>
                        <div style="color: #047857;">
                            You selected <strong>${preferredStocks.length} preferred stock(s)</strong>: ${preferredStocks.join(', ')}
                        </div>
                        <div style="font-size: 0.9em; color: #059669; margin-top: 5px;">
                            â„¹ï¸ These stocks are prioritized in your portfolio with balanced allocation. Additional budget is optimized across other suitable stocks.
                        </div>
                    </div>
                `;
            }

            // Show existing portfolio summary if applicable
            if (portfolioType === 'existing' && existingHoldings.length > 0) {
                const profitColor = existingProfitLoss >= 0 ? '#16a34a' : '#dc2626';
                const profitSign = existingProfitLoss >= 0 ? '+' : '';
                const profitPercent = ((existingProfitLoss / existingCost) * 100).toFixed(2);

                summaryHTML += `
                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b; grid-column: 1/-1;">
                        <div style="font-weight: 700; color: #92400e; font-size: 1.1em; margin-bottom: 10px;">ğŸ’¼ EXISTING PORTFOLIO</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            <div>
                                <div style="font-size: 0.85em; color: #78350f;">Current Value</div>
                                <div style="font-weight: 700; color: #92400e;">${existingValue.toLocaleString()} VND</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85em; color: #78350f;">Total Cost</div>
                                <div style="font-weight: 700; color: #92400e;">${existingCost.toLocaleString()} VND</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85em; color: #78350f;">Profit/Loss</div>
                                <div style="font-weight: 700; color: ${profitColor};">${profitSign}${existingProfitLoss.toLocaleString()} VND (${profitSign}${profitPercent}%)</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            summaryHTML += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                    <div style="background: #dbeafe; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <div style="font-weight: 600; color: #1e40af; font-size: 0.9em;">Total Budget</div>
                        <div style="font-size: 1.2em; font-weight: 700; color: #1e3a8a;">${budget.toLocaleString()} VND</div>
                    </div>
                    <div style="background: #dcfce7; padding: 15px; border-radius: 8px; border-left: 4px solid #22c55e;">
                        <div style="font-weight: 600; color: #15803d; font-size: 0.9em;">Total Allocated</div>
                        <div style="font-size: 1.2em; font-weight: 700; color: #166534;">${totalAllocated.toLocaleString()} VND</div>
                    </div>
                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <div style="font-weight: 600; color: #92400e; font-size: 0.9em;">Remaining</div>
                        <div style="font-size: 1.2em; font-weight: 700; color: #78350f;">${remainingBudget.toLocaleString()} VND</div>
                    </div>
                    <div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #c41c16;">
                        <div style="font-weight: 600; color: #4338ca; font-size: 0.9em;">Expected Return</div>
                        <div style="font-size: 1.2em; font-weight: 700; color: #3730a3;">${weightedReturn.toFixed(2)}%</div>
                    </div>
                    <div style="background: #fce7f3; padding: 15px; border-radius: 8px; border-left: 4px solid #ec4899;">
                        <div style="font-weight: 600; color: #9f1239; font-size: 0.9em;">Portfolio Risk</div>
                        <div style="font-size: 1.2em; font-weight: 700; color: #881337;">${weightedRisk.toFixed(2)}%</div>
                    </div>
                    <div style="background: #f3e8ff; padding: 15px; border-radius: 8px; border-left: 4px solid #a855f7;">
                        <div style="font-weight: 600; color: #6b21a8; font-size: 0.9em;">Sharpe Ratio</div>
                        <div style="font-size: 1.2em; font-weight: 700; color: #581c87;">${portfolioSharpe.toFixed(2)}</div>
                    </div>
                </div>
            `;
            console.log('ğŸ“ Setting investment summary HTML, length:', summaryHTML.length);
            const summaryContainer = document.getElementById('investmentSummaryContainer');
            if (!summaryContainer) {
                console.error('âŒ investmentSummaryContainer not found!');
            } else {
                summaryContainer.innerHTML = summaryHTML;
                console.log('âœ… Investment summary set, container height:', summaryContainer.offsetHeight);
            }

            // Show existing holdings recommendations if applicable
            const existingHoldingsSummaryEl = document.getElementById('existingHoldingsSummary');
            if (existingHoldingsSummaryEl) existingHoldingsSummaryEl.innerHTML = '';
            let existingHoldingsHTML = '';
            if (portfolioType === 'existing' && existingHoldings.length > 0) {
                existingHoldingsHTML = `
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #f59e0b;">
                        <h4 style="color: #92400e; margin-bottom: 15px; font-size: 1.1em; font-weight: 600;">ğŸ’¼ Your Current Holdings - Action Recommendations</h4>
                        <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
                            <colgroup>
                                <col style="width: 10%;">
                                <col style="width: 8%;">
                                <col style="width: 10%;">
                                <col style="width: 10%;">
                                <col style="width: 12%;">
                                <col style="width: 15%;">
                                <col style="width: 35%;">
                            </colgroup>
                            <thead>
                                <tr style="background: #fef3c7;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #f59e0b;" data-i18n="table.stock">Stock</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #f59e0b;" data-i18n="table.shares">Shares</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #f59e0b;" data-i18n="table.buy_price">Buy Price</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #f59e0b;" data-i18n="table.current">Current</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #f59e0b;" data-i18n="table.profit_loss">Profit/Loss</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #f59e0b;" data-i18n="table.action">Action</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #f59e0b;" data-i18n="table.recommendation">Recommendation</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                for (const holding of existingHoldings) {
                    const profitColor = holding.profitLossPercent >= 0 ? '#16a34a' : '#dc2626';
                    const profitSign = holding.profitLossPercent >= 0 ? '+' : '';

                    // Determine action based on profit/loss and if stock is in recommended list
                    const isRecommended = allocations.some(a => a.symbol === holding.symbol);
                    let action, actionColor, recommendation;

                    if (holding.profitLossPercent > 20) {
                        action = 'ğŸ’° TAKE PROFIT';
                        actionColor = '#16a34a';
                        recommendation = `Strong gain of ${profitSign}${holding.profitLossPercent.toFixed(1)}%. Consider selling part to lock in profits.`;
                    } else if (holding.profitLossPercent < -15) {
                        action = 'âš ï¸ REVIEW/SELL';
                        actionColor = '#dc2626';
                        recommendation = `Significant loss of ${holding.profitLossPercent.toFixed(1)}%. Consider cutting losses or averaging down if fundamentals strong.`;
                    } else if (isRecommended) {
                        action = 'âœ… HOLD/BUY MORE';
                        actionColor = '#3b82f6';
                        recommendation = `Stock is in optimal portfolio. Consider adding more with new cash flow.`;
                    } else {
                        action = 'ğŸ”„ HOLD';
                        actionColor = '#64748b';
                        recommendation = `Moderate performance. Hold for now and monitor.`;
                    }

                    existingHoldingsHTML += `
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 12px; font-weight: 600;">${getStockDisplayName(holding.symbol)}</td>
                            <td style="padding: 12px; text-align: right;">${holding.shares}</td>
                            <td style="padding: 12px; text-align: right;">${Math.round(holding.buyPrice).toLocaleString()}</td>
                            <td style="padding: 12px; text-align: right;">${Math.round(holding.currentPrice).toLocaleString()}</td>
                            <td style="padding: 12px; text-align: right; font-weight: 600; color: ${profitColor};">
                                ${profitSign}${holding.profitLoss.toLocaleString()} VND<br>
                                <span style="font-size: 0.85em;">(${profitSign}${holding.profitLossPercent.toFixed(1)}%)</span>
                            </td>
                            <td style="padding: 12px; text-align: center; font-weight: 700; color: ${actionColor}; white-space: nowrap;">
                                ${action}
                            </td>
                            <td style="padding: 12px; font-size: 0.9em; color: #64748b; word-wrap: break-word;">
                                ${recommendation}
                            </td>
                        </tr>
                    `;
                }

                existingHoldingsHTML += `
                            </tbody>
                        </table>
                    </div>
                `;

                document.getElementById('existingHoldingsSummary').innerHTML = existingHoldingsHTML;
            }

            // Allocation table header changes based on portfolio type
            const tableTitleKey = portfolioType === 'existing' ? 'portfolio.recommended_actions' : 'portfolio.recommended_positions';
            const tableTitle = t(tableTitleKey);

            const noteKey = portfolioType === 'existing' ? 'tip.note_existing_allocation' : 'tip.note_new_allocation';
            const noteText = t(noteKey);

            let tableHTML = `
                <h4 style="color: #1e40af; margin-bottom: 15px; font-size: 1.1em; font-weight: 600;">ğŸ¯ ${tableTitle}</h4>
                <div style="padding: 12px; background: #dbeafe; border-radius: 6px; margin-bottom: 15px; font-size: 0.9em; color: #1e40af;">
                    ğŸ’¡ <strong>${noteText}</strong>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f1f5f9;">
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #cbd5e1;" data-i18n="table.stock">Stock</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #cbd5e1;" data-i18n="table.allocation">Allocation</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #cbd5e1;" data-i18n="table.amount_vnd">Amount (VND)</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #cbd5e1;" data-i18n="table.shares">Shares</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #cbd5e1;" data-i18n="table.price">Price</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #cbd5e1;" data-i18n="table.exp_return">Exp. Return</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #cbd5e1;" data-i18n="table.risk">Risk</th>
                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #cbd5e1;">ğŸ“Š Chart</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            allocations.forEach(stock => {
                const returnColor = stock.expectedReturn > 15 ? '#16a34a' : stock.expectedReturn > 10 ? '#ca8a04' : '#dc2626';
                const riskColor = stock.risk < 15 ? '#16a34a' : stock.risk < 25 ? '#ca8a04' : '#dc2626';
                const displayName = getStockDisplayName(stock.symbol);
                const isPreferred = preferredStocks.includes(stock.symbol);
                const preferredBadge = isPreferred ? '<span style="background: #10b981; color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.75em; margin-left: 8px; font-weight: 700;">â­ PREFERRED</span>' : '';

                tableHTML += `
                    <tr style="border-bottom: 1px solid #e2e8f0; ${isPreferred ? 'background: #d1fae5;' : ''}">
                        <td style="padding: 12px; font-weight: 600;" title="${displayName}">${displayName}${preferredBadge}</td>
                        <td style="padding: 12px; text-align: right; font-weight: 700; color: #3b82f6;">${stock.percentage}%</td>
                        <td style="padding: 12px; text-align: right;">${stock.amount.toLocaleString()}</td>
                        <td style="padding: 12px; text-align: right; font-weight: 600;">${stock.shares}</td>
                        <td style="padding: 12px; text-align: right;">${Math.round(stock.currentPrice).toLocaleString()}</td>
                        <td style="padding: 12px; text-align: right; color: ${returnColor}; font-weight: 600;">${stock.expectedReturn.toFixed(1)}%</td>
                        <td style="padding: 12px; text-align: right; color: ${riskColor}; font-weight: 600;">${stock.risk.toFixed(1)}%</td>
                        <td style="padding: 12px; text-align: center;">
                            <a href="advanced_charts.html?symbol=${stock.symbol}" style="
                                background: #3b82f6;
                                color: white;
                                padding: 6px 12px;
                                border-radius: 6px;
                                text-decoration: none;
                                font-weight: 600;
                                font-size: 0.9em;
                                display: inline-block;
                                transition: all 0.2s;
                            " onmouseover="this.style.background='#1d4ed8'" onmouseout="this.style.background='#3b82f6'">
                                ğŸ“ˆ Chart
                            </a>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;
            console.log('ğŸ“‹ Setting holdings table HTML, length:', tableHTML.length);
            const holdingsContainer = document.getElementById('holdingsTableContainer');
            if (!holdingsContainer) {
                console.error('âŒ holdingsTableContainer not found!');
            } else {
                holdingsContainer.innerHTML = tableHTML;
                console.log('âœ… Holdings table set, container height:', holdingsContainer.offsetHeight);
            }

            // Business Consolidation & Sector Analysis - Comprehensive mapping
            const sectorMap = {
                // Banking
                'VCB': { sector: 'Banking', business: 'Commercial Banking & Financial Services' },
                'TCB': { sector: 'Banking', business: 'Commercial Banking & Retail' },
                'MBB': { sector: 'Banking', business: 'Commercial Banking' },
                'VPB': { sector: 'Banking', business: 'Retail Banking & Consumer Finance' },
                'CTG': { sector: 'Banking', business: 'State-owned Commercial Bank' },
                'BID': { sector: 'Banking', business: 'State-owned Commercial Bank' },
                'ACB': { sector: 'Banking', business: 'Commercial Banking' },
                'STB': { sector: 'Banking', business: 'Commercial Banking' },
                'HDB': { sector: 'Banking', business: 'Housing Development Bank' },
                'TPB': { sector: 'Banking', business: 'Commercial Banking' },
                'VIB': { sector: 'Banking', business: 'International Commercial Bank' },
                'MSB': { sector: 'Banking', business: 'Maritime Commercial Bank' },
                'SHB': { sector: 'Banking', business: 'Saigon-Hanoi Commercial Bank' },
                'EIB': { sector: 'Banking', business: 'Export Import Commercial Bank' },
                'LPB': { sector: 'Banking', business: 'Lien Viet Post Bank' },
                'OCB': { sector: 'Banking', business: 'Orient Commercial Bank' },
                'VAB': { sector: 'Banking', business: 'Vietnam Asia Commercial Bank' },
                'VBB': { sector: 'Banking', business: 'Viet Capital Bank' },
                'BAB': { sector: 'Banking', business: 'Bac A Commercial Bank' },
                'BVB': { sector: 'Banking', business: 'Bao Viet Bank' },
                'NVB': { sector: 'Banking', business: 'National Citizen Bank' },
                'PGB': { sector: 'Banking', business: 'Petrolimex Group Bank' },
                'SGB': { sector: 'Banking', business: 'Saigon Bank' },
                'ABB': { sector: 'Banking', business: 'An Binh Commercial Bank' },
                'NAB': { sector: 'Banking', business: 'Nam A Commercial Bank' },

                // Real Estate
                'VHM': { sector: 'Real Estate', business: 'Property Development & Sales' },
                'VIC': { sector: 'Real Estate', business: 'Diversified Conglomerate (Real Estate, Retail, Tech)' },
                'NVL': { sector: 'Real Estate', business: 'Property Development' },
                'PDR': { sector: 'Real Estate', business: 'Property Development' },
                'DXG': { sector: 'Real Estate', business: 'Property Development' },
                'KDH': { sector: 'Real Estate', business: 'Property Development' },
                'BCM': { sector: 'Real Estate', business: 'Property Investment' },
                'DIG': { sector: 'Real Estate', business: 'Property Development' },
                'HDG': { sector: 'Real Estate', business: 'Property Development' },
                'NLG': { sector: 'Real Estate', business: 'Property Development' },
                'VRE': { sector: 'Real Estate', business: 'Property Development & Management' },
                'DXS': { sector: 'Real Estate', business: 'Real Estate Services' },
                'SCR': { sector: 'Real Estate', business: 'Real Estate Services' },
                'CEO': { sector: 'Real Estate', business: 'Construction & Real Estate' },
                'HDC': { sector: 'Real Estate', business: 'Property Development' },
                'LDG': { sector: 'Real Estate', business: 'Property Development' },
                'QCG': { sector: 'Real Estate', business: 'Real Estate & Construction' },
                'TCH': { sector: 'Real Estate', business: 'Property Development' },
                'TDH': { sector: 'Real Estate', business: 'Property Development' },

                // Technology
                'FPT': { sector: 'Technology', business: 'IT Services, Software & Telecommunications' },
                'CMG': { sector: 'Technology', business: 'Digital Media & Technology' },
                'VGI': { sector: 'Technology', business: 'IT Services' },
                'SAM': { sector: 'Technology', business: 'IT Services & Solutions' },
                'ITD': { sector: 'Technology', business: 'IT Distribution' },
                'ELC': { sector: 'Technology', business: 'Electronics & Technology' },
                'SGT': { sector: 'Technology', business: 'Technology Services' },
                'ICT': { sector: 'Technology', business: 'IT Services' },
                'DGW': { sector: 'Technology', business: 'Digital Services' },
                'CTR': { sector: 'Technology', business: 'IT Services' },
                'FOX': { sector: 'Technology', business: 'Technology Solutions' },

                // Consumer Goods & Retail
                'VNM': { sector: 'Consumer Goods', business: 'Dairy Products & Beverages' },
                'MSN': { sector: 'Consumer Goods', business: 'Consumer Goods & Retail Conglomerate' },
                'MWG': { sector: 'Retail', business: 'Electronics & Consumer Goods Retail' },
                'PNJ': { sector: 'Retail', business: 'Jewelry Retail' },
                'SAB': { sector: 'Consumer Goods', business: 'Beverage Production (Beer)' },
                'VHC': { sector: 'Consumer Goods', business: 'Beverages' },
                'DGC': { sector: 'Consumer Goods', business: 'Confectionery & Food' },
                'KDC': { sector: 'Consumer Goods', business: 'Confectionery' },
                'FRT': { sector: 'Retail', business: 'Retail' },
                'DBC': { sector: 'Consumer Goods', business: 'Detergent & Consumer Products' },
                'MCH': { sector: 'Consumer Goods', business: 'Seafood Processing' },
                'VCF': { sector: 'Consumer Goods', business: 'Food Products' },
                'QNS': { sector: 'Consumer Goods', business: 'Sugar Production' },
                'BBC': { sector: 'Consumer Goods', business: 'Confectionery' },

                // Oil & Gas
                'GAS': { sector: 'Oil & Gas', business: 'Gas Transportation & Distribution' },
                'PLX': { sector: 'Oil & Gas', business: 'Petroleum Distribution' },
                'PVD': { sector: 'Oil & Gas', business: 'Drilling Services' },
                'PVS': { sector: 'Oil & Gas', business: 'Shipping & Marine Services' },
                'PVT': { sector: 'Oil & Gas', business: 'Transportation & Services' },
                'PVB': { sector: 'Oil & Gas', business: 'Oil & Gas Services' },
                'PVG': { sector: 'Oil & Gas', business: 'Gas Corporation' },
                'PVC': { sector: 'Oil & Gas', business: 'Petrochemical & Textile Fiber' },
                'BSR': { sector: 'Oil & Gas', business: 'Oil Refining' },
                'OIL': { sector: 'Oil & Gas', business: 'Petroleum Services' },

                // Industrial & Manufacturing
                'HPG': { sector: 'Industrial', business: 'Steel Production & Manufacturing' },
                'HSG': { sector: 'Industrial', business: 'Steel Manufacturing' },
                'NKG': { sector: 'Industrial', business: 'Steel Production' },
                'VCS': { sector: 'Industrial', business: 'Construction Materials' },
                'TVN': { sector: 'Industrial', business: 'Steel Manufacturing' },
                'DTL': { sector: 'Industrial', business: 'Textiles' },
                'TLH': { sector: 'Industrial', business: 'Steel & Construction' },
                'VGS': { sector: 'Industrial', business: 'Ship Building' },
                'HT1': { sector: 'Industrial', business: 'Steel Processing' },
                'TIS': { sector: 'Industrial', business: 'Industrial Services' },
                'AAA': { sector: 'Industrial', business: 'Plastics & Manufacturing' },
                'DCM': { sector: 'Industrial', business: 'Fertilizers & Chemicals' },
                'DPM': { sector: 'Industrial', business: 'Fertilizers' },

                // Transportation
                'VJC': { sector: 'Transportation', business: 'Aviation' },
                'HVN': { sector: 'Transportation', business: 'Aviation' },
                'VTP': { sector: 'Transportation', business: 'Transportation Services' },
                'VSC': { sector: 'Transportation', business: 'Shipping Services' },
                'GMD': { sector: 'Transportation', business: 'Port & Logistics' },
                'VOS': { sector: 'Transportation', business: 'Shipping Services' },
                'ACV': { sector: 'Transportation', business: 'Airport Services' },

                // Utilities
                'POW': { sector: 'Utilities', business: 'Electricity Generation' },
                'NT2': { sector: 'Utilities', business: 'Electricity Generation' },
                'REE': { sector: 'Utilities', business: 'Electrical Engineering & Power' },
                'PC1': { sector: 'Utilities', business: 'Power Construction' },
                'PPC': { sector: 'Utilities', business: 'Power Generation' },
                'VSH': { sector: 'Utilities', business: 'Water Supply' },
                'BWE': { sector: 'Utilities', business: 'Water & Environment' },

                // Financial Services
                'SSI': { sector: 'Financial Services', business: 'Securities & Brokerage' },
                'VCI': { sector: 'Financial Services', business: 'Securities & Investment' },
                'SHS': { sector: 'Financial Services', business: 'Securities & Brokerage' },
                'VDS': { sector: 'Financial Services', business: 'Securities Services' },
                'HCM': { sector: 'Financial Services', business: 'Securities' },
                'AGR': { sector: 'Financial Services', business: 'Securities' },
                'VIX': { sector: 'Financial Services', business: 'Securities' },
                'BSI': { sector: 'Financial Services', business: 'Securities' },
                'FTS': { sector: 'Financial Services', business: 'Securities' }
            };

            // Calculate sector allocation
            const sectorAllocation = {};
            const businessTypes = {};
            allocations.forEach(stock => {
                const info = sectorMap[stock.symbol] || { sector: 'Other', business: 'Diversified Business' };
                const sector = info.sector;
                const percentage = parseFloat(stock.percentage);

                if (!sectorAllocation[sector]) {
                    sectorAllocation[sector] = 0;
                }
                sectorAllocation[sector] += percentage;

                businessTypes[stock.symbol] = info.business;
            });

            // Sort sectors by allocation
            const sortedSectors = Object.entries(sectorAllocation).sort((a, b) => b[1] - a[1]);

            // Create business consolidation HTML
            let businessHTML = `
                <div style="background: white; padding: 25px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #8b5cf6;">
                    <h4 style="color: #5b21b6; margin-bottom: 15px; font-size: 1.1em; font-weight: 600;">${t('section.business_sector_analysis')}</h4>

                    <!-- Sector Diversification -->
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: 600; color: #1e293b; margin-bottom: 10px;">${t('section.sector_diversification')}</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
            `;

            sortedSectors.forEach(([sector, percentage]) => {
                const barWidth = percentage;
                const sectorColor = {
                    'Banking': '#3b82f6',
                    'Technology': '#8b5cf6',
                    'Real Estate': '#f59e0b',
                    'Consumer Goods': '#10b981',
                    'Oil & Gas': '#ef4444',
                    'Steel & Materials': '#64748b',
                    'Retail': '#ec4899',
                    'Conglomerate': '#14b8a6',
                    'Utilities': '#06b6d4',
                    'Financial Services': '#6366f1'
                }[sector] || '#94a3b8';

                businessHTML += `
                    <div style="padding: 10px; background: #f8fafc; border-radius: 6px; border-left: 4px solid ${sectorColor};">
                        <div style="font-weight: 600; color: #1e293b; font-size: 0.9em;">${sector}</div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                            <div style="flex: 1; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; width: ${barWidth}%; background: ${sectorColor};"></div>
                            </div>
                            <div style="font-weight: 700; color: ${sectorColor};">${percentage.toFixed(1)}%</div>
                        </div>
                    </div>
                `;
            });

            businessHTML += `
                        </div>
                    </div>

                    <!-- Portfolio Balance Assessment -->
                    <div style="padding: 15px; background: ${sortedSectors[0][1] > 40 ? '#fef3c7' : sortedSectors.length >= 5 ? '#d1fae5' : '#dbeafe'}; border-radius: 8px; border-left: 4px solid ${sortedSectors[0][1] > 40 ? '#f59e0b' : sortedSectors.length >= 5 ? '#10b981' : '#3b82f6'}; margin-bottom: 15px;">
                        <div style="font-weight: 600; margin-bottom: 5px;">
                            ${sortedSectors[0][1] > 40 ? 'âš ï¸ Concentration Risk' : sortedSectors.length >= 5 ? 'âœ… Well Diversified' : 'â„¹ï¸ Moderate Diversification'}
                        </div>
                        <div style="font-size: 0.9em;">
                            ${sortedSectors[0][1] > 40
                                ? `Portfolio is heavily concentrated in <strong>${sortedSectors[0][0]}</strong> (${sortedSectors[0][1].toFixed(1)}%). Consider diversifying across more sectors to reduce risk.`
                                : sortedSectors.length >= 5
                                ? `Excellent diversification across ${sortedSectors.length} sectors. No single sector exceeds ${sortedSectors[0][1].toFixed(1)}%. This reduces sector-specific risks.`
                                : `Portfolio spans ${sortedSectors.length} sectors with ${sortedSectors[0][0]} being the largest (${sortedSectors[0][1].toFixed(1)}%). Balanced sector allocation.`
                            }
                        </div>
                    </div>

                    <!-- Business Types -->
                    <div style="margin-top: 15px;">
                        <div style="font-weight: 600; color: #1e293b; margin-bottom: 10px;">${t('section.business_overview')}</div>
                        <div style="display: grid; gap: 8px;">
            `;

            allocations.forEach((stock, index) => {
                if (index < 8) { // Show top 8
                    const business = businessTypes[stock.symbol] || 'Diversified Business';
                    const sector = Object.entries(sectorMap).find(([sym]) => sym === stock.symbol)?.[1]?.sector || 'Other';
                    businessHTML += `
                        <div style="padding: 10px; background: #f8fafc; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="font-weight: 600; color: #1e293b;">${getStockDisplayName(stock.symbol)}</span>
                                <span style="color: #64748b; font-size: 0.85em; margin-left: 8px;">(${stock.percentage}%)</span>
                                <div style="font-size: 0.85em; color: #64748b; margin-top: 2px;">${business}</div>
                            </div>
                            <div style="padding: 4px 12px; background: white; border-radius: 15px; font-size: 0.8em; font-weight: 600; color: #5b21b6;">
                                ${sector}
                            </div>
                        </div>
                    `;
                }
            });

            businessHTML += `
                        </div>
                    </div>
                </div>
            `;

            // Append business analysis to investment summary container
            document.getElementById('investmentSummaryContainer').insertAdjacentHTML('beforeend', businessHTML);

            // Investment rationale
            let rationaleHTML = '<div style="display: grid; gap: 15px;">';

            allocations.forEach((stock, index) => {
                const reasons = [];

                // Risk-adjusted performance
                if (stock.sharpeRatio > 1) {
                    reasons.push(`âœ… <strong>Excellent risk-adjusted return</strong> (Sharpe: ${stock.sharpeRatio.toFixed(2)}) - Returns ${stock.expectedReturn.toFixed(1)}% with ${stock.risk.toFixed(1)}% risk`);
                } else if (stock.sharpeRatio > 0.7) {
                    reasons.push(`âœ“ <strong>Good risk-adjusted return</strong> (Sharpe: ${stock.sharpeRatio.toFixed(2)})`);
                }

                // Recent performance
                if (stock.performance3M > 10) {
                    reasons.push(`ğŸ“ˆ <strong>Strong recent performance</strong> (+${stock.performance3M.toFixed(1)}% in 3 months)`);
                } else if (stock.performance3M > 5) {
                    reasons.push(`ğŸ“Š <strong>Positive momentum</strong> (+${stock.performance3M.toFixed(1)}% in 3 months)`);
                }

                // Risk level
                if (stock.risk < 15) {
                    reasons.push(`ğŸ›¡ï¸ <strong>Low volatility</strong> (${stock.risk.toFixed(1)}% risk) - Suitable for conservative investors`);
                } else if (stock.risk < 25) {
                    reasons.push(`âš–ï¸ <strong>Moderate risk</strong> (${stock.risk.toFixed(1)}%) - Balanced risk/reward profile`);
                } else {
                    reasons.push(`âš ï¸ <strong>Higher volatility</strong> (${stock.risk.toFixed(1)}%) - Higher potential returns with increased risk`);
                }

                // Beta
                if (stock.beta < 1) {
                    reasons.push(`ğŸ“‰ <strong>Defensive stock</strong> (Beta: ${stock.beta.toFixed(2)}) - Less volatile than market`);
                } else if (stock.beta > 1.3) {
                    reasons.push(`ğŸ“ˆ <strong>High beta</strong> (${stock.beta.toFixed(2)}) - Amplified market movements`);
                }

                // Valuation
                if (stock.pe < 15) {
                    reasons.push(`ğŸ’° <strong>Attractive valuation</strong> (P/E: ${stock.pe.toFixed(1)}) - Potentially undervalued`);
                } else if (stock.pe > 25) {
                    reasons.push(`ğŸš€ <strong>Growth premium</strong> (P/E: ${stock.pe.toFixed(1)}) - Market expects high growth`);
                }

                // Market cap
                reasons.push(`ğŸ¢ <strong>${stock.marketCap}-cap stock</strong> - ${stock.marketCap === 'Large' ? 'Stable, established company' : stock.marketCap === 'Mid' ? 'Growth potential with moderate stability' : 'Higher growth potential, higher risk'}`);

                // Allocation reasoning
                if (parseFloat(stock.percentage) > 20) {
                    reasons.push(`â­ <strong>Core holding</strong> (${stock.percentage}% allocation) - High confidence in risk/reward profile`);
                } else if (parseFloat(stock.percentage) > 15) {
                    reasons.push(`ğŸ’¼ <strong>Significant position</strong> (${stock.percentage}% allocation) - Important portfolio component`);
                } else {
                    reasons.push(`ğŸ¯ <strong>Diversification component</strong> (${stock.percentage}% allocation) - Balances portfolio risk`);
                }

                const rankBadge = index === 0 ? 'ğŸ¥‡ Top Pick' : index === 1 ? 'ğŸ¥ˆ Second Choice' : index === 2 ? 'ğŸ¥‰ Third Choice' : `#${index + 1}`;

                const displayName = getStockDisplayName(stock.symbol);
                rationaleHTML += `
                    <div style="background: ${index < 3 ? '#f0f9ff' : '#f8fafc'}; padding: 15px; border-radius: 8px; border-left: 4px solid ${index === 0 ? '#3b82f6' : index === 1 ? '#10b981' : index === 2 ? '#f59e0b' : '#64748b'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: #1e293b;">${displayName}</h4>
                            <span style="background: ${index === 0 ? '#3b82f6' : index === 1 ? '#10b981' : index === 2 ? '#f59e0b' : '#64748b'}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">${rankBadge}</span>
                        </div>
                        <div style="color: #475569; line-height: 1.8; font-size: 0.95em;">
                            ${reasons.join('<br>')}
                        </div>
                    </div>
                `;
            });

            rationaleHTML += '</div>';

            // Add strategy comparison
            rationaleHTML += `
                <div style="margin-top: 25px; padding: 20px; background: #fefce8; border-radius: 8px; border: 2px solid #facc15;">
                    <h4 style="color: #854d0e; margin-bottom: 12px; font-size: 1.1em; font-weight: 600;">ğŸ“š Strategy Comparison</h4>
                    <div style="color: #713f12; line-height: 1.8;">
                        <strong>Risk-Adjusted (Recommended):</strong> Allocates based on Sharpe ratio, balancing returns with risk. Best for most investors.<br>
                        <strong>Equal Weight:</strong> Distributes investment equally across all stocks. Simple diversification approach.<br>
                        <strong>Performance-Based:</strong> Favors stocks with strong recent performance. Momentum-driven strategy.<br>
                        <strong>Low Risk:</strong> Prioritizes stocks with lower volatility. Conservative approach for risk-averse investors.
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 20px; background: #f0fdf4; border-radius: 8px; border: 2px solid #22c55e;">
                    <h4 style="color: #166534; margin-bottom: 12px; font-size: 1.1em; font-weight: 600;">ğŸ’¡ Key Recommendations</h4>
                    <div style="color: #15803d; line-height: 1.8;">
                        âœ“ <strong>Diversification:</strong> ${allocations.length} stocks reduce concentration risk<br>
                        âœ“ <strong>Rebalancing:</strong> Review allocation quarterly to maintain target percentages<br>
                        âœ“ <strong>Risk Management:</strong> Set stop-loss at -10% to -15% per position<br>
                        âœ“ <strong>Time Horizon:</strong> Recommended holding period: 6-12 months minimum<br>
                        âœ“ <strong>Reserved Capital:</strong> Keep ${(remainingBudget / budget * 100).toFixed(1)}% in cash for opportunities
                    </div>
                </div>
            `;

            document.getElementById('investmentSummaryContainer').insertAdjacentHTML('beforeend', rationaleHTML);

            // Render charts
            console.log('ğŸ“Š Rendering charts...');
            renderAllocationChartWithData(allocations);
            renderEfficientFrontier();

            // Charts rendered successfully
            console.log('âœ… Investment plan displayed successfully');
        }

        async function runBacktest() {
            const stock = document.getElementById('backtestStock').value;
            const strategy = document.getElementById('strategySelect').value;

            if (!stock) {
                showAlert('Please select a stock');
                return;
            }

            document.getElementById('backtestResults').style.display = 'block';

            // Mock backtest results
            document.getElementById('totalReturn').textContent = '24.5%';
            document.getElementById('winRate').textContent = '65%';
            document.getElementById('totalTrades').textContent = '23';
            document.getElementById('avgTrade').textContent = '1.2%';

            // Render backtest chart
            renderBacktestChart(stock, strategy);
        }

        function renderBacktestChart(stock, strategy) {
            const ctx = document.getElementById('backtestChart');
            if (charts.backtest) charts.backtest.destroy();

            // Generate mock equity curve
            const dates = [];
            const equity = [100000];
            const buyHold = [100000];

            for (let i = 1; i <= 60; i++) {
                const date = new Date();
                date.setDate(date.getDate() - (60 - i));
                dates.push(date.toLocaleDateString());

                equity.push(equity[i-1] * (1 + (Math.random() - 0.45) * 0.02));
                buyHold.push(buyHold[i-1] * (1 + (Math.random() - 0.48) * 0.015));
            }

            charts.backtest = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: `${strategy} Strategy`,
                        data: equity,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true
                    }, {
                        label: 'Buy & Hold',
                        data: buyHold,
                        borderColor: '#64748b',
                        backgroundColor: 'rgba(100, 116, 139, 0.1)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Equity Curve'
                        }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'Portfolio Value (VND)' }
                        }
                    }
                }
            });

            // Generate trade history table
            let html = '<table><thead><tr><th data-i18n="table.date">Date</th><th data-i18n="table.action">Action</th><th data-i18n="table.price">Price</th><th>P/L</th></tr></thead><tbody>';
            for (let i = 0; i < 10; i++) {
                const action = Math.random() > 0.5 ? 'BUY' : 'SELL';
                const pl = (Math.random() - 0.4) * 5;
                html += `<tr>
                    <td>${dates[i * 6]}</td>
                    <td style="color: ${action === 'BUY' ? '#10b981' : '#ef4444'}">${action}</td>
                    <td>${(50000 + Math.random() * 10000).toFixed(0)} VND</td>
                    <td style="color: ${pl > 0 ? '#10b981' : '#ef4444'}">${pl > 0 ? '+' : ''}${pl.toFixed(2)}%</td>
                </tr>`;
            }
            html += '</tbody></table>';
            document.getElementById('tradeHistory').innerHTML = html;
        }

        async function calculateRisk() {
            const checkboxes = document.querySelectorAll('#riskStocks input[type="checkbox"]:checked');
            const selected = Array.from(checkboxes).map(cb => cb.value);

            if (selected.length < 1) {
                showAlert('Please select at least 1 stock');
                return;
            }

            document.getElementById('riskResults').style.display = 'block';

            // Mock risk metrics
            document.getElementById('var95').textContent = '-8.5%';
            document.getElementById('cvar95').textContent = '-12.3%';
            document.getElementById('avgBeta').textContent = '1.15';
            document.getElementById('volatility').textContent = '22.4%';

            renderRiskChart(selected);
        }

        function renderRiskChart(stocks) {
            const ctx = document.getElementById('riskChart');
            if (charts.risk) charts.risk.destroy();

            charts.risk = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: stocks,
                    datasets: [{
                        label: 'Beta',
                        data: stocks.map(() => 0.5 + Math.random() * 1.5),
                        backgroundColor: 'rgba(196, 28, 22, 0.6)',
                        borderColor: '#c41c16',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Beta by Stock'
                        }
                    }
                }
            });

            // Generate risk table
            let html = '<table><thead><tr><th data-i18n="table.stock">Stock</th><th data-i18n="table.beta">Beta</th><th data-i18n="table.volatility">Volatility</th><th data-i18n="table.var_95">VaR (95%)</th><th data-i18n="table.risk_grade">Risk Grade</th></tr></thead><tbody>';
            stocks.forEach(symbol => {
                const beta = (0.5 + Math.random() * 1.5).toFixed(2);
                const vol = (15 + Math.random() * 20).toFixed(1);
                const var_ = (5 + Math.random() * 10).toFixed(1);
                const grade = var_ < 8 ? 'Low' : var_ < 12 ? 'Medium' : 'High';
                const gradeColor = grade === 'Low' ? '#10b981' : grade === 'Medium' ? '#f59e0b' : '#ef4444';

                html += `<tr>
                    <td><strong>${symbol}</strong></td>
                    <td>${beta}</td>
                    <td>${vol}%</td>
                    <td>-${var_}%</td>
                    <td style="color: ${gradeColor}; font-weight: 600;">${grade}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('riskTable').innerHTML = html;
        }

        async function detectPatterns() {
            const stock = document.getElementById('patternStock').value;

            if (!stock) {
                showAlert('Please select a stock');
                return;
            }

            try {
                // Get historical data for the stock
                const historical = await DataAPI.getHistoricalData(stock);
                if (!historical || historical.length < 5) {
                    showAlert('Insufficient data for pattern detection');
                    return;
                }

                const prices = historical.map(h => h.close);
                const patterns = [];

                console.log(`Pattern Detection for ${stock}:`, {
                    dataPoints: prices.length,
                    minPrice: Math.min(...prices),
                    maxPrice: Math.max(...prices)
                });

                // 1. Detect support levels (local minima)
                for (let i = 2; i < prices.length - 2; i++) {
                    if (prices[i] < prices[i-1] && prices[i] < prices[i+1] &&
                        prices[i] < prices[i-2] && prices[i] < prices[i+2]) {
                        patterns.push({
                            name: `Support Level at ${formatPrice(prices[i])}`,
                            confidence: 75,
                            bullish: true,
                            type: 'support'
                        });
                        console.log(`âœ“ Support level detected at ${prices[i]}`);
                    }
                }

                // 2. Detect resistance levels (local maxima)
                for (let i = 2; i < prices.length - 2; i++) {
                    if (prices[i] > prices[i-1] && prices[i] > prices[i+1] &&
                        prices[i] > prices[i-2] && prices[i] > prices[i+2]) {
                        patterns.push({
                            name: `Resistance Level at ${formatPrice(prices[i])}`,
                            confidence: 75,
                            bullish: false,
                            type: 'resistance'
                        });
                        console.log(`âœ“ Resistance level detected at ${prices[i]}`);
                    }
                }

                // 3. Detect bullish engulfing
                for (let i = 1; i < prices.length; i++) {
                    const currClose = historical[i].close;
                    const currOpen = historical[i].open;
                    const prevClose = historical[i-1].close;

                    if (currOpen < prevClose && currClose > prevClose && currClose > prevClose * 1.01) {
                        patterns.push({
                            name: 'Bullish Engulfing',
                            confidence: 80,
                            bullish: true,
                            type: 'engulfing'
                        });
                        console.log(`âœ“ Bullish engulfing detected at index ${i}`);
                        break;
                    }
                }

                // 4. Detect uptrend/downtrend (3+ consecutive movements)
                let upTrendCount = 0;
                let downTrendCount = 0;
                for (let i = 1; i < prices.length; i++) {
                    if (prices[i] > prices[i-1]) {
                        upTrendCount++;
                        downTrendCount = 0;
                    } else {
                        downTrendCount++;
                        upTrendCount = 0;
                    }

                    if (upTrendCount >= 3 && !patterns.find(p => p.type === 'uptrend')) {
                        patterns.push({
                            name: `Uptrend (${upTrendCount}+ consecutive increases)`,
                            confidence: 70,
                            bullish: true,
                            type: 'uptrend'
                        });
                        console.log(`âœ“ Uptrend detected`);
                    }

                    if (downTrendCount >= 3 && !patterns.find(p => p.type === 'downtrend')) {
                        patterns.push({
                            name: `Downtrend (${downTrendCount}+ consecutive decreases)`,
                            confidence: 70,
                            bullish: false,
                            type: 'downtrend'
                        });
                        console.log(`âœ“ Downtrend detected`);
                    }
                }

                // 5. Detect volatility spike
                const returns = [];
                for (let i = 1; i < prices.length; i++) {
                    returns.push(Math.abs((prices[i] - prices[i-1]) / prices[i-1]));
                }
                const avgReturn = returns.reduce((a,b) => a+b) / returns.length;
                const recentReturn = returns[returns.length - 1];

                if (recentReturn > avgReturn * 2) {
                    patterns.push({
                        name: 'High Volatility Detected',
                        confidence: 65,
                        bullish: recentReturn > 0,
                        type: 'volatility'
                    });
                    console.log(`âœ“ Volatility spike detected`);
                }

                document.getElementById('patternResults').style.display = 'block';

                if (patterns.length === 0) {
                    document.getElementById('patternAlert').textContent =
                        `No clear patterns detected for ${stock}`;
                    document.getElementById('patternList').innerHTML =
                        '<p style="color: #64748b;">Data is stable. No significant patterns detected.</p>';
                } else {
                    document.getElementById('patternAlert').textContent =
                        `âœ“ Found ${patterns.length} pattern(s) for ${stock}`;

                    let html = '<div style="display: grid; gap: 15px;">';
                    patterns.forEach(p => {
                        html += `
                            <div style="background: ${p.bullish ? '#dcfce7' : '#fee2e2'};
                                        padding: 15px; border-radius: 8px;
                                        border-left: 4px solid ${p.bullish ? '#10b981' : '#ef4444'};">
                                <div style="display: flex; justify-content: space-between;">
                                    <strong>${p.bullish ? 'ğŸ“ˆ' : 'ğŸ“‰'} ${p.name}</strong>
                                    <span style="font-weight: 600;">Confidence: ${p.confidence}%</span>
                                </div>
                                <div style="margin-top: 5px; color: #64748b;">
                                    ${p.bullish ? 'Bullish' : 'Bearish'} signal
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    document.getElementById('patternList').innerHTML = html;
                }

            } catch (error) {
                console.error('Pattern detection error:', error);
                showAlert('Error detecting patterns. Please try again.');
            }
        }

        async function runMLForecast() {
            const stock = document.getElementById('mlStock').value;
            const horizon = document.getElementById('mlHorizon').value;

            if (!stock) {
                showAlert('Please select a stock');
                return;
            }

            document.getElementById('mlResults').style.display = 'block';

            // Mock ML results
            document.getElementById('mlAccuracy').textContent = '87.3%';
            document.getElementById('mlTrend').textContent = 'â†— Upward';
            document.getElementById('mlConfidence').textContent = '82%';

            renderMLChart(stock, horizon);
            renderFeatureImportance();
        }

        function renderMLChart(stock, horizon) {
            const ctx = document.getElementById('mlChart');
            if (charts.ml) charts.ml.destroy();

            // Generate mock data
            const historical = [];
            const forecast = [];
            let price = 50000;

            for (let i = 60; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                price *= (1 + (Math.random() - 0.5) * 0.02);
                historical.push({x: date, y: price});
            }

            for (let i = 1; i <= parseInt(horizon); i++) {
                const date = new Date();
                date.setDate(date.getDate() + i);
                price *= (1 + (Math.random() - 0.45) * 0.015);
                forecast.push({x: date, y: price});
            }

            charts.ml = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Historical',
                        data: historical,
                        borderColor: '#c41c16',
                        borderWidth: 2
                    }, {
                        label: 'LSTM Forecast',
                        data: forecast,
                        borderColor: '#10b981',
                        borderWidth: 2,
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'LSTM Neural Network Forecast'
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day' }
                        }
                    }
                }
            });
        }

        function renderFeatureImportance() {
            const ctx = document.getElementById('featureChart');
            if (charts.features) charts.features.destroy();

            const features = ['Price', 'Volume', 'RSI', 'MACD', 'MA20', 'MA50', 'Volatility'];
            const importance = features.map(() => Math.random() * 100);

            charts.features = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: features,
                    datasets: [{
                        label: 'Importance (%)',
                        data: importance,
                        backgroundColor: 'rgba(196, 28, 22, 0.6)',
                        borderColor: '#c41c16',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        title: {
                            display: true,
                            text: 'Feature Importance in ML Model'
                        }
                    }
                }
            });
        }

        async function analyzeCorrelation() {
            const checkboxes = document.querySelectorAll('#correlationStocks input[type="checkbox"]:checked');
            const selected = Array.from(checkboxes).map(cb => cb.value);

            if (selected.length < 3) {
                showAlert('Please select at least 3 stocks');
                return;
            }

            document.getElementById('correlationResults').style.display = 'block';

            // Generate correlation matrix
            const matrix = [];
            for (let i = 0; i < selected.length; i++) {
                matrix[i] = [];
                for (let j = 0; j < selected.length; j++) {
                    if (i === j) {
                        matrix[i][j] = 1;
                    } else if (i < j) {
                        matrix[i][j] = Math.random() * 2 - 1;
                    } else {
                        matrix[i][j] = matrix[j][i];
                    }
                }
            }

            // Render matrix table
            let html = '<table style="text-align: center;"><thead><tr><th></th>';
            selected.forEach(s => html += `<th>${s}</th>`);
            html += '</tr></thead><tbody>';

            selected.forEach((s, i) => {
                html += `<tr><th>${s}</th>`;
                matrix[i].forEach(corr => {
                    const color = corr > 0.7 ? '#10b981' : corr < -0.7 ? '#ef4444' : '#64748b';
                    html += `<td style="color: ${color}; font-weight: 600;">${corr.toFixed(2)}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            document.getElementById('correlationMatrix').innerHTML = html;

            // Render heatmap
            const heatmapCanvas = document.getElementById('correlationHeatmap');
            if (charts.correlationHeatmap) {
                charts.correlationHeatmap.destroy();
            }

            // Create heatmap data
            const heatmapData = {
                labels: selected,
                datasets: selected.map((stock, i) => ({
                    label: stock,
                    data: matrix[i].map((corr, j) => ({x: selected[j], y: stock, v: corr})),
                    backgroundColor: matrix[i].map(corr => {
                        // Color based on correlation strength
                        if (corr > 0.7) return 'rgba(16, 185, 129, 0.8)'; // Strong positive - green
                        if (corr > 0.3) return 'rgba(52, 211, 153, 0.6)'; // Moderate positive - light green
                        if (corr > -0.3) return 'rgba(203, 213, 225, 0.8)'; // Neutral - gray
                        if (corr > -0.7) return 'rgba(251, 146, 60, 0.6)'; // Moderate negative - orange
                        return 'rgba(239, 68, 68, 0.8)'; // Strong negative - red
                    }),
                    borderWidth: 1,
                    borderColor: '#fff'
                }))
            };

            charts.correlationHeatmap = new Chart(heatmapCanvas, {
                type: 'scatter',
                data: {
                    datasets: selected.flatMap((stock, i) =>
                        matrix[i].map((corr, j) => ({
                            label: `${stock}-${selected[j]}`,
                            data: [{x: j, y: i}],
                            backgroundColor: (() => {
                                if (corr > 0.7) return 'rgba(16, 185, 129, 0.9)';
                                if (corr > 0.3) return 'rgba(52, 211, 153, 0.7)';
                                if (corr > -0.3) return 'rgba(148, 163, 184, 0.7)';
                                if (corr > -0.7) return 'rgba(251, 146, 60, 0.7)';
                                return 'rgba(239, 68, 68, 0.9)';
                            })(),
                            pointRadius: 25,
                            pointHoverRadius: 30
                        }))
                    )
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false},
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const i = context.parsed.y;
                                    const j = context.parsed.x;
                                    return `${selected[i]} vs ${selected[j]}: ${matrix[i][j].toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            min: -0.5,
                            max: selected.length - 0.5,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return selected[Math.round(value)] || '';
                                }
                            },
                            grid: {display: false}
                        },
                        y: {
                            type: 'linear',
                            min: -0.5,
                            max: selected.length - 0.5,
                            reverse: true,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return selected[Math.round(value)] || '';
                                }
                            },
                            grid: {display: false}
                        }
                    }
                }
            });

            // Find pair trading opportunities
            let pairHtml = '<div style="display: grid; gap: 15px;">';
            for (let i = 0; i < selected.length; i++) {
                for (let j = i + 1; j < selected.length; j++) {
                    if (Math.abs(matrix[i][j]) > 0.7) {
                        const type = matrix[i][j] > 0 ? 'Highly Correlated' : 'Negatively Correlated';
                        pairHtml += `
                            <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                <strong>${selected[i]} & ${selected[j]}</strong>
                                <div style="margin-top: 5px; color: #64748b;">
                                    ${type} (${matrix[i][j].toFixed(2)})
                                </div>
                            </div>
                        `;
                    }
                }
            }
            pairHtml += '</div>';
            document.getElementById('pairTrading').innerHTML = pairHtml;
        }

        // Margin Management Functions
        function calculateMargin() {
            const cashEquity = parseFloat(document.getElementById('cashEquity').value) || 0;
            const borrowedAmount = parseFloat(document.getElementById('borrowedAmount').value) || 0;
            const marginRatio = parseFloat(document.getElementById('marginRatio').value) || 50;
            const interestRate = parseFloat(document.getElementById('interestRate').value) || 10;

            if (cashEquity === 0) {
                document.getElementById('marginOverview').style.display = 'none';
                return;
            }

            // Calculate portfolio metrics
            const totalPortfolioValue = cashEquity + borrowedAmount;
            const currentMarginRatioValue = (cashEquity / totalPortfolioValue) * 100;

            // Calculate buying power (how much you can invest)
            // With 50% margin, you can buy 2x your equity
            const maxBorrowable = (cashEquity / (marginRatio / 100)) - cashEquity;
            const buyingPower = cashEquity + maxBorrowable;

            // Calculate interest costs
            const yearlyInterestCost = borrowedAmount * (interestRate / 100);
            const dailyCost = yearlyInterestCost / 365;
            const weeklyCost = dailyCost * 7;
            const monthlyCost = yearlyInterestCost / 12;

            // Calculate margin requirements
            const initialMarginRequired = totalPortfolioValue * (marginRatio / 100);
            const maintenanceMarginRatio = Math.max(25, marginRatio - 10); // Typically 10% lower than initial
            const maintenanceMargin = totalPortfolioValue * (maintenanceMarginRatio / 100);
            const excessMargin = cashEquity - maintenanceMargin;

            // Calculate leverage
            const currentLeverage = totalPortfolioValue / cashEquity;
            const maxLeverage = 1 / (marginRatio / 100);

            // Format and display results
            document.getElementById('totalPortfolioValue').textContent = formatCurrency(totalPortfolioValue);
            document.getElementById('buyingPower').textContent = formatCurrency(buyingPower);
            document.getElementById('currentMarginRatio').textContent = currentMarginRatioValue.toFixed(2) + '%';
            document.getElementById('dailyInterest').textContent = formatCurrency(dailyCost);

            document.getElementById('dailyCost').textContent = formatCurrency(dailyCost);
            document.getElementById('weeklyCost').textContent = formatCurrency(weeklyCost);
            document.getElementById('monthlyCost').textContent = formatCurrency(monthlyCost);
            document.getElementById('yearlyCost').textContent = formatCurrency(yearlyInterestCost);

            document.getElementById('initialMargin').textContent = formatCurrency(initialMarginRequired);
            document.getElementById('maintenanceMargin').textContent = formatCurrency(maintenanceMargin);
            document.getElementById('excessMargin').textContent = formatCurrency(excessMargin);

            document.getElementById('currentLeverage').textContent = currentLeverage.toFixed(2) + 'x';
            document.getElementById('maxLeverage').textContent = maxLeverage.toFixed(2) + 'x';

            // Update leverage bar
            const leveragePercent = Math.min((currentLeverage / 3) * 100, 100); // Cap at 3x
            document.getElementById('leverageBar').style.width = leveragePercent + '%';

            // Determine risk level
            let riskLevel = 'Low';
            let riskColor = '#10b981';
            if (currentLeverage >= 2.5) {
                riskLevel = 'Very High';
                riskColor = '#dc2626';
            } else if (currentLeverage >= 2) {
                riskLevel = 'High';
                riskColor = '#ef4444';
            } else if (currentLeverage >= 1.5) {
                riskLevel = 'Moderate';
                riskColor = '#f59e0b';
            } else if (currentLeverage >= 1.2) {
                riskLevel = 'Medium';
                riskColor = '#3b82f6';
            }

            const riskLevelElement = document.getElementById('riskLevel');
            riskLevelElement.textContent = riskLevel;
            riskLevelElement.style.color = riskColor;

            // Check for margin call
            const marginCallWarning = document.getElementById('marginCallWarning');
            const marginStatusGood = document.getElementById('marginStatusGood');

            if (currentMarginRatioValue < marginRatio) {
                marginCallWarning.style.display = 'block';
                marginStatusGood.style.display = 'none';

                const shortfall = initialMarginRequired - cashEquity;
                const needToSell = shortfall / (currentMarginRatioValue / 100);

                document.getElementById('marginCallDetails').innerHTML = `
                    <strong>Required Action:</strong> Your current margin ratio (${currentMarginRatioValue.toFixed(2)}%) is below the required ${marginRatio}%.<br>
                    You need to either: <strong>Add ${formatCurrency(shortfall)}</strong> in cash, OR <strong>Sell ${formatCurrency(needToSell)}</strong> worth of positions.
                `;
            } else {
                marginCallWarning.style.display = 'none';
                marginStatusGood.style.display = 'block';

                const buffer = currentMarginRatioValue - marginRatio;
                const maxLossBeforeCall = (buffer / 100) * totalPortfolioValue;

                document.getElementById('marginStatusDetails').innerHTML = `
                    You have a <strong>${buffer.toFixed(2)}%</strong> buffer above the required margin.
                    Your portfolio can decrease by up to <strong>${formatCurrency(maxLossBeforeCall)}</strong> before triggering a margin call.
                `;
            }

            // Show the overview section
            document.getElementById('marginOverview').style.display = 'block';
        }

        function formatCurrency(value) {
            if (value >= 1000000000) {
                return 'â‚«' + (value / 1000000000).toFixed(2) + 'B';
            } else if (value >= 1000000) {
                return 'â‚«' + (value / 1000000).toFixed(2) + 'M';
            } else if (value >= 1000) {
                return 'â‚«' + (value / 1000).toFixed(2) + 'K';
            } else {
                return 'â‚«' + value.toFixed(0);
            }
        }

        // Initialize after DOM is fully loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('DOM loaded, stock-categories status:', window.categoriesLoaded);
                // Give more time for categories to load
                setTimeout(init, 200);
            });
        } else {
            // DOM already loaded, wait a bit for stock-categories.js to initialize
            console.log('DOM already loaded, stock-categories status:', window.categoriesLoaded);
            setTimeout(init, 200);
        }
    </script>
    <script>
        function toggleMenu() {
            const menu = document.getElementById('dropdownMenu');
            const arrow = document.getElementById('menuArrow');
            menu.classList.toggle('active');
            arrow.textContent = menu.classList.contains('active') ? 'â–²' : 'â–¼';
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('dropdownMenu');
            const menuBtn = event.target.closest('.menu-btn');
            if (!menuBtn && !event.target.closest('.dropdown-menu')) {
                menu.classList.remove('active');
                const arrow = document.getElementById('menuArrow');
                if (arrow) arrow.textContent = 'â–¼';
            }
        });

        // Report Generation Functions
        async function generateReport() {
            console.log('ğŸ” Generate Report clicked');
            console.log('Portfolio analyzed?', portfolioAnalysisResults.analyzed);
            console.log('Full results:', portfolioAnalysisResults);

            // Check if portfolio analysis has been run
            if (!portfolioAnalysisResults || !portfolioAnalysisResults.analyzed) {
                console.warn('âš ï¸ No portfolio analysis data found');
                showAlert('âš ï¸ No Portfolio Data Available!\n\nPlease follow these steps:\n\n1. Go to "Portfolio Analytics" tab\n2. Select stocks from your portfolio\n3. Click "Analyze Portfolio" button\n4. Return to this tab to generate report');
                return;
            }

            console.log('âœ“ Portfolio data available, generating report...');

            const reportType = document.getElementById('reportType').value;
            const reportPeriod = document.getElementById('reportPeriod').value;
            const includeCharts = document.getElementById('includeCharts').checked;
            const includeRecommendations = document.getElementById('includeRecommendations').checked;

            console.log('Generating report:', { reportType, reportPeriod, includeCharts, includeRecommendations });
            console.log('Using portfolio data from:', portfolioAnalysisResults.timestamp);

            // Show loading state
            const reportPreview = document.getElementById('reportPreview');
            const reportContent = document.getElementById('reportContent');
            reportPreview.style.display = 'block';
            reportContent.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p>Generating report...</p></div>';

            // Generate report with real data
            setTimeout(() => {
                const reportHtml = buildReportHTML(reportType, reportPeriod, includeCharts, includeRecommendations);
                reportContent.innerHTML = reportHtml;
            }, 500);
        }

        function buildReportHTML(type, period, charts, recommendations) {
            // Use real data from portfolio analysis
            const data = portfolioAnalysisResults;

            console.log('ğŸ“„ Building report with strategy:', {
                strategy: data.strategy,
                strategyName: data.strategyName
            });

            const date = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const periodText = {
                '1m': 'Last 1 Month',
                '3m': 'Last 3 Months',
                '6m': 'Last 6 Months',
                '1y': 'Last 1 Year',
                'ytd': 'Year to Date'
            }[period];

            const typeText = {
                'summary': 'Summary Report',
                'detailed': 'Detailed Analysis',
                'performance': 'Performance Report',
                'risk': 'Risk Assessment'
            }[type];

            let html = `
                <div style="border-bottom: 2px solid #3b82f6; padding-bottom: 20px; margin-bottom: 30px;">
                    <h1 style="color: #1e40af; margin: 0; font-size: 2em;">ğŸ“„ Portfolio ${typeText}</h1>
                    <p style="color: #64748b; margin: 10px 0 0 0;">Generated on ${date} | Period: ${periodText}</p>
                    ${data.strategyName ? `<p style="color: #8b5cf6; margin: 5px 0 0 0; font-weight: 600;">Strategy: ${data.strategyName}</p>` : ''}
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 0.9em; opacity: 0.9;">Total Portfolio Value</div>
                        <div style="font-size: 2em; font-weight: bold; margin-top: 10px;">${formatCurrency(data.portfolioValue)}</div>
                        <div style="font-size: 0.85em; margin-top: 5px;">${data.totalReturn >= 0 ? 'â†‘' : 'â†“'} ${data.totalReturn > 0 ? '+' : ''}${data.totalReturn.toFixed(1)}% vs previous period</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 0.9em; opacity: 0.9;">Total Return</div>
                        <div style="font-size: 2em; font-weight: bold; margin-top: 10px;">${data.totalReturn > 0 ? '+' : ''}${data.totalReturn.toFixed(1)}%</div>
                        <div style="font-size: 0.85em; margin-top: 5px;">Annual: ${(data.totalReturn * 1.5).toFixed(1)}%</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 0.9em; opacity: 0.9;">Risk Level</div>
                        <div style="font-size: 2em; font-weight: bold; margin-top: 10px;">${data.riskLevel.toFixed(1)}%</div>
                        <div style="font-size: 0.85em; margin-top: 5px;">${data.riskLevel < 15 ? 'Low Risk' : data.riskLevel < 25 ? 'Moderate Risk' : 'High Risk'}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 0.9em; opacity: 0.9;">Sharpe Ratio</div>
                        <div style="font-size: 2em; font-weight: bold; margin-top: 10px;">${data.sharpeRatio.toFixed(2)}</div>
                        <div style="font-size: 0.85em; margin-top: 5px;">${data.sharpeRatio > 0.8 ? 'Excellent' : data.sharpeRatio > 0.5 ? 'Good' : 'Fair'} risk-adjusted return</div>
                    </div>
                </div>

                <div style="margin-bottom: 30px;">
                    <h2 style="color: #1e40af; margin-bottom: 15px;">ğŸ“Š Portfolio Holdings</h2>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f1f5f9; border-bottom: 2px solid #cbd5e1;">
                                <th style="padding: 12px; text-align: left;">Symbol</th>
                                <th style="padding: 12px; text-align: right;">Shares</th>
                                <th style="padding: 12px; text-align: right;">Price</th>
                                <th style="padding: 12px; text-align: right;">Value</th>
                                <th style="padding: 12px; text-align: right;">Weight</th>
                                <th style="padding: 12px; text-align: right;">Return</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${generateHoldingsRows()}
                        </tbody>
                    </table>
                </div>

                <div style="margin-bottom: 30px;">
                    <h2 style="color: #1e40af; margin-bottom: 15px;">ğŸ“ˆ Performance Analysis</h2>
                    <div style="background: #f8fafc; padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <p style="margin: 0 0 10px 0;"><strong>Best Performer:</strong> ${data.performance.bestPerformer || 'N/A'}</p>
                        <p style="margin: 0 0 10px 0;"><strong>Worst Performer:</strong> ${data.performance.worstPerformer || 'N/A'}</p>
                        <p style="margin: 0 0 10px 0;"><strong>Most Volatile:</strong> ${data.performance.mostVolatile || 'N/A'}</p>
                        <p style="margin: 0;"><strong>Most Stable:</strong> ${data.performance.mostStable || 'N/A'}</p>
                    </div>
                </div>

                <div style="margin-bottom: 30px;">
                    <h2 style="color: #1e40af; margin-bottom: 15px;">ğŸ¯ Sector Allocation</h2>
                    <div style="display: grid; gap: 10px;">
                        ${generateSectorBars()}
                    </div>
                </div>
            `;

            if (recommendations) {
                html += `
                    <div style="margin-bottom: 30px;">
                        <h2 style="color: #1e40af; margin-bottom: 15px;">ğŸ’¡ AI Recommendations</h2>
                        <div style="background: #dbeafe; border-left: 4px solid #3b82f6; padding: 20px; border-radius: 8px;">
                            <p style="margin: 0 0 15px 0;"><strong>âœ“ Strengths:</strong></p>
                            <ul style="margin: 0 0 15px 20px;">
                                <li>Well-diversified across sectors</li>
                                <li>Good balance of growth and stability stocks</li>
                                <li>Strong risk-adjusted returns (Sharpe ratio > 0.8)</li>
                            </ul>
                            <p style="margin: 0 0 15px 0;"><strong>âš ï¸ Areas for Improvement:</strong></p>
                            <ul style="margin: 0 0 15px 20px;">
                                <li>Consider reducing concentration in Banking sector (currently 35%)</li>
                                <li>Add more defensive stocks to reduce portfolio volatility</li>
                                <li>Increase exposure to Technology sector for growth potential</li>
                            </ul>
                            <p style="margin: 0 0 10px 0;"><strong>ğŸ¯ Suggested Actions:</strong></p>
                            <ul style="margin: 0 0 0 20px;">
                                <li>Rebalance: Reduce VCB by 2%, increase FPT by 2%</li>
                                <li>Add: Consider VNM or MSN for stability</li>
                                <li>Monitor: Watch HPG performance closely</li>
                            </ul>
                        </div>
                    </div>
                `;
            }

            html += `
                <div style="border-top: 2px solid #e2e8f0; padding-top: 20px; margin-top: 30px; text-align: center; color: #64748b; font-size: 0.9em;">
                    <p>This report is for informational purposes only and does not constitute financial advice.</p>
                    <p style="margin-top: 5px;">Â© ${new Date().getFullYear()} VNStock Analytics - All rights reserved</p>
                </div>
            `;

            return html;
        }

        function generateHoldingsRows() {
            // Use real holdings data from portfolio analysis
            const holdings = portfolioAnalysisResults.holdings || [];

            return holdings.map(h => `
                <tr style="border-bottom: 1px solid #e2e8f0;">
                    <td style="padding: 12px;"><strong>${h.symbol}</strong></td>
                    <td style="padding: 12px; text-align: right;">${h.shares}</td>
                    <td style="padding: 12px; text-align: right;">${formatCurrency(h.price)}</td>
                    <td style="padding: 12px; text-align: right;">${formatCurrency(h.value)}</td>
                    <td style="padding: 12px; text-align: right;">${h.weight.toFixed(1)}%</td>
                    <td style="padding: 12px; text-align: right; color: ${h.return >= 0 ? '#10b981' : '#ef4444'}; font-weight: bold;">
                        ${h.return >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(h.return).toFixed(1)}%
                    </td>
                </tr>
            `).join('');
        }

        function generateSectorBars() {
            // Use real sector data from portfolio analysis
            const sectors = Object.entries(portfolioAnalysisResults.sectors || {}).map(([name, percentage]) => ({
                name,
                percentage
            }));

            return sectors.map(s => `
                <div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 500;">${s.name}</span>
                        <span style="color: #64748b;">${s.percentage}%</span>
                    </div>
                    <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #3b82f6, #8b5cf6); height: 100%; width: ${s.percentage}%;"></div>
                    </div>
                </div>
            `).join('');
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0
            }).format(value);
        }

        function buildSimplifiedPDFContent(type, period, recommendations) {
            // Use real portfolio data
            const data = portfolioAnalysisResults;

            const date = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const periodText = {
                '1m': 'Last 1 Month', '3m': 'Last 3 Months', '6m': 'Last 6 Months',
                '1y': 'Last 1 Year', 'ytd': 'Year to Date'
            }[period];
            const typeText = {
                'summary': 'Summary Report', 'detailed': 'Detailed Analysis',
                'performance': 'Performance Report', 'risk': 'Risk Assessment'
            }[type];

            return `
<div style="width: 750px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif; font-size: 11px; line-height: 1.4;">
    <!-- Header -->
    <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 20px; border-bottom: 3px solid #1e40af;">
        <tr>
            <td style="padding-bottom: 10px;">
                <h1 style="margin: 0; color: #1e40af; font-size: 22px;">Portfolio ${typeText}</h1>
                <p style="margin: 5px 0 0 0; color: #64748b; font-size: 10px;">${date} | ${periodText}</p>
            </td>
        </tr>
    </table>

    <!-- Key Metrics -->
    <h2 style="color: #1e40af; font-size: 14px; margin: 15px 0 10px 0;">Key Performance Metrics</h2>
    <table width="100%" cellpadding="8" cellspacing="0" style="margin-bottom: 20px; border: 1px solid #cbd5e1;">
        <tr style="background: #f8fafc;">
            <td width="33%" style="border: 1px solid #cbd5e1; padding: 8px;">
                <strong style="color: #64748b; font-size: 9px;">PORTFOLIO VALUE</strong><br>
                <span style="font-size: 16px; font-weight: bold; color: #1e40af;">â‚«1,250,000</span><br>
                <span style="font-size: 9px; color: #10b981;">â†‘ +12.5%</span>
            </td>
            <td width="33%" style="border: 1px solid #cbd5e1; padding: 8px;">
                <strong style="color: #64748b; font-size: 9px;">TOTAL RETURN</strong><br>
                <span style="font-size: 16px; font-weight: bold; color: #10b981;">+15.8%</span><br>
                <span style="font-size: 9px; color: #64748b;">Annual: +23.4%</span>
            </td>
            <td width="33%" style="border: 1px solid #cbd5e1; padding: 8px;">
                <strong style="color: #64748b; font-size: 9px;">SHARPE RATIO</strong><br>
                <span style="font-size: 16px; font-weight: bold; color: #1e40af;">0.86</span><br>
                <span style="font-size: 9px; color: #64748b;">Good performance</span>
            </td>
        </tr>
        <tr style="background: #ffffff;">
            <td style="border: 1px solid #cbd5e1; padding: 8px;">
                <strong style="color: #64748b; font-size: 9px;">RISK LEVEL</strong><br>
                <span style="font-size: 14px; font-weight: bold; color: #475569;">18.3%</span><br>
                <span style="font-size: 9px; color: #64748b;">Moderate</span>
            </td>
            <td style="border: 1px solid #cbd5e1; padding: 8px;">
                <strong style="color: #64748b; font-size: 9px;">MAX DRAWDOWN</strong><br>
                <span style="font-size: 14px; font-weight: bold; color: #ef4444;">-12.5%</span><br>
                <span style="font-size: 9px; color: #64748b;">Peak to trough</span>
            </td>
            <td style="border: 1px solid #cbd5e1; padding: 8px;">
                <strong style="color: #64748b; font-size: 9px;">DIVERSIFICATION</strong><br>
                <span style="font-size: 14px; font-weight: bold; color: #10b981;">85%</span><br>
                <span style="font-size: 9px; color: #64748b;">Well diversified</span>
            </td>
        </tr>
    </table>

    <!-- Holdings -->
    <h2 style="color: #1e40af; font-size: 14px; margin: 15px 0 10px 0;">Portfolio Holdings</h2>
    <table width="100%" cellpadding="6" cellspacing="0" style="margin-bottom: 20px; border-collapse: collapse;">
        <thead>
            <tr style="background: #1e40af; color: white;">
                <th style="border: 1px solid #1e40af; padding: 6px; text-align: left; font-size: 10px;">Symbol</th>
                <th style="border: 1px solid #1e40af; padding: 6px; text-align: right; font-size: 10px;">Shares</th>
                <th style="border: 1px solid #1e40af; padding: 6px; text-align: right; font-size: 10px;">Price</th>
                <th style="border: 1px solid #1e40af; padding: 6px; text-align: right; font-size: 10px;">Value</th>
                <th style="border: 1px solid #1e40af; padding: 6px; text-align: right; font-size: 10px;">Weight</th>
                <th style="border: 1px solid #1e40af; padding: 6px; text-align: right; font-size: 10px;">Return</th>
            </tr>
        </thead>
        <tbody>
            <tr style="background: #f8fafc;">
                <td style="border: 1px solid #cbd5e1; padding: 6px;"><strong>VCB</strong></td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;">100</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;">â‚«95,000</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;">â‚«9,500,000</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;">24.5%</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right; color: #10b981;"><strong>+24.5%</strong></td>
            </tr>
            <tr>
                <td style="border: 1px solid #cbd5e1; padding: 6px;"><strong>FPT</strong></td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;">150</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;">â‚«78,000</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;">â‚«11,700,000</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;">30.2%</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right; color: #10b981;"><strong>+18.7%</strong></td>
            </tr>
            <tr style="background: #f8fafc;">
                <td style="border: 1px solid #cbd5e1; padding: 6px;"><strong>VNM</strong></td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;">80</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;">â‚«82,000</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;">â‚«6,560,000</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;">16.9%</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right; color: #10b981;"><strong>+8.2%</strong></td>
            </tr>
            <tr>
                <td style="border: 1px solid #cbd5e1; padding: 6px;"><strong>HPG</strong></td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;">200</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;">â‚«28,000</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;">â‚«5,600,000</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;">14.4%</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right; color: #ef4444;"><strong>-3.2%</strong></td>
            </tr>
            <tr style="background: #f8fafc;">
                <td style="border: 1px solid #cbd5e1; padding: 6px;"><strong>TCB</strong></td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;">120</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;">â‚«45,000</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;">â‚«5,400,000</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;">14.0%</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right; color: #10b981;"><strong>+12.1%</strong></td>
            </tr>
            <tr style="background: #dbeafe; font-weight: bold;">
                <td colspan="3" style="border: 2px solid #3b82f6; padding: 6px;"><strong>TOTAL</strong></td>
                <td style="border: 2px solid #3b82f6; padding: 6px; text-align: right;"><strong>â‚«38,760,000</strong></td>
                <td style="border: 2px solid #3b82f6; padding: 6px; text-align: right;"><strong>100%</strong></td>
                <td style="border: 2px solid #3b82f6; padding: 6px; text-align: right; color: #10b981;"><strong>+15.8%</strong></td>
            </tr>
        </tbody>
    </table>

    <!-- Sector Allocation -->
    <h2 style="color: #1e40af; font-size: 14px; margin: 15px 0 10px 0;">Sector Allocation</h2>
    <table width="100%" cellpadding="6" cellspacing="0" style="margin-bottom: 20px;">
        <tr style="background: #f8fafc;">
            <td width="40%" style="border: 1px solid #cbd5e1; padding: 6px;"><strong>Banking</strong></td>
            <td width="15%" style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;"><strong>35%</strong></td>
            <td width="45%" style="border: 1px solid #cbd5e1; padding: 6px;">
                <div style="background: #3b82f6; height: 12px; width: 70%;"></div>
            </td>
        </tr>
        <tr>
            <td style="border: 1px solid #cbd5e1; padding: 6px;"><strong>Technology</strong></td>
            <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;"><strong>25%</strong></td>
            <td style="border: 1px solid #cbd5e1; padding: 6px;">
                <div style="background: #8b5cf6; height: 12px; width: 50%;"></div>
            </td>
        </tr>
        <tr style="background: #f8fafc;">
            <td style="border: 1px solid #cbd5e1; padding: 6px;"><strong>Consumer Goods</strong></td>
            <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;"><strong>20%</strong></td>
            <td style="border: 1px solid #cbd5e1; padding: 6px;">
                <div style="background: #10b981; height: 12px; width: 40%;"></div>
            </td>
        </tr>
        <tr>
            <td style="border: 1px solid #cbd5e1; padding: 6px;"><strong>Industrial</strong></td>
            <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;"><strong>15%</strong></td>
            <td style="border: 1px solid #cbd5e1; padding: 6px;">
                <div style="background: #f59e0b; height: 12px; width: 30%;"></div>
            </td>
        </tr>
        <tr style="background: #f8fafc;">
            <td style="border: 1px solid #cbd5e1; padding: 6px;"><strong>Others</strong></td>
            <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: right;"><strong>5%</strong></td>
            <td style="border: 1px solid #cbd5e1; padding: 6px;">
                <div style="background: #64748b; height: 12px; width: 10%;"></div>
            </td>
        </tr>
    </table>

    <!-- Performance Analysis -->
    <h2 style="color: #1e40af; font-size: 14px; margin: 15px 0 10px 0;">Performance Analysis</h2>
    <table width="100%" cellpadding="8" cellspacing="0" style="margin-bottom: 20px; background: #f8fafc; border-left: 4px solid #3b82f6;">
        <tr>
            <td style="padding: 8px;">
                <p style="margin: 0 0 6px 0;"><strong>Best Performer:</strong> VCB (+24.5%)</p>
                <p style="margin: 0 0 6px 0;"><strong>Worst Performer:</strong> HPG (-3.2%)</p>
                <p style="margin: 0 0 6px 0;"><strong>Most Volatile:</strong> FPT (Ïƒ = 28.4%)</p>
                <p style="margin: 0;"><strong>Most Stable:</strong> VNM (Ïƒ = 12.1%)</p>
            </td>
        </tr>
    </table>

    ${recommendations ? `
    <!-- Recommendations -->
    <h2 style="color: #1e40af; font-size: 14px; margin: 20px 0 10px 0;">AI Recommendations</h2>

    <table width="100%" cellpadding="8" cellspacing="0" style="margin-bottom: 15px; background: #dbeafe; border-left: 4px solid #3b82f6;">
        <tr>
            <td style="padding: 8px;">
                <p style="margin: 0 0 8px 0; font-weight: bold; color: #1e40af;">Portfolio Strengths</p>
                <p style="margin: 0 0 4px 0; font-size: 10px;">â€¢ Well-diversified across 5 major sectors</p>
                <p style="margin: 0 0 4px 0; font-size: 10px;">â€¢ Good balance of growth and stability stocks</p>
                <p style="margin: 0 0 4px 0; font-size: 10px;">â€¢ Strong risk-adjusted returns (Sharpe > 0.8)</p>
                <p style="margin: 0; font-size: 10px;">â€¢ Low correlation between major holdings</p>
            </td>
        </tr>
    </table>

    <table width="100%" cellpadding="8" cellspacing="0" style="margin-bottom: 15px; background: #fef3c7; border-left: 4px solid #f59e0b;">
        <tr>
            <td style="padding: 8px;">
                <p style="margin: 0 0 8px 0; font-weight: bold; color: #92400e;">Areas for Improvement</p>
                <p style="margin: 0 0 4px 0; font-size: 10px;">â€¢ Banking concentration at 35% (recommended max: 30%)</p>
                <p style="margin: 0 0 4px 0; font-size: 10px;">â€¢ Portfolio volatility 18.3% above target (15%)</p>
                <p style="margin: 0 0 4px 0; font-size: 10px;">â€¢ Limited defensive sector exposure</p>
                <p style="margin: 0; font-size: 10px;">â€¢ HPG underperforming - review position size</p>
            </td>
        </tr>
    </table>

    <h3 style="color: #1e40af; font-size: 12px; margin: 15px 0 8px 0;">Recommended Actions</h3>
    <table width="100%" cellpadding="6" cellspacing="0" style="margin-bottom: 15px;">
        <thead>
            <tr style="background: #059669; color: white;">
                <th style="border: 1px solid #059669; padding: 6px; text-align: left; font-size: 10px;">Action</th>
                <th style="border: 1px solid #059669; padding: 6px; text-align: left; font-size: 10px;">Details</th>
                <th style="border: 1px solid #059669; padding: 6px; text-align: center; font-size: 10px;">Priority</th>
            </tr>
        </thead>
        <tbody>
            <tr style="background: #f8fafc;">
                <td style="border: 1px solid #cbd5e1; padding: 6px; font-size: 10px;"><strong>Rebalance</strong></td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; font-size: 10px;">Reduce VCB by 2%, increase FPT by 2%</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: center; font-size: 10px; color: #ef4444;"><strong>High</strong></td>
            </tr>
            <tr>
                <td style="border: 1px solid #cbd5e1; padding: 6px; font-size: 10px;"><strong>Diversify</strong></td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; font-size: 10px;">Add VNM or MSN for stability</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: center; font-size: 10px; color: #f59e0b;"><strong>Medium</strong></td>
            </tr>
            <tr style="background: #f8fafc;">
                <td style="border: 1px solid #cbd5e1; padding: 6px; font-size: 10px;"><strong>Monitor</strong></td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; font-size: 10px;">Watch HPG performance, set stop-loss at -5%</td>
                <td style="border: 1px solid #cbd5e1; padding: 6px; text-align: center; font-size: 10px; color: #f59e0b;"><strong>Medium</strong></td>
            </tr>
        </tbody>
    </table>
    ` : ''}

    <!-- Footer -->
    <table width="100%" cellpadding="8" cellspacing="0" style="margin-top: 25px; border-top: 2px solid #e2e8f0;">
        <tr>
            <td style="padding-top: 10px; text-align: center; color: #64748b; font-size: 9px;">
                <p style="margin: 0 0 3px 0;">This report is for informational purposes only and does not constitute financial advice.</p>
                <p style="margin: 0;">Â© ${new Date().getFullYear()} VNStock Analytics - All rights reserved</p>
            </td>
        </tr>
    </table>
</div>`;
        }

        function buildPDFOptimizedHTML(type, period, recommendations) {
            const date = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const periodText = {
                '1m': 'Last 1 Month',
                '3m': 'Last 3 Months',
                '6m': 'Last 6 Months',
                '1y': 'Last 1 Year',
                'ytd': 'Year to Date'
            }[period];

            const typeText = {
                'summary': 'Summary Report',
                'detailed': 'Detailed Analysis',
                'performance': 'Performance Report',
                'risk': 'Risk Assessment'
            }[type];

            // PDF-optimized styling (no gradients, simple colors)
            const html = `
                <div style="font-family: Arial, sans-serif; padding: 20px; color: #333;">
                    <!-- Header -->
                    <div style="border-bottom: 3px solid #3b82f6; padding-bottom: 15px; margin-bottom: 25px;">
                        <h1 style="color: #1e40af; margin: 0; font-size: 24px;">ğŸ“„ Portfolio ${typeText}</h1>
                        <p style="color: #64748b; margin: 8px 0 0 0; font-size: 12px;">Generated on ${date} | Period: ${periodText}</p>
                    </div>

                    <!-- Key Metrics Grid -->
                    <div style="margin-bottom: 25px;">
                        <h2 style="color: #1e40af; font-size: 18px; margin-bottom: 15px;">ğŸ“Š Key Metrics</h2>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr>
                                <td style="width: 50%; padding: 15px; background: #eff6ff; border: 2px solid #3b82f6; vertical-align: top;">
                                    <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">Total Portfolio Value</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #1e40af;">${formatCurrency(1250000)}</div>
                                    <div style="font-size: 10px; color: #10b981; margin-top: 3px;">â†‘ +12.5% vs previous period</div>
                                </td>
                                <td style="width: 50%; padding: 15px; background: #fef2f2; border: 2px solid #ef4444; vertical-align: top;">
                                    <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">Total Return</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #dc2626;">+15.8%</div>
                                    <div style="font-size: 10px; color: #64748b; margin-top: 3px;">Annual: +23.4%</div>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 15px; background: #f0fdf4; border: 2px solid #10b981; vertical-align: top;">
                                    <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">Risk Level</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #059669;">18.3%</div>
                                    <div style="font-size: 10px; color: #64748b; margin-top: 3px;">Moderate Risk</div>
                                </td>
                                <td style="padding: 15px; background: #fefce8; border: 2px solid #eab308; vertical-align: top;">
                                    <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">Sharpe Ratio</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #ca8a04;">0.86</div>
                                    <div style="font-size: 10px; color: #64748b; margin-top: 3px;">Good risk-adjusted return</div>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 15px; background: #f8fafc; border: 2px solid #cbd5e1; vertical-align: top;">
                                    <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">Max Drawdown</div>
                                    <div style="font-size: 18px; font-weight: bold; color: #475569;">-12.5%</div>
                                </td>
                                <td style="padding: 15px; background: #f8fafc; border: 2px solid #cbd5e1; vertical-align: top;">
                                    <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">Diversification Score</div>
                                    <div style="font-size: 18px; font-weight: bold; color: #475569;">85%</div>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- Page Break -->
                    <div style="page-break-after: always;"></div>

                    <!-- Holdings Table -->
                    <div style="margin-bottom: 25px;">
                        <h2 style="color: #1e40af; font-size: 18px; margin-bottom: 15px;">ğŸ’¼ Portfolio Holdings</h2>
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <thead>
                                <tr style="background: #1e40af; color: white;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #cbd5e1;">Symbol</th>
                                    <th style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">Shares</th>
                                    <th style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">Price</th>
                                    <th style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">Value</th>
                                    <th style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">Weight</th>
                                    <th style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">Return</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: #f8fafc;">
                                    <td style="padding: 10px; border: 1px solid #cbd5e1;"><strong>VCB</strong></td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">100</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">95,000</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">9,500,000</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">24.5%</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1; color: #10b981; font-weight: bold;">â†‘ 24.5%</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #cbd5e1;"><strong>FPT</strong></td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">150</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">78,000</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">11,700,000</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">30.2%</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1; color: #10b981; font-weight: bold;">â†‘ 18.7%</td>
                                </tr>
                                <tr style="background: #f8fafc;">
                                    <td style="padding: 10px; border: 1px solid #cbd5e1;"><strong>VNM</strong></td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">80</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">82,000</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">6,560,000</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">16.9%</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1; color: #10b981; font-weight: bold;">â†‘ 8.2%</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #cbd5e1;"><strong>HPG</strong></td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">200</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">28,000</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">5,600,000</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">14.4%</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1; color: #ef4444; font-weight: bold;">â†“ 3.2%</td>
                                </tr>
                                <tr style="background: #f8fafc;">
                                    <td style="padding: 10px; border: 1px solid #cbd5e1;"><strong>TCB</strong></td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">120</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">45,000</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">5,400,000</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">14.0%</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1; color: #10b981; font-weight: bold;">â†‘ 12.1%</td>
                                </tr>
                                <tr style="background: #dbeafe; font-weight: bold;">
                                    <td style="padding: 10px; border: 2px solid #3b82f6;" colspan="3"><strong>TOTAL</strong></td>
                                    <td style="padding: 10px; text-align: right; border: 2px solid #3b82f6;">38,760,000</td>
                                    <td style="padding: 10px; text-align: right; border: 2px solid #3b82f6;">100%</td>
                                    <td style="padding: 10px; text-align: right; border: 2px solid #3b82f6;">+15.8%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Performance Analysis -->
                    <div style="margin-bottom: 25px;">
                        <h2 style="color: #1e40af; font-size: 18px; margin-bottom: 15px;">ğŸ“ˆ Performance Analysis</h2>
                        <div style="background: #f8fafc; padding: 15px; border-left: 4px solid #3b82f6; font-size: 12px;">
                            <p style="margin: 0 0 8px 0;"><strong>Best Performer:</strong> VCB (+24.5%)</p>
                            <p style="margin: 0 0 8px 0;"><strong>Worst Performer:</strong> HPG (-3.2%)</p>
                            <p style="margin: 0 0 8px 0;"><strong>Most Volatile:</strong> FPT (Ïƒ = 28.4%)</p>
                            <p style="margin: 0;"><strong>Most Stable:</strong> VNM (Ïƒ = 12.1%)</p>
                        </div>
                    </div>

                    <!-- Sector Allocation -->
                    <div style="margin-bottom: 25px;">
                        <h2 style="color: #1e40af; font-size: 18px; margin-bottom: 15px;">ğŸ¯ Sector Allocation</h2>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <tr style="background: #1e40af; color: white;">
                                <th style="padding: 10px; text-align: left; border: 1px solid #cbd5e1;">Sector</th>
                                <th style="padding: 10px; text-align: right; border: 1px solid #cbd5e1;">Allocation</th>
                                <th style="padding: 10px; text-align: left; border: 1px solid #cbd5e1;">Visual</th>
                            </tr>
                            <tr style="background: #f8fafc;">
                                <td style="padding: 10px; border: 1px solid #cbd5e1;">Banking</td>
                                <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1; font-weight: bold;">35%</td>
                                <td style="padding: 10px; border: 1px solid #cbd5e1;">
                                    <div style="background: #3b82f6; height: 20px; width: 70%;"></div>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border: 1px solid #cbd5e1;">Technology</td>
                                <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1; font-weight: bold;">25%</td>
                                <td style="padding: 10px; border: 1px solid #cbd5e1;">
                                    <div style="background: #8b5cf6; height: 20px; width: 50%;"></div>
                                </td>
                            </tr>
                            <tr style="background: #f8fafc;">
                                <td style="padding: 10px; border: 1px solid #cbd5e1;">Consumer Goods</td>
                                <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1; font-weight: bold;">20%</td>
                                <td style="padding: 10px; border: 1px solid #cbd5e1;">
                                    <div style="background: #10b981; height: 20px; width: 40%;"></div>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border: 1px solid #cbd5e1;">Industrial</td>
                                <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1; font-weight: bold;">15%</td>
                                <td style="padding: 10px; border: 1px solid #cbd5e1;">
                                    <div style="background: #f59e0b; height: 20px; width: 30%;"></div>
                                </td>
                            </tr>
                            <tr style="background: #f8fafc;">
                                <td style="padding: 10px; border: 1px solid #cbd5e1;">Others</td>
                                <td style="padding: 10px; text-align: right; border: 1px solid #cbd5e1; font-weight: bold;">5%</td>
                                <td style="padding: 10px; border: 1px solid #cbd5e1;">
                                    <div style="background: #64748b; height: 20px; width: 10%;"></div>
                                </td>
                            </tr>
                        </table>
                    </div>

                    ${recommendations ? `
                    <!-- Page Break before Recommendations -->
                    <div style="page-break-before: always;"></div>

                    <!-- AI Recommendations -->
                    <div style="margin-bottom: 25px;">
                        <h2 style="color: #1e40af; font-size: 18px; margin-bottom: 15px;">ğŸ’¡ AI Recommendations</h2>

                        <div style="background: #dbeafe; border-left: 4px solid #3b82f6; padding: 15px; margin-bottom: 15px; font-size: 12px;">
                            <p style="margin: 0 0 10px 0; font-weight: bold; color: #1e40af;">âœ“ Portfolio Strengths</p>
                            <ul style="margin: 0; padding-left: 20px;">
                                <li style="margin-bottom: 5px;">Well-diversified across 5 major sectors</li>
                                <li style="margin-bottom: 5px;">Good balance of growth (FPT, VCB) and stability stocks (VNM)</li>
                                <li style="margin-bottom: 5px;">Strong risk-adjusted returns (Sharpe ratio > 0.8)</li>
                                <li style="margin-bottom: 5px;">Low correlation between major holdings reduces risk</li>
                            </ul>
                        </div>

                        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; margin-bottom: 15px; font-size: 12px;">
                            <p style="margin: 0 0 10px 0; font-weight: bold; color: #92400e;">âš ï¸ Areas for Improvement</p>
                            <ul style="margin: 0; padding-left: 20px;">
                                <li style="margin-bottom: 5px;">Banking sector concentration at 35% exceeds recommended 30% limit</li>
                                <li style="margin-bottom: 5px;">Portfolio volatility (18.3%) slightly above target (15%)</li>
                                <li style="margin-bottom: 5px;">Limited exposure to defensive sectors during market uncertainty</li>
                                <li style="margin-bottom: 5px;">HPG underperforming - consider position size review</li>
                            </ul>
                        </div>

                        <div style="background: #d1fae5; border-left: 4px solid #10b981; padding: 15px; font-size: 12px;">
                            <p style="margin: 0 0 10px 0; font-weight: bold; color: #065f46;">ğŸ¯ Recommended Actions</p>
                            <table style="width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px;">
                                <thead>
                                    <tr style="background: #059669; color: white;">
                                        <th style="padding: 8px; text-align: left;">Action</th>
                                        <th style="padding: 8px; text-align: left;">Details</th>
                                        <th style="padding: 8px; text-align: center;">Priority</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr style="background: white;">
                                        <td style="padding: 8px; border: 1px solid #cbd5e1;"><strong>Rebalance</strong></td>
                                        <td style="padding: 8px; border: 1px solid #cbd5e1;">Reduce VCB position by 2%, increase FPT by 2%</td>
                                        <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: center; color: #ef4444;">High</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #cbd5e1;"><strong>Diversify</strong></td>
                                        <td style="padding: 8px; border: 1px solid #cbd5e1;">Add VNM or MSN for stability and consumer sector exposure</td>
                                        <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: center; color: #f59e0b;">Medium</td>
                                    </tr>
                                    <tr style="background: white;">
                                        <td style="padding: 8px; border: 1px solid #cbd5e1;"><strong>Monitor</strong></td>
                                        <td style="padding: 8px; border: 1px solid #cbd5e1;">Watch HPG performance closely, set stop-loss at -5%</td>
                                        <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: center; color: #f59e0b;">Medium</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #cbd5e1;"><strong>Review</strong></td>
                                        <td style="padding: 8px; border: 1px solid #cbd5e1;">Quarterly rebalancing to maintain target allocation</td>
                                        <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: center; color: #10b981;">Low</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Footer -->
                    <div style="border-top: 2px solid #e2e8f0; padding-top: 15px; margin-top: 30px; text-align: center; color: #64748b; font-size: 10px;">
                        <p style="margin: 0 0 5px 0;"><strong>Disclaimer:</strong> This report is for informational purposes only and does not constitute financial advice.</p>
                        <p style="margin: 0;">Â© ${new Date().getFullYear()} VNStock Analytics - All rights reserved</p>
                    </div>
                </div>
            `;

            return html;
        }

        // Global variable to track selected download format
        let selectedDownloadFormat = 'pdf';

        // Download report directly from Portfolio Analytics tab
        function downloadPortfolioReport() {
            // Check if analysis was run
            if (!portfolioAnalysisResults.analyzed) {
                showAlert('âš ï¸ Please generate your portfolio plan first!\n\nClick "Generate Plan & Analysis" button above.');
                return;
            }

            // Show download format dialog
            document.getElementById('downloadDialog').classList.add('active');
            selectedDownloadFormat = 'pdf'; // Reset to default

            // Reset selection UI
            document.querySelectorAll('.download-format-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector('[data-format="pdf"]').classList.add('selected');
        }

        // ============= SAVED PLANS FUNCTIONS =============

        // Open save plan modal
        function savePlanModal() {
            if (!portfolioAnalysisResults.analyzed) {
                showAlert('âš ï¸ Please generate your portfolio plan first!');
                return;
            }

            document.getElementById('savePlanModal').style.display = 'flex';
            document.getElementById('planNameInput').value = '';
            document.getElementById('planNotesInput').value = '';
        }

        // Close save plan modal
        function closeSavePlanModal() {
            document.getElementById('savePlanModal').style.display = 'none';
        }

        // Save investment plan to database
        async function saveInvestmentPlan() {
            const planName = document.getElementById('planNameInput').value.trim();
            const planNotes = document.getElementById('planNotesInput').value.trim();

            if (!planName) {
                showAlert('âš ï¸ Please enter a plan name');
                return;
            }

            if (!portfolioAnalysisResults.analyzed) {
                showAlert('âš ï¸ No plan to save. Please generate a plan first.');
                return;
            }

            // Fetch current prices for all holdings
            const holdingsWithPrices = [];
            for (const h of portfolioAnalysisResults.holdings) {
                try {
                    const data = await DataAPI.getCurrentPrice(h.symbol);
                    const currentPrice = data?.price || h.price || 0;
                    holdingsWithPrices.push({
                        symbol: h.symbol,
                        shares: h.shares,
                        buyPrice: h.price,
                        priceAtCreation: currentPrice,  // Save current price at time of plan creation
                        allocation: h.percentage,
                        amount: h.amount,
                        expectedReturn: h.expectedReturn
                    });
                } catch (error) {
                    console.error(`Error fetching price for ${h.symbol}:`, error);
                    // Use the plan price as fallback
                    holdingsWithPrices.push({
                        symbol: h.symbol,
                        shares: h.shares,
                        buyPrice: h.price,
                        priceAtCreation: h.price,
                        allocation: h.percentage,
                        amount: h.amount,
                        expectedReturn: h.expectedReturn
                    });
                }
            }

            // Create plan object
            const plan = {
                name: planName,
                notes: planNotes,
                strategy: portfolioAnalysisResults.strategy,
                strategyName: portfolioAnalysisResults.strategyName,
                budget: portfolioAnalysisResults.portfolioValue,
                expectedReturn: portfolioAnalysisResults.totalReturn,
                risk: portfolioAnalysisResults.riskLevel,
                sharpeRatio: portfolioAnalysisResults.sharpeRatio,
                holdings: holdingsWithPrices
            };

            // Save to database via API
            fetch('/api/investment-plans', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(plan)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Close modal
                    closeSavePlanModal();

                    // Show success
                    showSuccess(`âœ… Plan "${planName}" saved successfully!`);

                    // Reload saved plans if on that tab
                    loadSavedPlans();
                } else {
                    showAlert(`âŒ Error saving plan: ${result.error}`);
                }
            })
            .catch(error => {
                console.error('Error saving investment plan:', error);
                showAlert(`âŒ Error saving plan: ${error.message}`);
            });
        }

        // Export investment plan report
        async function exportPlanReport() {
            if (!portfolioAnalysisResults.analyzed) {
                showAlert('âš ï¸ Please generate your portfolio plan first!');
                return;
            }

            // Show export options modal
            const modal = document.createElement('div');
            modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;';
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; ">
                    <h3 style="margin: 0 0 20px 0; color: #1e40af; font-size: 1.5em;">ğŸ“„ Export Report</h3>
                    <p style="color: #64748b; margin-bottom: 20px;">Choose your preferred export format:</p>

                    <button onclick="exportAsPDF()" style="width: 100%; padding: 16px; margin-bottom: 12px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;  transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
                        ğŸ“„ Export as PDF
                    </button>

                    <button onclick="exportAsExcel()" style="width: 100%; padding: 16px; margin-bottom: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;  transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
                        ğŸ“Š Export as Excel
                    </button>

                    <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()" style="width: 100%; padding: 12px; background: #e5e7eb; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        Cancel
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Export as PDF
        async function exportAsPDF() {
            // Close modal
            document.querySelector('[style*="position: fixed"]').remove();

            try {
                const { jsPDF } = window.jspdf || {};
                if (!jsPDF) {
                    showAlert('âŒ PDF library not loaded. Please refresh the page.');
                    return;
                }

                const doc = new jsPDF('portrait', 'mm', 'a4');
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let yPos = 20;

                // Title
                doc.setFontSize(20);
                doc.setTextColor(220, 38, 38);
                doc.text('Investment Plan Report', pageWidth / 2, yPos, { align: 'center' });
                yPos += 10;

                // Date
                doc.setFontSize(10);
                doc.setTextColor(100, 116, 139);
                doc.text(`Generated: ${new Date().toLocaleString()}`, pageWidth / 2, yPos, { align: 'center' });
                yPos += 15;

                // Strategy Info
                doc.setFontSize(14);
                doc.setTextColor(30, 64, 175);
                doc.text('Plan Details', 20, yPos);
                yPos += 8;

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Strategy: ${portfolioAnalysisResults.strategyName || 'N/A'}`, 20, yPos);
                yPos += 6;
                doc.text(`Portfolio Value: ${formatCurrency(portfolioAnalysisResults.portfolioValue)}`, 20, yPos);
                yPos += 10;

                // Key Metrics
                doc.setFontSize(14);
                doc.setTextColor(30, 64, 175);
                doc.text('Key Metrics', 20, yPos);
                yPos += 8;

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                const ensureNumber = (val) => {
                    const num = typeof val === 'string' ? parseFloat(val) : (val ?? 0);
                    return isFinite(num) ? num : 0;
                };

                const metrics = [
                    `Expected Return: ${ensureNumber(portfolioAnalysisResults.totalReturn).toFixed(2)}%`,
                    `Risk (Volatility): ${ensureNumber(portfolioAnalysisResults.riskLevel).toFixed(2)}%`,
                    `Sharpe Ratio: ${ensureNumber(portfolioAnalysisResults.sharpeRatio).toFixed(2)}`,
                    `Max Drawdown: ${ensureNumber(portfolioAnalysisResults.maxDrawdown).toFixed(2)}%`,
                    `Diversification: ${ensureNumber(portfolioAnalysisResults.diversification).toFixed(2)}%`
                ];

                metrics.forEach(metric => {
                    doc.text(metric, 20, yPos);
                    yPos += 6;
                });
                yPos += 5;

                // Holdings Table
                if (yPos > pageHeight - 60) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.setFontSize(14);
                doc.setTextColor(30, 64, 175);
                doc.text('Recommended Holdings', 20, yPos);
                yPos += 8;

                // Table headers
                doc.setFontSize(9);
                doc.setTextColor(255, 255, 255);
                doc.setFillColor(220, 38, 38);
                doc.rect(20, yPos - 5, pageWidth - 40, 7, 'F');
                doc.text('Symbol', 25, yPos);
                doc.text('Shares', 60, yPos);
                doc.text('Price', 90, yPos);
                doc.text('Amount', 120, yPos);
                doc.text('Weight', 155, yPos);
                yPos += 8;

                // Table rows
                doc.setTextColor(0, 0, 0);
                portfolioAnalysisResults.holdings.forEach((holding, index) => {
                    if (yPos > pageHeight - 20) {
                        doc.addPage();
                        yPos = 20;
                    }

                    // Alternating row colors
                    if (index % 2 === 0) {
                        doc.setFillColor(249, 250, 251);
                        doc.rect(20, yPos - 5, pageWidth - 40, 7, 'F');
                    }

                    doc.text(holding.symbol || '', 25, yPos);
                    doc.text(String(holding.shares || 0), 60, yPos);
                    doc.text(formatCurrency(holding.price || 0, false), 90, yPos);
                    doc.text(formatCurrency(holding.amount || 0, false), 120, yPos);
                    const percentage = typeof holding.percentage === 'string' ? parseFloat(holding.percentage) : (holding.percentage || 0);
                    doc.text(`${isFinite(percentage) ? percentage.toFixed(1) : '0.0'}%`, 155, yPos);
                    yPos += 7;
                });

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(148, 163, 184);
                doc.text('Generated by Vietnam Stocks Dashboard', pageWidth / 2, pageHeight - 10, { align: 'center' });

                // Save
                const filename = `Investment_Plan_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                showAlert('âœ… PDF exported successfully!');

            } catch (error) {
                console.error('Error exporting PDF:', error);
                showAlert('âŒ Error exporting PDF: ' + error.message);
            }
        }

        // Export as Excel
        async function exportAsExcel() {
            // Close modal
            document.querySelector('[style*="position: fixed"]').remove();

            try {
                if (typeof XLSX === 'undefined') {
                    showAlert('âŒ Excel library not loaded. Please refresh the page.');
                    return;
                }

                // Create workbook
                const wb = XLSX.utils.book_new();

                // Sheet 1: Plan Summary
                const summaryData = [
                    ['Investment Plan Report'],
                    ['Generated', new Date().toLocaleString()],
                    [],
                    ['Plan Details'],
                    ['Strategy', portfolioAnalysisResults.strategyName || 'N/A'],
                    ['Portfolio Value', portfolioAnalysisResults.portfolioValue || 0],
                    [],
                    ['Key Metrics'],
                    ['Expected Return (%)', portfolioAnalysisResults.totalReturn || 0],
                    ['Risk/Volatility (%)', portfolioAnalysisResults.riskLevel || 0],
                    ['Sharpe Ratio', portfolioAnalysisResults.sharpeRatio || 0],
                    ['Max Drawdown (%)', portfolioAnalysisResults.maxDrawdown || 0],
                    ['Diversification (%)', portfolioAnalysisResults.diversification || 0]
                ];
                const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, ws1, 'Summary');

                // Sheet 2: Holdings
                const holdingsData = [
                    ['Symbol', 'Shares', 'Price (VND)', 'Amount (VND)', 'Weight (%)', 'Expected Return (%)']
                ];
                portfolioAnalysisResults.holdings.forEach(h => {
                    holdingsData.push([
                        h.symbol || '',
                        h.shares || 0,
                        h.price || 0,
                        h.amount || 0,
                        h.percentage || 0,
                        h.expectedReturn || 0
                    ]);
                });
                const ws2 = XLSX.utils.aoa_to_sheet(holdingsData);
                XLSX.utils.book_append_sheet(wb, ws2, 'Holdings');

                // Sheet 3: Sector Allocation (if available)
                if (portfolioAnalysisResults.sectors && Object.keys(portfolioAnalysisResults.sectors).length > 0) {
                    const sectorData = [['Sector', 'Allocation (%)']];
                    Object.entries(portfolioAnalysisResults.sectors).forEach(([sector, value]) => {
                        sectorData.push([sector, value]);
                    });
                    const ws3 = XLSX.utils.aoa_to_sheet(sectorData);
                    XLSX.utils.book_append_sheet(wb, ws3, 'Sectors');
                }

                // Save
                const filename = `Investment_Plan_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, filename);
                showAlert('âœ… Excel file exported successfully!');

            } catch (error) {
                console.error('Error exporting Excel:', error);
                showAlert('âŒ Error exporting Excel: ' + error.message);
            }
        }

        // Load and display saved plans
        async function loadSavedPlans() {
            const container = document.getElementById('savedPlansList');
            let savedPlans = [];

            try {
                // Fetch plans from API
                const response = await fetch('/api/investment-plans', {
                    credentials: 'include'
                });
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to load plans');
                }

                savedPlans = result.data || [];

                if (savedPlans.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #94a3b8;">
                            <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“Š</div>
                            <p data-i18n="portfolio.no_saved_plans">No saved plans yet. Create and save an investment plan to track its performance!</p>
                        </div>
                    `;
                    return;
                }
            } catch (error) {
                console.error('Error loading saved plans:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <div style="font-size: 3em; margin-bottom: 10px;">âš ï¸</div>
                        <p>Error loading saved plans: ${error.message}</p>
                    </div>
                `;
                return;
            }

            // Fetch current prices for all symbols in saved plans
            const allSymbols = [...new Set(savedPlans.flatMap(plan => plan.holdings.map(h => h.symbol)))];
            const currentPrices = {};

            for (const symbol of allSymbols) {
                try {
                    const data = await DataAPI.getCurrentPrice(symbol);
                    if (data && data.price) {
                        currentPrices[symbol] = data.price;
                    }
                } catch (error) {
                    console.error(`Error fetching price for ${symbol}:`, error);
                }
            }

            // Sort plans by date (newest first)
            savedPlans.sort((a, b) => new Date(b.createdDate) - new Date(a.createdDate));

            // Generate HTML for each plan
            const plansHTML = savedPlans.map(plan => {
                // Calculate current performance
                let totalInvested = 0;
                let currentValue = 0;
                let missingPrices = 0;

                plan.holdings.forEach(holding => {
                    const invested = holding.amount || 0;
                    totalInvested += invested;

                    // Try current price, fallback to saved price if unavailable
                    let priceToUse = currentPrices[holding.symbol];
                    if (!priceToUse) {
                        // Use the price saved when plan was created as fallback
                        priceToUse = parseFloat(holding.buyPrice || holding.priceAtCreation || holding.price) || 0;
                    }

                    if (priceToUse && holding.shares) {
                        currentValue += priceToUse * holding.shares;
                    } else if (holding.shares) {
                        // Only count as missing if we have shares but no price at all
                        missingPrices++;
                    }
                });

                const profitLoss = currentValue - totalInvested;
                const profitLossPercent = totalInvested > 0 ? (profitLoss / totalInvested) * 100 : 0;
                const profitColor = profitLoss >= 0 ? '#10b981' : '#ef4444';
                const profitSign = profitLoss >= 0 ? '+' : '';

                const daysSince = Math.floor((Date.now() - new Date(plan.createdDate)) / (1000 * 60 * 60 * 24));

                // Calculate annualized return
                const yearsElapsed = daysSince / 365;
                const annualizedReturn = yearsElapsed > 0 ? (Math.pow(currentValue / totalInvested, 1 / yearsElapsed) - 1) * 100 : profitLossPercent;

                // Calculate individual stock performance
                const stockPerformances = plan.holdings.map(holding => {
                    const buyPrice = parseFloat(holding.buyPrice || holding.priceAtCreation || holding.price) || 0;
                    // Use current price, or fallback to buy price if unavailable (0% change)
                    const currentPrice = currentPrices[holding.symbol] || buyPrice;
                    const change = buyPrice > 0 && currentPrice > 0 ? ((currentPrice - buyPrice) / buyPrice) * 100 : 0;
                    return {
                        symbol: holding.symbol,
                        change: change,
                        changeAmount: (currentPrice - buyPrice) * (holding.shares || 0)
                    };
                }).filter(p => !isNaN(p.change) && isFinite(p.change));

                // Find best and worst performers
                let bestPerformer = stockPerformances.length > 0 ? stockPerformances.reduce((max, p) => p.change > max.change ? p : max) : null;
                let worstPerformer = stockPerformances.length > 0 ? stockPerformances.reduce((min, p) => p.change < min.change ? p : min) : null;

                // Performance status vs expected
                const performanceDiff = profitLossPercent - plan.expectedReturn;
                const performanceStatus = performanceDiff > 2 ? 'ğŸ¯ Outperforming' :
                                        performanceDiff < -2 ? 'âš ï¸ Underperforming' :
                                        'âœ… On Track';
                const performanceColor = performanceDiff > 0 ? '#10b981' : performanceDiff < -2 ? '#ef4444' : '#3b82f6';

                // Calculate Win Rate and Winners/Losers
                const winners = stockPerformances.filter(p => p.change > 0);
                const losers = stockPerformances.filter(p => p.change < 0);
                const winRate = stockPerformances.length > 0 ? (winners.length / stockPerformances.length) * 100 : 0;

                // Calculate Average Gain
                const totalGain = stockPerformances.reduce((sum, p) => sum + p.change, 0);
                const avgGain = stockPerformances.length > 0 ? totalGain / stockPerformances.length : 0;

                // Calculate ROI
                const roi = totalInvested > 0 ? (profitLoss / totalInvested) * 100 : 0;

                // Calculate Risk Level based on stock performance spread
                const avgChange = stockPerformances.length > 0 ? stockPerformances.reduce((sum, p) => sum + p.change, 0) / stockPerformances.length : 0;
                const variance = stockPerformances.length > 0 ? stockPerformances.reduce((sum, p) => sum + Math.pow(p.change - avgChange, 2), 0) / stockPerformances.length : 0;
                const standardDeviation = Math.sqrt(variance);
                const riskLevel = standardDeviation < 10 ? 'Low' : standardDeviation < 20 ? 'Medium' : 'High';
                const riskColor = standardDeviation < 10 ? '#10b981' : standardDeviation < 20 ? '#f59e0b' : '#ef4444';

                return `
                    <div class="card collapsible" style="margin-bottom: 20px; max-width: 100%; overflow: hidden; border-left: 4px solid ${profitColor};">
                        <h3 style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div style="flex: 1; min-width: 200px; max-width: 100%; overflow: hidden;">
                                <div style="color: #1e40af; font-size: 1.4em; word-wrap: break-word; margin-bottom: 8px;">${plan.name}</div>
                                <div style="color: #64748b; font-size: 0.9em; font-weight: normal; overflow-wrap: break-word;">
                                    <div>ğŸ“… Created: ${formatDateTime(new Date(plan.createdDate))} (${daysSince} days ago)</div>
                                    <div style="margin-top: 5px;">ğŸ“Š Strategy: ${plan.strategyName}</div>
                                    ${plan.notes ? `<div style="margin-top: 5px; word-wrap: break-word;">ğŸ“ ${plan.notes}</div>` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; flex-shrink: 0;">
                                <button onclick="event.stopPropagation(); viewPlanDetails('${plan.id}');" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                                    ğŸ“Š <span data-i18n="portfolio.view_details">View Details</span>
                                </button>
                                <button onclick="event.stopPropagation(); renameSavedPlan('${plan.id}', '${plan.name.replace(/'/g, "\\'")}');" style="padding: 10px 20px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                                    âœï¸ <span data-i18n="button.rename">Rename</span>
                                </button>
                                <button onclick="event.stopPropagation(); deleteSavedPlan('${plan.id}');" style="padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                                    ğŸ—‘ï¸ <span data-i18n="button.delete">Delete</span>
                                </button>
                            </div>
                        </h3>

                        <div class="card-content">
                        <!-- Main Metrics Grid -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; min-width: 0;">
                                <div style="color: #64748b; font-size: 0.85em; margin-bottom: 5px;">Initial Investment</div>
                                <div style="font-size: 1.2em; font-weight: 700; color: #1e293b; word-break: break-word;">${totalInvested.toLocaleString()} VND</div>
                            </div>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; min-width: 0;">
                                <div style="color: #64748b; font-size: 0.85em; margin-bottom: 5px;">Current Value</div>
                                <div style="font-size: 1.2em; font-weight: 700; color: ${profitColor}; word-break: break-word;">${currentValue.toLocaleString()} VND</div>
                            </div>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; min-width: 0;">
                                <div style="color: #64748b; font-size: 0.85em; margin-bottom: 5px;">Profit/Loss</div>
                                <div style="font-size: 1.2em; font-weight: 700; color: ${profitColor}; word-break: break-word;">${profitSign}${profitLoss.toLocaleString()} VND</div>
                                <div style="font-size: 0.9em; color: ${profitColor};">(${profitSign}${profitLossPercent.toFixed(2)}%)</div>
                            </div>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; min-width: 0;">
                                <div style="color: #64748b; font-size: 0.85em; margin-bottom: 5px;" data-i18n="portfolio.annualized_return">Annualized Return</div>
                                <div style="font-size: 1.2em; font-weight: 700; color: ${profitColor};">${profitSign}${annualizedReturn.toFixed(2)}%</div>
                                <div style="font-size: 0.85em; color: #64748b;">(${daysSince} days)</div>
                            </div>
                        </div>

                        <!-- Comparison Metrics Grid -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; min-width: 0;">
                                <div style="color: #64748b; font-size: 0.85em; margin-bottom: 5px;">Expected Return</div>
                                <div style="font-size: 1.2em; font-weight: 700; color: #1e293b;">${plan.expectedReturn.toFixed(2)}%</div>
                            </div>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; min-width: 0; border-left: 3px solid ${performanceColor};">
                                <div style="color: #64748b; font-size: 0.85em; margin-bottom: 5px;" data-i18n="portfolio.performance_status">Performance Status</div>
                                <div style="font-size: 1em; font-weight: 700; color: ${performanceColor};">${performanceStatus}</div>
                                <div style="font-size: 0.85em; color: #64748b;">${performanceDiff >= 0 ? '+' : ''}${performanceDiff.toFixed(2)}% vs expected</div>
                            </div>
                            ${bestPerformer ? `
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; min-width: 0; border-left: 3px solid #10b981;">
                                    <div style="color: #64748b; font-size: 0.85em; margin-bottom: 5px;" data-i18n="portfolio.best_performer">Best Performer</div>
                                    <div style="font-size: 1em; font-weight: 700; color: #1e293b;">${getStockDisplayName(bestPerformer.symbol)}</div>
                                    <div style="font-size: 0.85em; color: #10b981;">+${bestPerformer.change.toFixed(2)}%</div>
                                </div>
                            ` : ''}
                            ${worstPerformer ? `
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; min-width: 0; border-left: 3px solid #ef4444;">
                                    <div style="color: #64748b; font-size: 0.85em; margin-bottom: 5px;" data-i18n="portfolio.worst_performer">Worst Performer</div>
                                    <div style="font-size: 1em; font-weight: 700; color: #1e293b;">${getStockDisplayName(worstPerformer.symbol)}</div>
                                    <div style="font-size: 0.85em; color: #ef4444;">${worstPerformer.change >= 0 ? '+' : ''}${worstPerformer.change.toFixed(2)}%</div>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Additional Performance Metrics -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; min-width: 0;">
                                <div style="color: #64748b; font-size: 0.85em; margin-bottom: 5px;" data-i18n="portfolio.win_rate">Win Rate</div>
                                <div style="font-size: 1.2em; font-weight: 700; color: ${winRate >= 50 ? '#10b981' : '#ef4444'};">${winRate.toFixed(1)}%</div>
                                <div style="font-size: 0.85em; color: #64748b;">${winners.length}W / ${losers.length}L</div>
                            </div>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; min-width: 0;">
                                <div style="color: #64748b; font-size: 0.85em; margin-bottom: 5px;" data-i18n="portfolio.avg_gain">Avg Gain/Stock</div>
                                <div style="font-size: 1.2em; font-weight: 700; color: ${avgGain >= 0 ? '#10b981' : '#ef4444'};">${avgGain >= 0 ? '+' : ''}${avgGain.toFixed(2)}%</div>
                            </div>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; min-width: 0;">
                                <div style="color: #64748b; font-size: 0.85em; margin-bottom: 5px;" data-i18n="portfolio.total_roi">Total ROI</div>
                                <div style="font-size: 1.2em; font-weight: 700; color: ${roi >= 0 ? '#10b981' : '#ef4444'};">${roi >= 0 ? '+' : ''}${roi.toFixed(2)}%</div>
                            </div>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; min-width: 0; border-left: 3px solid ${riskColor};">
                                <div style="color: #64748b; font-size: 0.85em; margin-bottom: 5px;" data-i18n="portfolio.risk_level">Risk Level</div>
                                <div style="font-size: 1em; font-weight: 700; color: ${riskColor};">${riskLevel}</div>
                                <div style="font-size: 0.85em; color: #64748b;">Ïƒ: ${standardDeviation.toFixed(2)}%</div>
                            </div>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; min-width: 0;">
                                <div style="color: #64748b; font-size: 0.85em; margin-bottom: 5px;" data-i18n="portfolio.holdings_count">Holdings</div>
                                <div style="font-size: 1.2em; font-weight: 700; color: #1e293b;">${plan.holdings.length}</div>
                                <div style="font-size: 0.85em; color: #64748b;">stocks</div>
                            </div>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; min-width: 0;">
                                <div style="color: #64748b; font-size: 0.85em; margin-bottom: 5px;" data-i18n="portfolio.sharpe_ratio">Sharpe Ratio</div>
                                <div style="font-size: 1.2em; font-weight: 700; color: #1e293b;">${plan.sharpeRatio ? plan.sharpeRatio.toFixed(2) : 'N/A'}</div>
                            </div>
                        </div>

                        ${missingPrices > 0 ? `
                            <div style="background: #fef3c7; padding: 12px; border-radius: 8px; border-left: 4px solid #f59e0b; font-size: 0.9em; color: #92400e; overflow-wrap: break-word;">
                                âš ï¸ ${missingPrices} stock(s) have no price data. Current value may be incomplete.
                            </div>
                        ` : ''}
                        </div> <!-- End card-content -->
                    </div> <!-- End card -->
                `;
            }).join('');

            container.innerHTML = plansHTML;

            // Initialize collapsible functionality for saved plans
            setTimeout(() => {
                if (typeof window.initializeCollapsibleSections === 'function') {
                    window.initializeCollapsibleSections();
                    console.log('âœ… Collapsible sections initialized for saved plans');
                }
            }, 100);
        }

        // View plan details with comparison
        async function viewPlanDetails(planId) {
            try {
                // Fetch plan from API
                const response = await fetch('/api/investment-plans', {
                    credentials: 'include'
                });
                const result = await response.json();

                if (!result.success) {
                    showAlert('âš ï¸ Error: ' + (result.error || 'Failed to load plan'));
                    return;
                }

                const plan = result.data.find(p => p.id === planId);

                if (!plan) {
                    showAlert('âš ï¸ Plan not found');
                    return;
                }

                // Fetch current prices for all holdings
                let detailsHTML = `
                    <div style="background: white; padding: 30px; border-radius: 12px; max-height: 80vh; overflow-y: auto; max-width: 100%;">
                        <h2 style="margin: 0 0 20px 0; color: #1e40af; word-wrap: break-word;">${plan.name}</h2>

                    <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                        <div style="color: #64748b; margin-bottom: 10px;">
                            ğŸ“… Created: ${formatDateTime(new Date(plan.createdDate))}
                        </div>
                        <div style="color: #64748b; margin-bottom: 10px;">
                            ğŸ“Š Strategy: ${plan.strategyName}
                        </div>
                        ${plan.notes ? `<div style="color: #64748b; word-wrap: break-word;">ğŸ“ Notes: ${plan.notes}</div>` : ''}
                    </div>

                    <h3 style="color: #1e40af; margin-bottom: 15px;">Holdings Performance</h3>
                    <div style="overflow-x: auto; max-width: 100%;">
                    <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
                        <thead>
                            <tr style="background: #f1f5f9;">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #cbd5e1; white-space: nowrap;">Stock</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #cbd5e1; white-space: nowrap;">Shares</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #cbd5e1; white-space: nowrap;">Planned Price</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #cbd5e1; white-space: nowrap;">Current Price</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #cbd5e1; white-space: nowrap;">Price Change</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #cbd5e1; white-space: nowrap;">P/L</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #cbd5e1; white-space: nowrap;">Chart</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            for (const holding of plan.holdings) {
                try {
                    const data = await DataAPI.getCurrentPrice(holding.symbol);
                    const currentPrice = parseFloat(data?.price) || 0;
                    const buyPrice = parseFloat(holding.buyPrice || holding.priceAtCreation || holding.price) || 0;
                    const shares = parseFloat(holding.shares) || 0;

                    // Validate prices
                    if (!buyPrice || !currentPrice || isNaN(buyPrice) || isNaN(currentPrice)) {
                        console.warn(`Invalid price data for ${holding.symbol}: buyPrice=${buyPrice}, currentPrice=${currentPrice}`);
                        throw new Error('Invalid price data');
                    }

                    const priceChange = currentPrice - buyPrice;
                    const priceChangePercent = buyPrice > 0 ? (priceChange / buyPrice) * 100 : 0;
                    const profitLoss = priceChange * shares;
                    const profitColor = priceChange >= 0 ? '#10b981' : '#ef4444';
                    const profitSign = priceChange >= 0 ? '+' : '';

                    detailsHTML += `
                        <tr style="border-bottom: 1px solid #e2e8f0;" data-symbol="${holding.symbol}">
                            <td style="padding: 12px; font-weight: 600;">${getStockDisplayName(holding.symbol)}</td>
                            <td style="padding: 12px; text-align: right;">
                                <input type="number"
                                    class="shares-input"
                                    data-symbol="${holding.symbol}"
                                    value="${shares}"
                                    min="0"
                                    step="1"
                                    style="width: 100px; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: right; font-family: inherit;"
                                    onchange="markPlanAsEdited()">
                            </td>
                            <td style="padding: 12px; text-align: right;">${Math.round(buyPrice).toLocaleString()}</td>
                            <td style="padding: 12px; text-align: right;">${Math.round(currentPrice).toLocaleString()}</td>
                            <td style="padding: 12px; text-align: right; color: ${profitColor}; font-weight: 600;">
                                ${profitSign}${Math.round(priceChange).toLocaleString()}<br>
                                <span style="font-size: 0.85em;">(${profitSign}${priceChangePercent.toFixed(2)}%)</span>
                            </td>
                            <td style="padding: 12px; text-align: right; color: ${profitColor}; font-weight: 700;">
                                ${profitSign}${Math.round(profitLoss).toLocaleString()} VND
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <a href="advanced_charts.html?symbol=${holding.symbol}" target="_blank" style="display: inline-flex; align-items: center; justify-content: center; padding: 6px 12px; background: #3b82f6; color: white; text-decoration: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; transition: background 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                                    ğŸ“ˆ Chart
                                </a>
                            </td>
                        </tr>
                    `;
                } catch (error) {
                    console.error(`Error fetching price for ${holding.symbol}:`, error);
                    const buyPrice = parseFloat(holding.buyPrice) || 0;
                    const shares = parseFloat(holding.shares) || 0;
                    detailsHTML += `
                        <tr style="border-bottom: 1px solid #e2e8f0;" data-symbol="${holding.symbol}">
                            <td style="padding: 12px; font-weight: 600;">${getStockDisplayName(holding.symbol)}</td>
                            <td style="padding: 12px; text-align: right;">
                                <input type="number"
                                    class="shares-input"
                                    data-symbol="${holding.symbol}"
                                    value="${shares}"
                                    min="0"
                                    step="1"
                                    style="width: 100px; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: right; font-family: inherit;"
                                    onchange="markPlanAsEdited()">
                            </td>
                            <td style="padding: 12px; text-align: right;">${buyPrice > 0 ? Math.round(buyPrice).toLocaleString() : 'N/A'}</td>
                            <td style="padding: 12px; text-align: right; color: #94a3b8;">N/A</td>
                            <td style="padding: 12px; text-align: right; color: #94a3b8;">N/A</td>
                            <td style="padding: 12px; text-align: right; color: #94a3b8;">N/A</td>
                            <td style="padding: 12px; text-align: center;">
                                <a href="advanced_charts.html?symbol=${holding.symbol}" target="_blank" style="display: inline-flex; align-items: center; justify-content: center; padding: 6px 12px; background: #3b82f6; color: white; text-decoration: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; transition: background 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                                    ğŸ“ˆ Chart
                                </a>
                            </td>
                        </tr>
                    `;
                }
            }

            detailsHTML += `
                        </tbody>
                    </table>
                    </div>

                    <div style="margin-top: 30px; display: flex; justify-content: space-between; align-items: center;">
                        <div id="planEditStatus" style="color: #64748b; font-size: 0.9em;"></div>
                        <div style="display: flex; gap: 10px;">
                            <button id="savePlanChangesBtn" onclick="savePlanChanges('${plan.id}')" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: none;">
                                ğŸ’¾ Save Changes
                            </button>
                            <button onclick="closeViewDetails()" style="padding: 12px 24px; background: #e5e7eb; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                <span data-i18n="button.close">Close</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;

                // Create and show modal
                const modal = document.createElement('div');
                modal.id = 'planDetailsModal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 20px;';
                modal.innerHTML = detailsHTML;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error in viewPlanDetails:', error);
                showAlert('âš ï¸ Error displaying plan details: ' + error.message);
            }
        }

        // Close view details modal
        function closeViewDetails() {
            const modal = document.getElementById('planDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Mark plan as edited (show save button)
        function markPlanAsEdited() {
            const saveBtn = document.getElementById('savePlanChangesBtn');
            const statusDiv = document.getElementById('planEditStatus');
            if (saveBtn) {
                saveBtn.style.display = 'block';
            }
            if (statusDiv) {
                statusDiv.textContent = 'âœï¸ Unsaved changes';
                statusDiv.style.color = '#f59e0b';
            }
        }

        // Save plan changes
        async function savePlanChanges(planId) {
            const saveBtn = document.getElementById('savePlanChangesBtn');
            const statusDiv = document.getElementById('planEditStatus');

            try {
                // Collect all edited shares
                const holdings = [];
                document.querySelectorAll('.shares-input').forEach(input => {
                    holdings.push({
                        symbol: input.dataset.symbol,
                        shares: parseFloat(input.value) || 0
                    });
                });

                // Disable button during save
                saveBtn.disabled = true;
                saveBtn.textContent = 'ğŸ’¾ Saving...';
                statusDiv.textContent = 'â³ Saving changes...';
                statusDiv.style.color = '#3b82f6';

                const response = await fetch(`/api/investment-plans/${planId}/holdings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ holdings })
                });

                const result = await response.json();

                if (result.success) {
                    statusDiv.textContent = 'âœ… Changes saved successfully!';
                    statusDiv.style.color = '#10b981';
                    saveBtn.style.display = 'none';
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'ğŸ’¾ Save Changes';

                    // Refresh the plan list
                    setTimeout(() => {
                        loadSavedPlans();
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Failed to save changes');
                }
            } catch (error) {
                console.error('Error saving plan changes:', error);
                statusDiv.textContent = 'âŒ Error saving changes';
                statusDiv.style.color = '#ef4444';
                saveBtn.disabled = false;
                saveBtn.textContent = 'ğŸ’¾ Save Changes';
                showAlert('âš ï¸ Error saving changes: ' + error.message);
            }
        }

        // Rename saved plan
        function renameSavedPlan(planId, currentName) {
            const newName = prompt('Enter new name for this plan:', currentName);
            if (!newName || newName.trim() === '' || newName.trim() === currentName) {
                return;
            }

            fetch(`/api/investment-plans/${planId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ name: newName.trim() })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showSuccess('âœ… Plan renamed successfully');
                    loadSavedPlans();
                } else {
                    showAlert(`âŒ Error renaming plan: ${result.error}`);
                }
            })
            .catch(error => {
                console.error('Error renaming plan:', error);
                showAlert(`âŒ Error renaming plan: ${error.message}`);
            });
        }

        // Delete saved plan
        function deleteSavedPlan(planId) {
            if (!confirm('Are you sure you want to delete this plan? This action cannot be undone.')) {
                return;
            }

            // Delete via API
            fetch(`/api/investment-plans/${planId}`, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showSuccess('âœ… Plan deleted successfully');
                    loadSavedPlans();
                } else {
                    showAlert(`âŒ Error deleting plan: ${result.error}`);
                }
            })
            .catch(error => {
                console.error('Error deleting plan:', error);
                showAlert(`âŒ Error deleting plan: ${error.message}`);
            });
        }

        // Load saved plans when switching to that tab
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved plans if user navigates to that tab
            const originalSwitchTab = window.switchTab;
            window.switchTab = function(tabName) {
                originalSwitchTab(tabName);
                if (tabName === 'savedplans') {
                    loadSavedPlans();
                }
            };
        });

        // Select download format in dialog
        function selectDownloadFormat(format) {
            selectedDownloadFormat = format;

            // Update UI
            document.querySelectorAll('.download-format-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`[data-format="${format}"]`).classList.add('selected');

            console.log('ğŸ“¥ Format selected:', format);
        }

        // Close download dialog
        function closeDownloadDialog() {
            document.getElementById('downloadDialog').classList.remove('active');
        }

        // Confirm and start download
        function confirmDownload() {
            console.log('ğŸ“¥ Downloading report in format:', selectedDownloadFormat);

            // Close dialog
            closeDownloadDialog();

            const filename = `portfolio-report-${new Date().getTime()}`;

            // Set format for existing downloadReport function to use
            // Create temporary elements if they don't exist
            if (!document.getElementById('reportType')) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = `
                    <input type="hidden" id="reportType" value="summary">
                    <input type="hidden" id="reportPeriod" value="3m">
                    <input type="hidden" id="reportFormat" value="${selectedDownloadFormat}">
                    <input type="hidden" id="includeCharts" checked>
                    <input type="hidden" id="includeRecommendations" checked>
                    <div id="reportContent"></div>
                `;
                document.body.appendChild(tempDiv);
            } else {
                document.getElementById('reportFormat').value = selectedDownloadFormat;
            }

            // Call existing download function
            downloadReport();
        }

        function downloadReport() {
            const reportContent = document.getElementById('reportContent');
            const reportType = document.getElementById('reportType') ? document.getElementById('reportType').value : 'summary';
            const format = document.getElementById('reportFormat') ? document.getElementById('reportFormat').value : 'pdf';
            const filename = `portfolio-report-${reportType}-${new Date().getTime()}`;

            // Check if analysis data exists
            if (!portfolioAnalysisResults.analyzed) {
                showAlert('âš ï¸ Please generate your portfolio plan first!');
                return;
            }

            if (format === 'html') {
                // Generate HTML report content
                const data = portfolioAnalysisResults;
                const date = new Date().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                let holdingsHTML = '';
                if (data.holdings && data.holdings.length > 0) {
                    holdingsHTML = data.holdings.map(h => `
                        <tr>
                            <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${h.symbol}</td>
                            <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${h.shares || 0}</td>
                            <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${(h.currentPrice || 0).toLocaleString()} VND</td>
                            <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${h.percentage || 0}%</td>
                            <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${(h.amount || 0).toLocaleString()} VND</td>
                        </tr>
                    `).join('');
                } else {
                    holdingsHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #64748b;">No holdings data available</td></tr>';
                }

                const fullHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Portfolio Investment Report - VNStock Analytics</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 40px;
            background: #f8fafc;
            color: #1f2937;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            
        }
        h1 {
            color: #dc2626;
            margin-bottom: 10px;
            font-size: 2em;
        }
        .date {
            color: #64748b;
            margin-bottom: 30px;
            font-size: 0.9em;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #dc2626;
        }
        .metric-label {
            font-size: 0.85em;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.05em;
        }
        .metric-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #1f2937;
            margin-top: 8px;
        }
        h2 {
            color: #1f2937;
            margin-top: 40px;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #dc2626;
            padding-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th {
            background: #f8fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #1f2937;
            border-bottom: 2px solid #e5e7eb;
        }
        .footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
            color: #64748b;
            font-size: 0.85em;
            text-align: center;
        }
        .strategy-badge {
            display: inline-block;
            padding: 6px 12px;
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š Portfolio Investment Report</h1>
        <div class="date">Generated on ${date}</div>

        <div class="strategy-badge">${data.strategyName || 'Investment Strategy'}</div>

        <div class="metrics">
            <div class="metric-card">
                <div class="metric-label">Portfolio Value</div>
                <div class="metric-value">${(data.portfolioValue || 0).toLocaleString()} VND</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Expected Return</div>
                <div class="metric-value">${(data.totalReturn || 0).toFixed(2)}%</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Risk Level</div>
                <div class="metric-value">${(data.riskLevel || 0).toFixed(2)}%</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Sharpe Ratio</div>
                <div class="metric-value">${(data.sharpeRatio || 0).toFixed(2)}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Max Drawdown</div>
                <div class="metric-value">${(data.maxDrawdown || 0).toFixed(1)}%</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Diversification</div>
                <div class="metric-value">${(data.diversification || 0).toFixed(0)}%</div>
            </div>
        </div>

        <h2>ğŸ’¼ Portfolio Holdings</h2>
        <table>
            <thead>
                <tr>
                    <th>Stock Symbol</th>
                    <th>Shares</th>
                    <th>Price</th>
                    <th>Allocation %</th>
                    <th>Total Value</th>
                </tr>
            </thead>
            <tbody>
                ${holdingsHTML}
            </tbody>
        </table>

        <div class="footer">
            <p><strong>VNStock Analytics</strong> - Portfolio Investment Report</p>
            <p style="margin-top: 10px;">This report is for informational purposes only and does not constitute investment advice.</p>
        </div>
    </div>
</body>
</html>`;

                const blob = new Blob([fullHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.html`;
                a.click();
                URL.revokeObjectURL(url);

                showSuccess('âœ… HTML report downloaded successfully!');
            } else if (format === 'pdf') {
                // Check if portfolio analysis has been run
                if (!portfolioAnalysisResults.analyzed) {
                    showAlert('âš ï¸ Please run Portfolio Analysis first!\n\n1. Go to "Portfolio Analytics" tab\n2. Select stocks and click "Analyze Portfolio"\n3. Then return here to generate report');
                    return;
                }

                // Use jsPDF directly for reliable PDF generation
                showAlert('ğŸ“„ Generating PDF... Please wait.');

                try {
                    // Get real data from portfolio analysis
                    const data = portfolioAnalysisResults;

                    // Create new jsPDF instance
                    const { jsPDF } = window.jspdf || {};

                    if (!jsPDF) {
                        // Fallback to html2pdf if jsPDF not available
                        if (typeof html2pdf === 'undefined') {
                            showAlert('âŒ PDF library not available. Please use HTML format.');
                            return;
                        }

                        // Try html2pdf as fallback
                        const pdfHTML = buildSimplifiedPDFContent(
                            document.getElementById('reportType').value,
                            document.getElementById('reportPeriod').value,
                            document.getElementById('includeRecommendations').checked
                        );

                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = pdfHTML;
                        document.body.appendChild(tempDiv);

                        html2pdf().from(tempDiv).set({
                            margin: 0.5,
                            filename: `${filename}.pdf`,
                            jsPDF: { format: 'letter', orientation: 'portrait' }
                        }).save().then(() => {
                            document.body.removeChild(tempDiv);
                            showAlert('âœ… PDF downloaded!');
                        });
                        return;
                    }

                    // Build PDF with jsPDF directly
                    const doc = new jsPDF('portrait', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 15;
                    const contentWidth = pageWidth - (margin * 2);
                    let yPos = margin;

                    // Header
                    doc.setFillColor(30, 64, 175);
                    doc.rect(0, 0, pageWidth, 30, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(20);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Portfolio Report', margin, yPos + 7);

                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text(new Date().toLocaleDateString(), margin, yPos + 14);

                    // Add strategy info if available
                    if (data.strategyName) {
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'italic');
                        doc.text('Strategy: ' + data.strategyName, margin, yPos + 20);
                    }

                    yPos = 40;
                    doc.setTextColor(0, 0, 0);

                    // Key Metrics
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(30, 64, 175);
                    doc.text('Key Metrics', margin, yPos);
                    yPos += 8;

                    // Use real data from portfolio analysis with fallbacks
                    const portfolioValue = data.portfolioValue || 0;
                    const totalReturn = data.totalReturn || 0;
                    const sharpeRatio = data.sharpeRatio || 0;
                    const riskLevel = data.riskLevel || 0;
                    const maxDrawdown = data.maxDrawdown || 0;
                    const diversification = data.diversification || 0;

                    const metrics = [
                        ['Portfolio Value', formatCurrency(portfolioValue), `${totalReturn > 0 ? '+' : ''}${totalReturn.toFixed(1)}%`],
                        ['Total Return', `${totalReturn > 0 ? '+' : ''}${totalReturn.toFixed(1)}%`, `Annual: ${(totalReturn * 1.5).toFixed(1)}%`],
                        ['Sharpe Ratio', sharpeRatio.toFixed(2), sharpeRatio > 0.8 ? 'Good' : sharpeRatio > 0.5 ? 'Fair' : 'Low'],
                        ['Risk Level', `${riskLevel.toFixed(1)}%`, riskLevel < 15 ? 'Low' : riskLevel < 25 ? 'Moderate' : 'High'],
                        ['Max Drawdown', `${maxDrawdown.toFixed(1)}%`, 'Peak to trough'],
                        ['Diversification', `${diversification.toFixed(0)}%`, diversification > 80 ? 'Well diversified' : 'Moderate']
                    ];

                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(0, 0, 0);

                    metrics.forEach(([label, value, detail]) => {
                        doc.setFont('helvetica', 'bold');
                        doc.text(label + ':', margin, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(value + ' (' + detail + ')', margin + 40, yPos);
                        yPos += 6;
                    });

                    yPos += 5;

                    // Holdings Table
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(30, 64, 175);
                    doc.text('Portfolio Holdings', margin, yPos);
                    yPos += 8;

                    // Table header
                    doc.setFillColor(30, 64, 175);
                    doc.rect(margin, yPos - 5, contentWidth, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Symbol', margin + 2, yPos);
                    doc.text('Shares', margin + 30, yPos);
                    doc.text('Price', margin + 50, yPos);
                    doc.text('Value', margin + 75, yPos);
                    doc.text('Weight', margin + 105, yPos);
                    doc.text('Return', margin + 130, yPos);
                    yPos += 8;

                    // Holdings data from real portfolio analysis
                    const holdings = (data.holdings || []).map(h => {
                        const symbol = h.symbol || 'N/A';
                        const shares = h.shares || 0;
                        const price = h.currentPrice || h.price || 0;
                        const value = h.amount || h.value || 0;
                        const weight = parseFloat(h.percentage || h.weight || 0);
                        const returnPct = h.expectedReturn || h.return || 0;

                        return [
                            symbol,
                            shares.toString(),
                            formatCurrency(price),
                            formatCurrency(value),
                            `${weight.toFixed(1)}%`,
                            `${returnPct > 0 ? '+' : ''}${returnPct.toFixed(1)}%`,
                            returnPct >= 0
                        ];
                    });

                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'normal');

                    if (holdings.length > 0) {
                        holdings.forEach(([symbol, shares, price, value, weight, ret, positive], idx) => {
                            if (idx % 2 === 0) {
                                doc.setFillColor(248, 250, 252);
                                doc.rect(margin, yPos - 5, contentWidth, 7, 'F');
                            }

                            doc.setFont('helvetica', 'bold');
                            doc.text(symbol, margin + 2, yPos);
                            doc.setFont('helvetica', 'normal');
                            doc.text(shares, margin + 30, yPos);
                            doc.text(price, margin + 50, yPos);
                            doc.text(value, margin + 75, yPos);
                            doc.text(weight, margin + 105, yPos);

                            doc.setTextColor(positive ? 16 : 239, positive ? 185 : 68, positive ? 129 : 68);
                            doc.setFont('helvetica', 'bold');
                            doc.text(ret, margin + 130, yPos);
                            doc.setTextColor(0, 0, 0);
                            doc.setFont('helvetica', 'normal');

                            yPos += 7;
                        });
                    } else {
                        doc.setFont('helvetica', 'italic');
                        doc.setTextColor(100, 116, 139);
                        doc.text('No holdings data available', margin + 2, yPos);
                        doc.setTextColor(0, 0, 0);
                        doc.setFont('helvetica', 'normal');
                        yPos += 7;
                    }

                    yPos += 5;

                    // Sector Allocation
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(30, 64, 175);
                    doc.text('Sector Allocation', margin, yPos);
                    yPos += 8;

                    // Sector allocation from real data
                    const sectors = Object.entries(data.sectors).map(([sector, pct]) => [sector, pct]);

                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    sectors.forEach(([sector, pct]) => {
                        doc.setFont('helvetica', 'normal');
                        doc.text(sector, margin, yPos);
                        doc.setFont('helvetica', 'bold');
                        doc.text(pct + '%', margin + 50, yPos);

                        // Progress bar
                        doc.setFillColor(200, 200, 200);
                        doc.rect(margin + 65, yPos - 3, 100, 5, 'F');
                        doc.setFillColor(59, 130, 246);
                        doc.rect(margin + 65, yPos - 3, pct, 5, 'F');

                        yPos += 8;
                    });

                    // Footer
                    doc.setFontSize(8);
                    doc.setTextColor(100, 116, 139);
                    doc.setFont('helvetica', 'italic');
                    doc.text('This report is for informational purposes only.', pageWidth / 2, pageHeight - 10, { align: 'center' });
                    doc.text('Â© 2026 VNStock Analytics', pageWidth / 2, pageHeight - 6, { align: 'center' });

                    // Save PDF
                    doc.save(`${filename}.pdf`);
                    showAlert('âœ… PDF report downloaded successfully!');

                } catch (err) {
                    console.error('PDF generation error:', err);
                    showAlert('âŒ Error generating PDF. Please try HTML format instead.');
                }
            } else if (format === 'excel') {
                // Download as Excel with portfolio data
                showAlert('ğŸ“Š Generating Excel... Please wait.');

                try {
                    // Create workbook
                    const wb = XLSX.utils.book_new();

                    // Sheet 1: Summary
                    const data = portfolioAnalysisResults;
                    const summaryData = [
                        ['Portfolio Report'],
                        ['Generated:', new Date().toLocaleDateString()],
                        ['Report Type:', reportType],
                        ['Strategy:', data.strategyName || 'Manual Selection'],
                        [],
                        ['Metric', 'Value'],
                        ['Total Portfolio Value', formatCurrency(data.portfolioValue)],
                        ['Total Return', `${data.totalReturn > 0 ? '+' : ''}${data.totalReturn.toFixed(1)}%`],
                        ['Risk Level', `${data.riskLevel.toFixed(1)}%`],
                        ['Sharpe Ratio', data.sharpeRatio.toFixed(2)],
                        ['Max Drawdown', `${data.maxDrawdown.toFixed(1)}%`],
                        ['Diversification Score', `${data.diversification.toFixed(0)}%`]
                    ];
                    const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
                    XLSX.utils.book_append_sheet(wb, ws1, 'Summary');

                    // Sheet 2: Holdings (use real data)
                    const holdingsData = [
                        ['Symbol', 'Shares', 'Price (VND)', 'Value (VND)', 'Allocation (%)']
                    ];

                    if (data.holdings && data.holdings.length > 0) {
                        data.holdings.forEach(h => {
                            holdingsData.push([
                                h.symbol || '',
                                h.shares || 0,
                                h.currentPrice || h.price || 0,
                                h.amount || h.value || 0,
                                h.percentage || h.weight || 0
                            ]);
                        });
                    }

                    const ws2 = XLSX.utils.aoa_to_sheet(holdingsData);
                    XLSX.utils.book_append_sheet(wb, ws2, 'Holdings');

                    // Sheet 3: Sector Allocation (use real data if available)
                    const sectorData = [['Sector', 'Allocation (%)']];
                    if (data.sectors && Object.keys(data.sectors).length > 0) {
                        Object.entries(data.sectors).forEach(([sector, pct]) => {
                            sectorData.push([sector, pct]);
                        });
                    } else {
                        sectorData.push(['No sector data available', '']);
                    }
                    const ws3 = XLSX.utils.aoa_to_sheet(sectorData);
                    XLSX.utils.book_append_sheet(wb, ws3, 'Sector Allocation');

                    // Sheet 4: Performance Analysis (use real data)
                    const perf = data.performance || {};
                    const performanceData = [
                        ['Performance Analysis'],
                        [],
                        ['Best Performer', perf.bestPerformer?.symbol || 'N/A', ''],
                        ['Worst Performer', perf.worstPerformer?.symbol || 'N/A', ''],
                        ['Most Volatile', perf.mostVolatile?.symbol || 'N/A', ''],
                        ['Most Stable', perf.mostStable?.symbol || 'N/A', ''],
                        [],
                        ['Recommendations'],
                        ['Strength', 'Well-diversified across sectors'],
                        ['Strength', 'Good balance of growth and stability stocks'],
                        ['Strength', data.sharpeRatio > 0.8 ? 'Strong risk-adjusted returns (Sharpe > 0.8)' : 'Moderate risk-adjusted returns'],
                        [],
                        ['Improvement', 'Reduce concentration in Banking sector (35%)'],
                        ['Improvement', 'Add more defensive stocks to reduce volatility'],
                        ['Improvement', 'Increase exposure to Technology sector'],
                        [],
                        ['Action', 'Rebalance: Reduce VCB by 2%, increase FPT by 2%'],
                        ['Action', 'Add: Consider VNM or MSN for stability'],
                        ['Action', 'Monitor: Watch HPG performance closely']
                    ];
                    const ws4 = XLSX.utils.aoa_to_sheet(performanceData);
                    XLSX.utils.book_append_sheet(wb, ws4, 'Performance');

                    // Write file
                    XLSX.writeFile(wb, `${filename}.xlsx`);

                    showAlert('âœ… Excel report downloaded successfully!');
                } catch (err) {
                    console.error('Excel generation error:', err);
                    showAlert('âŒ Error generating Excel file. Please try HTML format.');
                }
            }
        }
    </script>

    <footer class="footer">
        <div class="footer-container">
            <div class="footer-grid">
                <div class="footer-section">
                    <h3 data-i18n="menu.dashboards">Dashboards</h3>
                    <ul class="footer-links">
                        <li><a href="index.html" data-i18n="nav.home">Home</a></li>
                        <li><a href="dashboard.html" data-i18n="nav.dashboard">Main Dashboard</a></li>
                        <li><a href="dashboard_history.html" data-i18n="nav.history">Historical Analysis</a></li>
                        <li><a href="advanced_charts.html">Advanced Charts</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h3 data-i18n="menu.tools">Tools</h3>
                    <ul class="footer-links">
                        <li><a href="price_forecast.html" data-i18n="nav.forecast">Price Forecasting</a></li>
                        <li><a href="dashboard_advanced.html" data-i18n="portfolio.title">Portfolio Analytics</a></li>
                        <li><a href="macro_analysis.html" data-i18n="home.macro_analysis">Macro Analysis</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h3 data-i18n="menu.automation">Automation</h3>
                    <ul class="footer-links">
                        <li><a href="alerts_system.html" data-i18n="home.price_alerts">Price Alerts</a></li>
                        <li><a href="trading_automation.html" data-i18n="nav.automation">Trading Automation</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h3 data-i18n="menu.platform">Platform</h3>
                    <ul class="footer-links">
                        <li><a href="../docs/api/API_SERVER_SETUP.html">API Documentation</a></li>
                        <li><a href="../docs/api/README_API.html">Quick Start</a></li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <p>Â© 2024 VNStock Analytics</p>
                <p style="margin-top: 8px;" data-i18n="footer.disclaimer">For educational purposes only. Not financial advice. Trade at your own risk.</p>
            </div>
        </div>
    </footer>

    <!-- Download Format Dialog -->
    <div class="download-dialog-overlay" id="downloadDialog">
        <div class="download-dialog">
            <h3>ğŸ’¾ Choose Download Format</h3>
            <p>Select the format for your portfolio report</p>

            <div class="download-format-options">
                <div class="download-format-option selected" onclick="selectDownloadFormat('pdf')" data-format="pdf">
                    <div class="download-format-icon">ğŸ“„</div>
                    <div class="download-format-info">
                        <div class="download-format-name">PDF Document</div>
                        <div class="download-format-desc">Professional report, ready to print or share</div>
                    </div>
                </div>

                <div class="download-format-option" onclick="selectDownloadFormat('excel')" data-format="excel">
                    <div class="download-format-icon">ğŸ“Š</div>
                    <div class="download-format-info">
                        <div class="download-format-name">Excel Spreadsheet</div>
                        <div class="download-format-desc">Editable data with multiple sheets</div>
                    </div>
                </div>

                <div class="download-format-option" onclick="selectDownloadFormat('html')" data-format="html">
                    <div class="download-format-icon">ğŸŒ</div>
                    <div class="download-format-info">
                        <div class="download-format-name">HTML Page</div>
                        <div class="download-format-desc">View in web browser with interactive elements</div>
                    </div>
                </div>
            </div>

            <div class="download-dialog-actions">
                <button class="download-dialog-btn download-dialog-btn-cancel" onclick="closeDownloadDialog()">
                    <span data-i18n="button.cancel">Cancel</span>
                </button>
                <button class="download-dialog-btn download-dialog-btn-download" onclick="confirmDownload()">
                    Download
                </button>
            </div>
        </div>
    </div>

    <!-- Save Plan Modal -->
    <div id="savePlanModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; ">
            <h3 style="margin: 0 0 20px 0; color: #1e40af; font-size: 1.5em;">ğŸ’¾ <span data-i18n="portfolio.save_investment_plan">Save Investment Plan</span></h3>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1f2937;">
                    <span data-i18n="portfolio.plan_name">Plan Name</span>
                </label>
                <input type="text" id="planNameInput" placeholder="e.g., Growth Portfolio Q1 2024" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1em;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1f2937;">
                    <span data-i18n="portfolio.plan_notes">Notes (Optional)</span>
                </label>
                <textarea id="planNotesInput" placeholder="Add notes about your investment strategy..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1em; min-height: 80px; resize: vertical;"></textarea>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeSavePlanModal()" style="padding: 12px 24px; background: #e5e7eb; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    <span data-i18n="button.cancel">Cancel</span>
                </button>
                <button onclick="saveInvestmentPlan()" style="padding: 12px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; ">
                    ğŸ’¾ <span data-i18n="portfolio.save">Save</span>
                </button>
            </div>
        </div>
    </div>

</body>
</html>
